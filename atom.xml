<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Simple</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2020-06-08T14:59:54.569Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>Simple</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>django-csrf 跨站请求伪造</title>
    <link href="http://yoursite.com/2020/07/09/django-csrf%20%E8%B7%A8%E7%AB%99%E8%AF%B7%E6%B1%82%E4%BC%AA%E9%80%A0/"/>
    <id>http://yoursite.com/2020/07/09/django-csrf%20%E8%B7%A8%E7%AB%99%E8%AF%B7%E6%B1%82%E4%BC%AA%E9%80%A0/</id>
    <published>2020-07-09T14:00:21.116Z</published>
    <updated>2020-06-08T14:59:54.569Z</updated>
    
    <content type="html"><![CDATA[<h2 id="csrf-跨站请求伪造"><a href="#csrf-跨站请求伪造" class="headerlink" title="csrf 跨站请求伪造"></a>csrf 跨站请求伪造</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>CSRF（Cross-site request forgery）跨站请求伪造，也被称为“One Click Attack”或者Session Riding，通常缩写为CSRF或者XSRF，是一种对网站的恶意利用。尽管听起来像跨站脚本（XSS），但它与XSS非常不同，XSS利用站点内的信任用户，而CSRF则通过伪装来自受信任用户的请求来利用受信任的网站。与XSS攻击相比，CSRF攻击往往不大流行（因此对其进行防范的资源也相当稀少）和难以防范，所以被认为比XSS更具危险性</p><p>可以这样来理解：<br>    <strong><em>攻击者盗用了你的身份，以你的名义发送恶意请求，对服务器来说这个请求是完全合法的</em></strong>，但是却完成了攻击者所期望的一个操作，比如以你的名义发送邮件、发消息，盗取你的账号，添加系统管理员，甚至于购买商品、虚拟货币转账等。 如下：其中Web A为存在CSRF漏洞的网站，Web B为攻击者构建的恶意网站，User C为Web A网站的合法用户</p><h3 id="csrf-攻击原理"><a href="#csrf-攻击原理" class="headerlink" title="csrf 攻击原理"></a>csrf 攻击原理</h3><h3 id="crsf应用"><a href="#crsf应用" class="headerlink" title="crsf应用"></a>crsf应用</h3><p><strong>form表单里应用</strong></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;form action=<span class="string">""</span> method=<span class="string">"post"</span>&gt;</span><br><span class="line">    &#123;% csrf_token %&#125;</span><br><span class="line">    &lt;p&gt;username:&lt;input type="text" name="username"&gt;&lt;/p&gt;</span><br><span class="line">    &lt;p&gt;target_user:&lt;input type="text" name="target_user"&gt;&lt;/p&gt;</span><br><span class="line">    &lt;p&gt;money:&lt;input type="text" name="money"&gt;&lt;/p&gt;</span><br><span class="line">    &lt;input type=<span class="string">"submit"</span>&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure><p><strong>在ajax应用</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ajax如何符合校验</span></span><br><span class="line">// 第一种 利用标签查找获取页面上的随机字符串</span><br><span class="line">&#123;<span class="comment">#data:&#123;"username":'jason','csrfmiddlewaretoken':$('[name=csrfmiddlewaretoken]').val()&#125;,#&#125;</span></span><br><span class="line">// 第二种 利用模版语法提供的快捷书写</span><br><span class="line">&#123;<span class="comment">#data:&#123;"username":'jason','csrfmiddlewaretoken':'&#123;&#123; csrf_token &#125;&#125;'&#125;,#&#125;</span></span><br><span class="line">// 第三种 通用方式直接拷贝js代码并应用到自己的html页面上即可</span><br><span class="line">data:&#123;<span class="string">"username"</span>:<span class="string">'jason'</span>&#125;</span><br></pre></td></tr></table></figure><p>第三种方式的js代码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">function getCookie(name) &#123;</span><br><span class="line">    var cookieValue = null;</span><br><span class="line">    <span class="keyword">if</span> (document.cookie &amp;&amp; document.cookie !== <span class="string">''</span>) &#123;</span><br><span class="line">        var cookies = document.cookie.split(<span class="string">';'</span>);</span><br><span class="line">        <span class="keyword">for</span> (var i = <span class="number">0</span>; i &lt; cookies.length; i++) &#123;</span><br><span class="line">            var cookie = jQuery.trim(cookies[i]);</span><br><span class="line">            // Does this cookie string begin with the name we want?</span><br><span class="line">            <span class="keyword">if</span> (cookie.substring(<span class="number">0</span>, name.length + <span class="number">1</span>) === (name + <span class="string">'='</span>)) &#123;</span><br><span class="line">                cookieValue = decodeURIComponent(cookie.substring(name.length + <span class="number">1</span>));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cookieValue;</span><br><span class="line">&#125;</span><br><span class="line">var csrftoken = getCookie(<span class="string">'csrftoken'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">function csrfSafeMethod(method) &#123;</span><br><span class="line">  // these HTTP methods do <span class="keyword">not</span> require CSRF protection</span><br><span class="line">  <span class="keyword">return</span> (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$.ajaxSetup(&#123;</span><br><span class="line">  beforeSend: function (xhr, settings) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!csrfSafeMethod(settings.type) &amp;&amp; !this.crossDomain) &#123;</span><br><span class="line">      xhr.setRequestHeader(<span class="string">"X-CSRFToken"</span>, csrftoken);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="csrf-相关装饰器"><a href="#csrf-相关装饰器" class="headerlink" title="csrf 相关装饰器"></a>csrf 相关装饰器</h3><p>全站禁用：注释掉中间件 ‘django.middleware.csrf.CsrfViewMiddleware’,</p><p><strong>FBV使用</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.views.decorators.csrf <span class="keyword">import</span> csrf_exempt,csrf_protect</span><br><span class="line"><span class="comment"># 不注释csrf，让整体通过csrf，（忽视校验）</span></span><br><span class="line"><span class="comment"># @csrf_exempt</span></span><br><span class="line"><span class="comment"># 注释掉csrf，整体不校验，这个函数需要校验（需要校验）</span></span><br><span class="line"><span class="comment"># @csrf_protect</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</span><br><span class="line">        username = request.POST.get(<span class="string">'username'</span>)</span><br><span class="line">        target_user = request.POST.get(<span class="string">'target_user'</span>)</span><br><span class="line">        money = request.POST.get(<span class="string">'money'</span>)</span><br><span class="line">        print(<span class="string">f'<span class="subst">&#123;username&#125;</span> 向<span class="subst">&#123;target_user&#125;</span> 转了<span class="subst">&#123;money&#125;</span>元'</span>)</span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">'index.html'</span>)</span><br></pre></td></tr></table></figure><p><strong>CBV使用</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.views.decorators.csrf <span class="keyword">import</span> csrf_protect,csrf_exempt</span><br><span class="line"><span class="keyword">from</span> django.utils.decorators <span class="keyword">import</span> method_decorator</span><br><span class="line"><span class="comment"># 注释掉csrf</span></span><br><span class="line"><span class="comment"># @method_decorator(csrf_protect,name='post') # 针对csrf_protect第二种 可以需要校验</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyCsrf</span><span class="params">(View)</span>:</span></span><br><span class="line"><span class="meta">    @method_decorator(csrf_protect)# 针对csrf_protect第三种 可以需要校验</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dispatch</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> super(MyCsrf,self).dispatch(request,*args,**kwargs)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self,request)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">'get'</span>)</span><br><span class="line">    <span class="comment"># @method_decorator(csrf_protect) # 针对csrf_protect第一种 可以需要校验</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self,request)</span>:</span></span><br><span class="line">        <span class="keyword">return</span>  HttpResponse(<span class="string">'post'</span>)</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 不注释csrf</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#@method_decorator(csrf_exempt,name='post')# 第二种针对csrf_exempt,想忽略全局校验 还是需要校验</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyCsrf</span><span class="params">(View)</span>:</span></span><br><span class="line">   </span><br><span class="line">   <span class="comment"># @method_decorator(csrf_exempt) # 第三种针对csrf_exempt,想忽略全局校验 可以不需要</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dispatch</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> super(MyCsrf,self).dispatch(request,*args,**kwargs)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self,request)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">'get'</span>)</span><br><span class="line">  </span><br><span class="line">    <span class="comment"># @method_decorator(csrf_exempt) # 第一种针对csrf_exempt,想忽略全局校验 还是需要校验</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self,request)</span>:</span></span><br><span class="line">        <span class="keyword">return</span>  HttpResponse(<span class="string">'post'</span>)</span><br></pre></td></tr></table></figure><p>针对不注释掉csrf的，第三种可以忽略校验，但是一和二不行，还是需要校验</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;csrf-跨站请求伪造&quot;&gt;&lt;a href=&quot;#csrf-跨站请求伪造&quot; class=&quot;headerlink&quot; title=&quot;csrf 跨站请求伪造&quot;&gt;&lt;/a&gt;csrf 跨站请求伪造&lt;/h2&gt;&lt;h3 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;head
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>前端之CSS</title>
    <link href="http://yoursite.com/2020/07/09/%E5%89%8D%E7%AB%AF%E4%B9%8BCSS/"/>
    <id>http://yoursite.com/2020/07/09/%E5%89%8D%E7%AB%AF%E4%B9%8BCSS/</id>
    <published>2020-07-09T14:00:04.208Z</published>
    <updated>2020-07-09T14:17:41.653Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前端之CSS"><a href="#前端之CSS" class="headerlink" title="前端之CSS"></a>前端之CSS</h1><p>CSS是层叠样式表，就是给html标签添加样式，让其更美观</p><p><strong>CSS的注释</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*单行注释*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">多行注释1</span></span><br><span class="line"><span class="comment">多行注释2</span></span><br><span class="line"><span class="comment">多行注释3</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"># 通常我们在写<span class="selector-tag">css</span>样式的时候也会用注释来划定样式区域(因为<span class="selector-tag">HTML</span>代码多所以对呀的<span class="selector-tag">css</span>代码也会很多)</span><br></pre></td></tr></table></figure><p><strong>CSS语法结构</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">选择器 &#123;</span><br><span class="line">  属性1:值1;</span><br><span class="line">  属性2:值2;</span><br><span class="line">  属性3:值3;</span><br><span class="line">  属性4:值4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>CSS的三种引入方式</strong></p><ul><li><p>style标签直接书写css代码</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="selector-tag">style</span>&gt;</span><br><span class="line">    <span class="selector-tag">h1</span>&#123;</span><br><span class="line">        <span class="attribute">color</span>: burlywood;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure></li><li><p>link标签引入外部css文件，正规</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;link rel="stylesheet" href="mycss.css"&gt;</span><br></pre></td></tr></table></figure></li><li><p>行内式，直接html标签内书写样式，一般不推荐</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;h1 style="color: green"&gt;老板好 要上课吗?&lt;/h1&gt;</span><br></pre></td></tr></table></figure></li></ul><hr><h2 id="CSS选择器"><a href="#CSS选择器" class="headerlink" title="CSS选择器"></a>CSS选择器</h2><p>所谓选择器，就是确定标签位置的方法</p><h3 id="基本选择器"><a href="#基本选择器" class="headerlink" title="基本选择器"></a>基本选择器</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"d1"</span> <span class="attr">class</span>=<span class="string">"c1 c2"</span>&gt;</span>div</span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>div里面的p<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span>&gt;</span>div里面的span<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">"d2"</span> <span class="attr">class</span>=<span class="string">"c1 c2"</span>&gt;</span>ppp<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">"d3"</span> <span class="attr">class</span>=<span class="string">"c2"</span>&gt;</span>span111<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">"d4"</span> <span class="attr">class</span>=<span class="string">"c3"</span>&gt;</span>span222<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li><p><strong>id选择器</strong>，根据id值确定一个标签</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-id">#id_name</span>&#123; <span class="comment">/*找到id是d1的标签 将文本颜色变成红色*/</span></span><br><span class="line">    <span class="attribute">color</span>:red;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><strong>class选择器</strong>，根据class值确定一类标签</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.class_name</span>&#123; <span class="comment">/* 找到class值里面包含c1的标签*/</span></span><br><span class="line">    <span class="attribute">color</span>:red;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><strong>元素/标签选择器</strong>，根据标签名确定一堆span标签</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">span</span>&#123;<span class="comment">/*找到所有的span标签*/</span></span><br><span class="line">    <span class="attribute">color</span>:red;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><strong>通用选择器</strong>，选择所有标签</p>  <figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">*&#123;<span class="comment">/*将html页面上所有的标签全部找到*/</span></span><br><span class="line">    <span class="attribute">color</span>:red;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="组合选择器"><a href="#组合选择器" class="headerlink" title="组合选择器"></a>组合选择器</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>span1<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>span2<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span>div</span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>div p<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>div p</span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span>&gt;</span>div p span<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span>&gt;</span>span<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span>&gt;</span>span<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>span<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>span<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>ppp<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>span<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">"""</span><br><span class="line">在前端 我们将标签的嵌套用亲戚关系来表述层级</span><br><span class="line">&lt;<span class="selector-tag">div</span>&gt;<span class="selector-tag">div</span></span><br><span class="line">        &lt;p&gt;div p&lt;/p&gt;</span><br><span class="line">        &lt;<span class="selector-tag">p</span>&gt;<span class="selector-tag">div</span> <span class="selector-tag">p</span></span><br><span class="line">            &lt;span&gt;div p span&lt;/span&gt;</span><br><span class="line">        &lt;/p&gt;</span><br><span class="line">        &lt;span&gt;span&lt;/span&gt;</span><br><span class="line">        &lt;span&gt;span&lt;/span&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">  <span class="selector-tag">div</span>里面的<span class="selector-tag">p</span> <span class="selector-tag">span</span>都是<span class="selector-tag">div</span>的后代</span><br><span class="line">  <span class="selector-tag">p</span>是<span class="selector-tag">div</span>的儿子</span><br><span class="line">  <span class="selector-tag">p</span>里面的<span class="selector-tag">span</span>是<span class="selector-tag">p</span>的儿子 是<span class="selector-tag">div</span>的孙子</span><br><span class="line">  <span class="selector-tag">div</span>是<span class="selector-tag">p</span>的父亲</span><br><span class="line">  ...</span><br><span class="line">"""</span><br></pre></td></tr></table></figure><ul><li><p><strong>后代选择器，空格隔开</strong>，选择div 里面的所有span</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">div</span> <span class="selector-tag">span</span>&#123;</span><br><span class="line">    <span class="attribute">color</span>:red;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><strong>儿子选择器，&gt;连接</strong>，选择内部第一层的所有span</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">div</span>&gt;<span class="selector-tag">span</span>&#123;</span><br><span class="line">    <span class="attribute">color</span>:red;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><strong>毗邻选择器，+连接</strong>，选择div同级别的紧挨着的下面一个span，隔着一个都不行</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">div</span>+<span class="selector-tag">span</span>&#123; <span class="comment">/*同级别紧挨着的下面的第一个*/</span></span><br><span class="line">    <span class="attribute">color</span>:red;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><strong>弟弟选择器，~连接</strong>，选择同级别下面所有的span</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">div</span>~<span class="selector-tag">span</span>&#123;<span class="comment">/*同级别下面所有的span*/</span></span><br><span class="line">    <span class="attribute">color</span>:red;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="属性选择器"><a href="#属性选择器" class="headerlink" title="属性选择器"></a>属性选择器</h3><p>属性选择器，以<code>[]</code>作为标志。    </p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="selector-tag">body</span>&gt;</span><br><span class="line">    &lt;input type="text" username&gt;</span><br><span class="line">    &lt;input type="text" username="jason"&gt;</span><br><span class="line">    &lt;input type="text" username="kevin"&gt;</span><br><span class="line">    &lt;p username="tank"&gt;水箱老师&lt;/p&gt;</span><br><span class="line">    &lt;div username="egon"&gt;矮子老师&lt;/div&gt;</span><br><span class="line">    &lt;span username="jason"&gt;jason老师 &lt;/span&gt;</span><br><span class="line">&lt;/body&gt;</span><br></pre></td></tr></table></figure><ul><li><p>含有某个属性的标签</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[username]</span>&#123; <span class="comment">/*将所有含有属性名是username的标签背景色改为红色*/</span></span><br><span class="line">    <span class="attribute">color</span>:red;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>含有某个属性且有某个值的标签，选择属性名为</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[username=<span class="string">'jason'</span>]</span>&#123; <span class="comment">/*找到所有属性名是username并且属性值是jason的标签*/</span></span><br><span class="line">    <span class="attribute">color</span>:red;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>含有某个属性且有某个值的某个标签</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">input</span><span class="selector-attr">[username=<span class="string">'jason'</span>]</span>&#123;<span class="comment">/*找到所有属性名是username并且属性值是jason的input标签*/</span></span><br><span class="line">    <span class="attribute">color</span>:red;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前端之CSS&quot;&gt;&lt;a href=&quot;#前端之CSS&quot; class=&quot;headerlink&quot; title=&quot;前端之CSS&quot;&gt;&lt;/a&gt;前端之CSS&lt;/h1&gt;&lt;p&gt;CSS是层叠样式表，就是给html标签添加样式，让其更美观&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;CSS的注释&lt;/s
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>django-cookie 和session</title>
    <link href="http://yoursite.com/2020/07/09/django-cookie%20%E5%92%8Csession/"/>
    <id>http://yoursite.com/2020/07/09/django-cookie%20%E5%92%8Csession/</id>
    <published>2020-07-09T13:57:51.174Z</published>
    <updated>2020-06-07T06:56:17.543Z</updated>
    
    <content type="html"><![CDATA[<h2 id="cookie-和session"><a href="#cookie-和session" class="headerlink" title="cookie 和session"></a>cookie 和session</h2><p>HTTP协议是无状态的，这意味这所有的客户端或者浏览器朝服务端发请求，服务端是不会记住客户端是谁，没办法保存用户的登录信息。</p><p>随之WEB的发展，出现了网上商城之类购物网站，这类网站的一个需求是记住当前用户是谁，并且需要记住用户的登录状态（避免每次请求页面都重新登录）。</p><p>为了解决这个需求，出现了很多总解决办法。其中最有效的一个办法是：当用户第一次登录成功后，将用户的登录信息（用户名和密码）返回给用户的浏览器，让浏览器将<strong>登录信息保存在本地浏览器(cookie)</strong>；之后用户再次访问该网站时，浏览器会携带之前保存的该网站的登录信息，这样服务端获取登录信息之后自动登录验证。</p><p>但是这种方式存在很大的安全隐患：容易泄露用户的登录信息；后来又出现了优化的解决办法。</p><p>新的解决办法是：当用户初次登录成功后，服务端会产生一个随机字符串，该<strong>字符串保存在服务端(session)</strong>，保存成键值对的形式。同时将该字符串交由客户端浏览器保存。之后再访问服务端的时候，浏览器都会带着这个随机字符串，服务端去数据库中匹配是否又这个随机字符串对应的用户信息；匹配成功则自动登录。</p><p>其实，如果截获到该随机字符串，那么就可以冒充当前用户，其实还是有安全隐患的。所以应了那句话：<strong>在web领域没有绝对的安全也没有绝对的不安全</strong>。</p><p>这就是cookie和session的出现历程。</p><ul><li><code>cookie</code>：服务端保存在客户端浏览器上的信息，它的表现形式一般都是k:v键值对(可以有多个)。<strong>cookie就是保存在客户端浏览器上的信息</strong></li><li><code>session</code>：数据是保存在服务端的并且它的表现形式一般也是k:v键值对(可以有多个)。<strong>session就是保存在服务端上的信息</strong></li><li>session是基于cookie工作的(其实大部分的保存用户状态的操作都需要使用到cookie)。</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">token</span><br><span class="line">session虽然数据是保存在服务端的 但是禁不住数据量大</span><br><span class="line">    服务端不再保存数据</span><br><span class="line">    登陆成功之后 将一段用户信息进行加密处理(加密算法之后你公司开发知道)</span><br><span class="line">    将加密之后的结果拼接在信息后面 整体返回给浏览器保存 </span><br><span class="line">    浏览器下次访问的时候带着该信息 服务端自动切去前面一段信息再次使用自己的加密算法</span><br><span class="line">    跟浏览器尾部的密文进行比对</span><br></pre></td></tr></table></figure><h2 id="cookie"><a href="#cookie" class="headerlink" title="cookie"></a>cookie</h2><h3 id="cookie基本操作"><a href="#cookie基本操作" class="headerlink" title="cookie基本操作"></a>cookie基本操作</h3><p>虽然cookie是服务端告诉客户端浏览器需要保存内容，但是客户端浏览器可以选择拒绝保存；如果将浏览器设置为禁止保存服务端的cookie，那么只要是需要记录用户状态的网站登陆功能都无法使用了。</p><p>视图函数的返回有三种形式，HttpResponse  ，render , redirect 三种形式 其实本质上内部返回的都是HttpResponse  对象，我们可以直接返回也是先将对象用一个变量保存下来在返回</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">方式一</span><br><span class="line"><span class="keyword">return</span> HttpResponse()</span><br><span class="line"><span class="keyword">return</span> render()</span><br><span class="line"><span class="keyword">return</span> direct()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">方式<span class="number">2</span></span><br><span class="line">obj1 = HttpResponse()</span><br><span class="line"><span class="keyword">return</span> obj1</span><br><span class="line"> </span><br><span class="line">obj2 = render()</span><br><span class="line"><span class="keyword">return</span> obj2</span><br><span class="line"> </span><br><span class="line">obj3 = redirect()</span><br><span class="line"><span class="keyword">return</span> obj3</span><br></pre></td></tr></table></figure><p>我们感觉用这样的方式就是多此一举，但是这种方式可以使用在cookie上面，利用返回对象的方式来设置cookie</p><p><strong>设置cookie</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">obj.set_cookie(key,value)</span><br></pre></td></tr></table></figure><p><strong>获取cookie</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">request.COOKIES[key]</span><br><span class="line">request.COOKIES.get(key)</span><br></pre></td></tr></table></figure><p><strong>设置cookie超时时间</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">obj.set_cookie(key,value,max_age=<span class="number">3</span>)</span><br><span class="line">obj.set_cookie(key,value,expires=<span class="number">3</span>)</span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">这两个都是设置超时时间的，都是秒为单位，expires是针对IE浏览器的</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure><p><strong>删除cookie</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">obj.delete_cookie(key) <span class="comment"># 删除用户浏览器上之前设置的usercookie值</span></span><br></pre></td></tr></table></figure><h3 id="cookie版本的登录"><a href="#cookie版本的登录" class="headerlink" title="cookie版本的登录"></a>cookie版本的登录</h3><p>思路：# 我们完成一个真正的登陆功能，校验用户是否登陆的装饰器，用户如果在没有登陆的情下想访问一个需要登陆的页面，那么先跳转到登陆页面 当用户输入正确的用户名和密码之后</p><p><strong>登录认证装饰器</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">def login_auth(func):</span><br><span class="line">    def inner(request,*args,**kwargs):</span><br><span class="line">        # print(request.path_info)</span><br><span class="line">        # print(request.get_full_path())  # 能够获取到用户上一次想要访问的url</span><br><span class="line">        target_url &#x3D; request.get_full_path()</span><br><span class="line">        if request.COOKIES.get(&#39;username&#39;):</span><br><span class="line">            return func(request,*args,**kwargs)</span><br><span class="line">        else:</span><br><span class="line">            return redirect(&#39;&#x2F;login&#x2F;?next&#x3D;%s&#39;%target_url)</span><br><span class="line">    return inner</span><br></pre></td></tr></table></figure><p><strong>view视图</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</span><br><span class="line">        username = request.POST.get(<span class="string">'username'</span>)</span><br><span class="line">        password = request.POST.get(<span class="string">'password'</span>)</span><br><span class="line">        <span class="keyword">if</span> username == <span class="string">'jason'</span> <span class="keyword">and</span> password == <span class="string">'123'</span>:</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 获取用户上一次想要访问的url</span></span><br><span class="line">            target_url = request.GET.get(<span class="string">'next'</span>)  <span class="comment"># 这个结果可能是None</span></span><br><span class="line">            <span class="keyword">if</span> target_url:</span><br><span class="line">                obj = redirect(target_url)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># 保存用户登陆状态</span></span><br><span class="line">                obj = redirect(<span class="string">'/home/'</span>)</span><br><span class="line">            <span class="comment"># 让浏览器记录cookie数据</span></span><br><span class="line">            obj.set_cookie(<span class="string">'username'</span>, <span class="string">'jason666'</span>)</span><br><span class="line">            <span class="string">"""</span></span><br><span class="line"><span class="string">            浏览器不单单会帮你存</span></span><br><span class="line"><span class="string">            而且后面每次访问你的时候还会带着它过来</span></span><br><span class="line"><span class="string">            """</span></span><br><span class="line">            <span class="comment"># 跳转到一个需要用户登陆之后才能看的页面</span></span><br><span class="line">            <span class="keyword">return</span> obj</span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">'login.html'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@login_auth</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">home</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="comment"># 获取cookie信息 判断你有没有</span></span><br><span class="line">    <span class="comment"># if request.COOKIES.get('username') == 'jason666':</span></span><br><span class="line">    <span class="comment">#     return HttpResponse("我是home页面，只有登陆的用户才能进来哟~")</span></span><br><span class="line">    <span class="comment"># # 没有登陆应该跳转到登陆页面</span></span><br><span class="line">    <span class="comment"># return redirect('/login/')</span></span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">"我是home页面，只有登陆的用户才能进来哟~"</span>)</span><br></pre></td></tr></table></figure><h3 id="cookie-其他操作"><a href="#cookie-其他操作" class="headerlink" title="cookie 其他操作"></a>cookie 其他操作</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 获取cookie</span></span><br><span class="line">request.get_signed_cookie(key, default=RAISE_ERROR, salt=<span class="string">''</span>, max_age=<span class="literal">None</span>)</span><br><span class="line">参数：</span><br><span class="line">    default: 默认值</span><br><span class="line">    salt: 加密盐</span><br><span class="line">    max_age: 后台控制过期时间</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line"><span class="comment"># 设置cookie</span></span><br><span class="line">rep.set_signed_cookie(key, value, salt=<span class="string">'加密盐'</span>, max_age=<span class="literal">None</span>, ...)</span><br><span class="line">参数：</span><br><span class="line">    key, 键</span><br><span class="line">    value=<span class="string">''</span>, 值</span><br><span class="line">    max_age=<span class="literal">None</span>, 过期时间</span><br><span class="line">    expires=<span class="literal">None</span>, 过期时间(IE requires expires, so set it <span class="keyword">if</span> hasn<span class="string">'t been already.)</span></span><br><span class="line"><span class="string">    path='</span>/<span class="string">', Cookie生效的路径，/ 表示根路径，特殊的：根路径的cookie可以被任何url的页面访问</span></span><br><span class="line"><span class="string">    domain=None, Cookie生效的域名</span></span><br><span class="line"><span class="string">    secure=False, 是否https传输</span></span><br><span class="line"><span class="string">    httponly=False 只能http协议传输，无法被JavaScript获取（不是绝对，底层抓包可以获取到也可以被覆盖）</span></span><br></pre></td></tr></table></figure><h2 id="session"><a href="#session" class="headerlink" title="session"></a>session</h2><p>Cookie虽然在一定程度上解决了“保持状态”的需求，但是由于Cookie本身最大支持4096字节，以及Cookie本身保存在客户端，可能被拦截或窃取。因此就需要有一种新的东西，它能支持更多的字节，并且他保存在服务器，有较高的安全性。这就是Session。</p><p>问题来了，基于HTTP协议的无状态特征，服务器根本就不知道访问者是“谁”。那么上述的Cookie就起到桥接的作用。</p><p>我们可以给每个客户端的Cookie分配一个唯一的id，这样用户在访问时，通过Cookie，服务器就知道来的人是“谁”。然后我们再根据不同的Cookie的id，在服务器上保存一段时间的私密资料，如“账号密码”等等。</p><p><strong>总结而言：Cookie弥补了HTTP无状态的不足，让服务器知道来的人是“谁”；但是Cookie以文本的形式保存在本地，自身安全性较差；所以我们就通过Cookie识别不同的用户，对应的在Session里保存私密的信息以及超过4096字节的文本。</strong></p><p>另外，上述所说的Cookie和Session其实是共通性的东西，不限于语言和框架。</p><h3 id="session-的基本操作"><a href="#session-的基本操作" class="headerlink" title="session 的基本操作"></a>session 的基本操作</h3><p>django种的session是通过request对象下的session完成的，它类似与一个字典，操作方式和字典也是差不多的</p><ul><li>session数据是保存在服务端的(存？)，给客户端返回的是一个随机字符串<br>sessionid:随机字符串</li><li>在默认情况下操作session的时候需要django默认的一张django_session表</li><li>django默认session的过期时间是14天，可以认为修改它。</li><li>session是保存在服务端的，但是session的保存位置可以有多种选择：数据库、文件等等</li><li>django_session表中的数据条数是取决于浏览器的，同一个计算机上(IP地址)同一个浏览器只会有一条数据生效。主要是为了节省服务端数据库资源。</li></ul><p><strong>设置session</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request.session[<span class="string">'key'</span>]=value</span><br></pre></td></tr></table></figure><p><strong>获取session</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request.session.get(<span class="string">'key'</span>)</span><br></pre></td></tr></table></figure><p><strong>设置过期时间</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">request.session.set_expiry()</span><br><span class="line">括号内可以放四种类型的参数</span><br><span class="line">1.整数多少秒</span><br><span class="line">2.日期对象  到指定日期就失效</span><br><span class="line">3.0 一旦当前浏览器窗口关闭立刻失效</span><br><span class="line">4.不写失效时间就取决于django内部全局session默认的失效时间</span><br></pre></td></tr></table></figure><p>*<em>清除session    *</em></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">request.session.delete()  <span class="comment"># 只删服务端的 客户端的不删</span></span><br><span class="line">request.session.flush()  <span class="comment"># 浏览器和服务端都清空(推荐使用)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> 这用于确保前面的会话数据不可以再次被用户的浏览器访问</span><br></pre></td></tr></table></figure><h3 id="session内部的那些事"><a href="#session内部的那些事" class="headerlink" title="session内部的那些事"></a>session内部的那些事</h3><p><strong>设置session</strong></p><p>request.session[‘is_login’] = ‘yes’</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> django内部会自动帮你生成一个随机字符串</span><br><span class="line"><span class="number">2.</span> django内部自动将随机字符串和对应的数据存储到django_session表中,</span><br><span class="line">   先在内存中产生操作数据的缓存,在响应结果django中间件的时候才真正的操作数据库</span><br><span class="line"><span class="number">3.</span> 将产生的随机字符串返回给客户端浏览器保存</span><br></pre></td></tr></table></figure><p>request.session.get(‘is_login’)</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>自动从浏览器请求中获取sessionid对应的随机字符串</span><br><span class="line"><span class="number">2.</span>拿着该随机字符串去django_session表中查找对应的数据 </span><br><span class="line"><span class="number">3.</span> 如果比对上了 则将对应的数据取出并以字典的形式封装到request.session中</span><br><span class="line">   如果比对不上 则request.session.get()返回的是<span class="literal">None</span></span><br></pre></td></tr></table></figure><h3 id="session实现登录认证"><a href="#session实现登录认证" class="headerlink" title="session实现登录认证"></a>session实现登录认证</h3><p><strong>登录装饰器</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> redirect</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login_auth</span><span class="params">(func)</span>:</span></span><br><span class="line"><span class="meta">    @wraps(func)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">inner</span><span class="params">(request, *args, **kwargs)</span>:</span></span><br><span class="line">        target_url = request.get_full_path()                <span class="comment"># 获取用户想要访问的url</span></span><br><span class="line">        <span class="keyword">if</span> request.session.get(<span class="string">'login_auth_key'</span>)</span><br><span class="line">            res = func(request, *args, **kwargs)</span><br><span class="line">            <span class="keyword">return</span> res</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> redirect(<span class="string">f'/login/?next=<span class="subst">&#123;target_url&#125;</span>'</span>)   <span class="comment"># 设置登录后跳转的页面url</span></span><br><span class="line">    <span class="keyword">return</span> inner</span><br></pre></td></tr></table></figure><p>视图函数：<code>views.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> utils.login_auth <span class="keyword">import</span> login_auth</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</span><br><span class="line">        <span class="keyword">if</span> login_success:<span class="comment"># 伪代码</span></span><br><span class="line">            target_url = request.GET.get(<span class="string">'next'</span>) <span class="keyword">or</span> <span class="string">'index'</span>    <span class="comment"># 登录前要访问的页面或者直接到index</span></span><br><span class="line">            request.session[<span class="string">'login_auth_key'</span>] = <span class="string">'is_login'</span></span><br><span class="line">            <span class="keyword">return</span> redirect(target_url)</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'login.html'</span>, locals())</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="meta">@login_auth</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logout</span><span class="params">(request)</span>:</span></span><br><span class="line">    request.session.flush()</span><br><span class="line">    <span class="keyword">return</span> redirect(<span class="string">'login'</span>)</span><br></pre></td></tr></table></figure><h3 id="django中的session设置"><a href="#django中的session设置" class="headerlink" title="django中的session设置"></a>django中的session设置</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> 数据库Session</span><br><span class="line">SESSION_ENGINE = <span class="string">'django.contrib.sessions.backends.db'</span>     <span class="comment"># 引擎（默认）</span></span><br><span class="line"> </span><br><span class="line"><span class="number">2.</span> 缓存Session</span><br><span class="line">SESSION_ENGINE = <span class="string">'django.contrib.sessions.backends.cache'</span>  <span class="comment"># 引擎</span></span><br><span class="line">SESSION_CACHE_ALIAS = <span class="string">'default'</span>                            <span class="comment"># 使用的缓存别名（默认内存缓存，也可以是memcache），此处别名依赖缓存的设置</span></span><br><span class="line"> </span><br><span class="line"><span class="number">3.</span> 文件Session</span><br><span class="line">SESSION_ENGINE = <span class="string">'django.contrib.sessions.backends.file'</span>             <span class="comment"># 引擎</span></span><br><span class="line">SESSION_FILE_PATH = <span class="literal">None</span>                                             <span class="comment"># 缓存文件路径，如果为None，则使用tempfile模块获取一个临时地址tempfile.gettempdir() </span></span><br><span class="line"> </span><br><span class="line"><span class="number">4.</span> 缓存+数据库</span><br><span class="line">SESSION_ENGINE = <span class="string">'django.contrib.sessions.backends.cached_db'</span>        <span class="comment"># 引擎</span></span><br><span class="line"> </span><br><span class="line"><span class="number">5.</span> 加密Cookie Session</span><br><span class="line">SESSION_ENGINE = <span class="string">'django.contrib.sessions.backends.signed_cookies'</span>   <span class="comment"># 引擎</span></span><br><span class="line"> </span><br><span class="line">其他公用设置项：</span><br><span class="line">SESSION_COOKIE_NAME ＝ <span class="string">"sessionid"</span>                       <span class="comment"># Session的cookie保存在浏览器上时的key，即：sessionid＝随机字符串（默认）</span></span><br><span class="line">SESSION_COOKIE_PATH ＝ <span class="string">"/"</span>                               <span class="comment"># Session的cookie保存的路径（默认）</span></span><br><span class="line">SESSION_COOKIE_DOMAIN = <span class="literal">None</span>                             <span class="comment"># Session的cookie保存的域名（默认）</span></span><br><span class="line">SESSION_COOKIE_SECURE = <span class="literal">False</span>                            <span class="comment"># 是否Https传输cookie（默认）</span></span><br><span class="line">SESSION_COOKIE_HTTPONLY = <span class="literal">True</span>                           <span class="comment"># 是否Session的cookie只支持http传输（默认）</span></span><br><span class="line">SESSION_COOKIE_AGE = <span class="number">1209600</span>                             <span class="comment"># Session的cookie失效日期（2周）（默认）</span></span><br><span class="line">SESSION_EXPIRE_AT_BROWSER_CLOSE = <span class="literal">False</span>                  <span class="comment"># 是否关闭浏览器使得Session过期（默认）</span></span><br><span class="line">SESSION_SAVE_EVERY_REQUEST = <span class="literal">False</span>                       <span class="comment"># 是否每次请求都保存Session，默认修改之后才保存（默认）</span></span><br></pre></td></tr></table></figure><h2 id="CBV如何添加装饰器"><a href="#CBV如何添加装饰器" class="headerlink" title="CBV如何添加装饰器"></a>CBV如何添加装饰器</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.views <span class="keyword">import</span> View</span><br><span class="line"><span class="keyword">from</span> django.utils.decorators <span class="keyword">import</span> method_decorator</span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">CBV中django不建议你直接给类的方法加装饰器</span></span><br><span class="line"><span class="string">无论该装饰器能都正常给你 都不建议直接加</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># @method_decorator(login_auth,name='get')  # 方式2(可以添加多个针对不同的方法加不同的装饰器)</span></span><br><span class="line"><span class="comment"># @method_decorator(login_auth,name='post')</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyLogin</span><span class="params">(View)</span>:</span></span><br><span class="line"><span class="meta">    @method_decorator(login_auth)  # 方式3:它会直接作用于当前类里面的所有的方法</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dispatch</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> super().dispatch(request,*args,**kwargs)</span><br><span class="line">    <span class="comment"># @method_decorator(login_auth)  # 方式1:指名道姓</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self,request)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">"get请求"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self,request)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">'post请求'</span>)</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;cookie-和session&quot;&gt;&lt;a href=&quot;#cookie-和session&quot; class=&quot;headerlink&quot; title=&quot;cookie 和session&quot;&gt;&lt;/a&gt;cookie 和session&lt;/h2&gt;&lt;p&gt;HTTP协议是无状态的，这意味这所有
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>mysql-存储引擎</title>
    <link href="http://yoursite.com/2020/07/09/mysql-%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/"/>
    <id>http://yoursite.com/2020/07/09/mysql-%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/</id>
    <published>2020-07-09T13:56:43.073Z</published>
    <updated>2020-05-04T11:02:26.438Z</updated>
    
    <content type="html"><![CDATA[<h2 id="存储引擎"><a href="#存储引擎" class="headerlink" title="存储引擎"></a>存储引擎</h2><p>针对不同的文件格式会有不同的存储方式和处理机制，针对不同的数据应该有对应不同的处理机制来存储</p><p><strong>mysql主要的存储引擎</strong></p><ul><li><p>innodb</p><p>这个是mysql5.5版本之后默认的存储引擎，存储数据更加的安全</p></li><li><p>myisam</p><p>这个是mysql5.5版本之前默认的存储引擎，速度比innodb更快，但是数据不安全</p></li><li><p>memory</p><p>内存引擎，数据全部放在内存中，断电数据丢失</p></li><li><p>blackhole</p><p>无论存什么，都会立刻消失</p></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看所有引擎</span></span><br><span class="line">show engines;</span><br><span class="line"><span class="comment"># 不同的存储引擎在存储表的时候的异同点</span></span><br><span class="line">create table t1(id int) engine=innodb;</span><br><span class="line">create table t2(id int) engine=myisam;</span><br><span class="line">create table t3(id int) engine=memory;</span><br><span class="line">create table t4(id int) engine=blackhole;</span><br><span class="line"><span class="comment"># 存数据</span></span><br><span class="line">insert into t1 values(<span class="number">1</span>);</span><br><span class="line">insert into t2 values(<span class="number">1</span>);</span><br><span class="line">insert into t3 values(<span class="number">1</span>);</span><br><span class="line">insert into t4 values(<span class="number">1</span>);</span><br><span class="line">查看表发现t1 <span class="keyword">and</span> t2有东西，但是只要mysql重新启动，t3就是空，t4会即刻释放</span><br></pre></td></tr></table></figure><p><strong>创建表的完整语法</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 语法</span></span><br><span class="line">create table 表名(</span><br><span class="line">    字段名<span class="number">1</span> 类型(宽度) 约束条件</span><br><span class="line">    字段名<span class="number">2</span> 类型(宽度) 约束条件</span><br><span class="line">    字段名<span class="number">3</span> 类型(宽度) 约束条件    </span><br><span class="line">    字段名<span class="number">4</span> 类型(宽度) 约束条件</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p><strong>强调</strong></p><ul><li><p>在同一张表中字段名字不能重复</p></li><li><p>宽度和约束条件是可选的，约束条件支持多个</p><figure class="highlight plain"><figcaption><span>类型(宽度)  约束条件1 约束条件2；```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  &#96;&#96;&#96; create table t5(id); &#96;&#96;&#96;报错</span><br><span class="line"></span><br><span class="line">* 最后一行不能有逗号</span><br><span class="line"></span><br><span class="line">  &#96;&#96;&#96; python</span><br><span class="line">  create table t6(</span><br><span class="line">  </span><br><span class="line">      id int,</span><br><span class="line">      name char</span><br><span class="line">  )</span><br></pre></td></tr></table></figure></li></ul><p><strong>补充说明</strong></p><ul><li><p><strong>宽度</strong>：一般情况下指对存储数据的限制</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">create table t7(name char); 默认宽度是<span class="number">1</span></span><br><span class="line">insert into t7 values(<span class="string">'json'</span>);</span><br><span class="line">insert into t7 values(null);null是关键字</span><br></pre></td></tr></table></figure><p>针对不同的版本是出现不同的效果</p><p>5.6版本默认没有开启严格模式，规定只能存放一个字符，多出的字符自动截取</p><p>5.7版本以上是开启了严格模式，规定存放的个数，多出自动报错</p></li></ul><ul><li><strong>严格模式</strong>： mysql5.7之后的版本是默认开启的严格模式，使用数据库的标准就是：能尽量少的让数据库敢活就尽量少，不给数据库增加额外的压力。</li></ul><ul><li><p><strong>约束条件</strong>：null  not null不能插入rull</p><figure class="highlight plain"><figcaption><span>table t8(id int,name char not null)```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">* **宽度和约束条件的关系**：宽度是限制数据的存储，约束条件是在宽度的基础上增加额外的约束</span><br><span class="line"></span><br><span class="line">## 基本数据类型</span><br><span class="line"></span><br><span class="line">### 整型</span><br><span class="line"></span><br><span class="line">* **分类**：</span><br><span class="line"></span><br><span class="line">  TINYINT SMALLINT MEDUIMINT INT BIGINT</span><br><span class="line"></span><br><span class="line">* **作用**：</span><br><span class="line"></span><br><span class="line">  存一些年龄，等级 id，号码等等</span><br><span class="line"></span><br><span class="line">例子：**TINYINT** 是否有符号，默认的是带符号的，超出限制存最大可接受值</span><br><span class="line"></span><br><span class="line">&#96;&#96;&#96; python</span><br><span class="line">create table t9(id tinyint);</span><br><span class="line">insert into t9 values(-129),(256);</span><br><span class="line"></span><br><span class="line"># 约束条件unsigned 无符号</span><br><span class="line">create table t10(id tinyint unsigned);</span><br><span class="line"></span><br><span class="line">create table t11(id int);</span><br><span class="line"># int 默认也是带符号的，整型默认情况下的欧式带有符号的</span><br><span class="line"></span><br><span class="line"># 针对整型 括号内的宽度有限</span><br><span class="line">create table t12(id int(8));</span><br><span class="line">insert into t12 values(123456789)</span><br><span class="line"></span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">特例:只有整型括号里面的数字不是表示限制位数</span><br><span class="line">id int(8)</span><br><span class="line">如果数字没有超出8位 那么默认用空格填充至8位</span><br><span class="line">如果数字超出了8位 那么有几位就存几位(但是还是要遵守最大范围)</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">create table t13(id int(8) unsigned zerofill);</span><br><span class="line"></span><br><span class="line"># 针对整型字段括号内无需指定宽度，默认的宽度足够显示所有数据</span><br></pre></td></tr></table></figure></li></ul><p><strong>严格模式</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如何查看严格模式</span></span><br><span class="line">show variables like <span class="string">"%mode"</span>;</span><br><span class="line"></span><br><span class="line">模糊匹配/查询</span><br><span class="line">关键字 like</span><br><span class="line">%:匹配任意多个字符</span><br><span class="line">        _:匹配任意单个字符</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改严格模式</span></span><br><span class="line">set session  只在当前窗口有效</span><br><span class="line">    set <span class="keyword">global</span>   全局有效</span><br><span class="line">    </span><br><span class="line">    set <span class="keyword">global</span> sql_mode = <span class="string">'STRICT_TRANS_TABLES'</span>;</span><br><span class="line">    </span><br><span class="line">    修改完之后 重新进入服务端即可</span><br></pre></td></tr></table></figure><h3 id="浮点型"><a href="#浮点型" class="headerlink" title="浮点型"></a>浮点型</h3><ul><li>char(4) 数据超过4个字符直接报错，不厚的字符空格补全</li><li>varchar(4) 数据超过4个字符直接报错，不够截取</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">create table t18(name char(<span class="number">4</span>));</span><br><span class="line">create table t19(name varchar(<span class="number">4</span>));</span><br><span class="line">insert into t18 values(<span class="string">'a'</span>);</span><br><span class="line">insert into t19 values(<span class="string">'a'</span>);</span><br><span class="line"><span class="comment"># 统计char_length字段长度</span></span><br><span class="line">select char_length(name) <span class="keyword">from</span> t18;</span><br><span class="line"><span class="comment"># char硬盘里存放的是真正的数据，带有空格的，但是在mysql显示会自动将多余的空格剔除</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 再次修改sql_mode 让MySQL不要做自动剔除操作</span></span><br><span class="line">set <span class="keyword">global</span> sql_mode=<span class="string">'STRICT_TRABLES,PAD_CHAR_TO_FULL_LENGTH'</span></span><br></pre></td></tr></table></figure><p><strong>char和varchar对比</strong>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">char 缺点：浪费空间</span><br><span class="line"> 优点：直接按照固定的字符存取数据</span><br><span class="line">     json egon alex wusir tank</span><br><span class="line">     存按照五个字符存，取也是五个字符取</span><br><span class="line">    </span><br><span class="line">varchar 优点：节省空间</span><br><span class="line">缺点：存取比较麻烦</span><br><span class="line">    存的时候需要制作报头，取也需要报头，最后才能取到真实的数据，</span><br></pre></td></tr></table></figure><h3 id="时间类型"><a href="#时间类型" class="headerlink" title="时间类型"></a>时间类型</h3><ul><li><p>分类：data： 年月日2015-2-03</p><p>​            datatime：年月日时分秒</p><p>​            time：时分秒</p><p>​            Year:2020</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">create table student(</span><br><span class="line">    id int,</span><br><span class="line">    name varchar(<span class="number">6</span>),</span><br><span class="line">    born_year year,</span><br><span class="line">    birth data,</span><br><span class="line">    study_time time,</span><br><span class="line">    reg_time datatime</span><br><span class="line">);</span><br><span class="line">insert into student values(<span class="number">1</span>,<span class="string">'zc'</span>,<span class="string">'1990'</span>,<span class="string">'1999-11-11'</span>,<span class="string">'11:11:11'</span>,<span class="string">'2020-11-11 11:11:11'</span>);</span><br></pre></td></tr></table></figure></li></ul><h3 id="枚举与集合"><a href="#枚举与集合" class="headerlink" title="枚举与集合"></a>枚举与集合</h3><ul><li><p>分类：枚举（多选一）</p><p>​            集合（多选多）</p></li><li><p>具体用法</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">create table user(</span><br><span class="line">id int,</span><br><span class="line">    name char(<span class="number">16</span>),</span><br><span class="line">    gender enum(<span class="string">'male'</span>,<span class="string">'female'</span>)</span><br><span class="line">);</span><br><span class="line">insert into user values(<span class="number">1</span>,<span class="string">'zc'</span>,<span class="string">'male'</span>)</span><br><span class="line"><span class="comment"># 枚举后期存数据的时候只能从里面悬着一个存储</span></span><br><span class="line"></span><br><span class="line">create table teacher(</span><br><span class="line">id int,</span><br><span class="line">    name char(<span class="number">6</span>),</span><br><span class="line">    gender enum(<span class="string">'male'</span>,<span class="string">'female'</span>),</span><br><span class="line">    hobby set(<span class="string">'read'</span>,<span class="string">'play'</span>,<span class="string">'running'</span>)</span><br><span class="line"></span><br><span class="line">)；</span><br><span class="line"></span><br><span class="line">insert into teacher values(<span class="number">1</span>,<span class="string">'zc'</span>,<span class="string">'male'</span>,<span class="string">'read'</span>);</span><br><span class="line">insert into teacher values(<span class="number">2</span>,<span class="string">'zcc'</span>,<span class="string">'female'</span>,<span class="string">'read,running'</span>);</span><br><span class="line">insert into teacher values(<span class="number">2</span>,<span class="string">'zcz'</span>,<span class="string">'male'</span>,<span class="string">'eat'</span>);</span><br><span class="line"><span class="comment"># 集合可以写一个或选择多个，但是不能写里面没有的</span></span><br></pre></td></tr></table></figure></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;存储引擎&quot;&gt;&lt;a href=&quot;#存储引擎&quot; class=&quot;headerlink&quot; title=&quot;存储引擎&quot;&gt;&lt;/a&gt;存储引擎&lt;/h2&gt;&lt;p&gt;针对不同的文件格式会有不同的存储方式和处理机制，针对不同的数据应该有对应不同的处理机制来存储&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>django-批量插入</title>
    <link href="http://yoursite.com/2020/07/09/django-%E6%89%B9%E9%87%8F%E6%8F%92%E5%85%A5/"/>
    <id>http://yoursite.com/2020/07/09/django-%E6%89%B9%E9%87%8F%E6%8F%92%E5%85%A5/</id>
    <published>2020-07-09T13:56:30.866Z</published>
    <updated>2020-06-07T06:58:27.165Z</updated>
    
    <content type="html"><![CDATA[<h2 id="批量插入"><a href="#批量插入" class="headerlink" title="批量插入"></a>批量插入</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ab_pl</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="comment"># 先给Book插入一万条数据</span></span><br><span class="line">    <span class="comment"># for i in range(10000):</span></span><br><span class="line">    <span class="comment">#     models.Book.objects.create(title='第%s本书'%i)</span></span><br><span class="line">    <span class="comment"># # 再将所有的数据查询并展示到前端页面</span></span><br><span class="line">    book_queryset = models.Book.objects.all()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 批量插入</span></span><br><span class="line">    <span class="comment"># book_list = []</span></span><br><span class="line">    <span class="comment"># for i in range(100000):</span></span><br><span class="line">    <span class="comment">#     book_obj = models.Book(title='第%s本书'%i)</span></span><br><span class="line">    <span class="comment">#     book_list.append(book_obj)</span></span><br><span class="line">    models.Book.objects.bulk_create(book_list)</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    当你想要批量插入数据的时候 使用orm给你提供的bulk_create能够大大的减少操作时间</span></span><br><span class="line"><span class="string">    :param request: </span></span><br><span class="line"><span class="string">    :return: </span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">'ab_pl.html'</span>,locals())</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;批量插入&quot;&gt;&lt;a href=&quot;#批量插入&quot; class=&quot;headerlink&quot; title=&quot;批量插入&quot;&gt;&lt;/a&gt;批量插入&lt;/h2&gt;&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;p
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>由django中间件引发的编程思想</title>
    <link href="http://yoursite.com/2020/07/09/%E7%94%B1django%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%BC%95%E5%8F%91%E7%9A%84%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/"/>
    <id>http://yoursite.com/2020/07/09/%E7%94%B1django%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%BC%95%E5%8F%91%E7%9A%84%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/</id>
    <published>2020-07-09T13:56:26.963Z</published>
    <updated>2020-06-08T09:38:39.458Z</updated>
    
    <content type="html"><![CDATA[<h2 id="由django中间件引发的编程思想"><a href="#由django中间件引发的编程思想" class="headerlink" title="由django中间件引发的编程思想"></a>由django中间件引发的编程思想</h2><p>创建一个文件夹，把一个个功能写成一个个py文件,假如我们写一个消息通知，让qq， 微信，邮箱都能接收到，qq， 微信，邮箱就是一个个功能</p><p><strong>aapp02文件夹下的qq.py</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Qq</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">send</span><span class="params">(self,content)</span>:</span></span><br><span class="line">        print(<span class="string">f'QQ通知：<span class="subst">&#123;content&#125;</span>'</span>)</span><br></pre></td></tr></table></figure><p><strong>aapp02文件夹下的wechat.py</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Wechat</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">send</span><span class="params">(self,content)</span>:</span></span><br><span class="line">        print(<span class="string">f'微信通知：<span class="subst">&#123;content&#125;</span>'</span>)</span><br></pre></td></tr></table></figure><p><strong>aapp02文件夹下的email.py</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Email</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">send</span><span class="params">(self,content)</span>:</span></span><br><span class="line">        print(<span class="string">f'邮件通知：<span class="subst">&#123;content&#125;</span>'</span>)</span><br></pre></td></tr></table></figure><p><strong>aapp02文件夹下的<code>__init__.py</code></strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span>  settings</span><br><span class="line"><span class="keyword">import</span> importlib</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_all</span><span class="params">(content)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> path_str <span class="keyword">in</span> settings.APP02_LIST:</span><br><span class="line">        module_path ,class_name = path_str.rsplit(<span class="string">'.'</span>,maxsplit=<span class="number">1</span>) </span><br><span class="line">        module = importlib.import_module((module_path)) <span class="comment">#1 利用字符串导入模块</span></span><br><span class="line">        cls = getattr(module,class_name) <span class="comment"># 2 利用反射获取类名</span></span><br><span class="line">        obj =cls() <span class="comment"># 3 生成类的对象</span></span><br><span class="line">        obj.send(content)  <span class="comment"># 4 利用鸭子类型直接调用send方法</span></span><br></pre></td></tr></table></figure><p><strong>settings.py</strong>:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">APP02_LIST = [</span><br><span class="line">    <span class="string">'aapp02.email.Email'</span>,</span><br><span class="line">    <span class="string">'aapp02.qq.Qq'</span>,</span><br><span class="line">    <span class="string">'aapp02.wechat.Wechat'</span>,</span><br><span class="line"></span><br><span class="line">]</span><br></pre></td></tr></table></figure><p><strong>start.py</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> aapp02</span><br><span class="line">aapp02.send_all(<span class="string">'下课了'</span>)</span><br></pre></td></tr></table></figure><p>当我们添加或者删除一个功能的时候，只需要在seetings里面添加或注释掉就可以了.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;由django中间件引发的编程思想&quot;&gt;&lt;a href=&quot;#由django中间件引发的编程思想&quot; class=&quot;headerlink&quot; title=&quot;由django中间件引发的编程思想&quot;&gt;&lt;/a&gt;由django中间件引发的编程思想&lt;/h2&gt;&lt;p&gt;创建一个文件夹，把一
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>bbs</title>
    <link href="http://yoursite.com/2020/07/05/bbs/"/>
    <id>http://yoursite.com/2020/07/05/bbs/</id>
    <published>2020-07-05T12:43:05.741Z</published>
    <updated>2020-07-10T09:29:54.133Z</updated>
    
    <content type="html"><![CDATA[<p>js只要用到内置对象，直接用new生成就可以了</p><h2 id="1-用户注册上传头像"><a href="#1-用户注册上传头像" class="headerlink" title="1. 用户注册上传头像"></a>1. 用户注册上传头像</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;div class="form-group"&gt;</span><br><span class="line">                &lt;label <span class="keyword">for</span>=<span class="string">"myfile"</span>&gt;头像</span><br><span class="line">                    &#123;% load static %&#125;</span><br><span class="line">                    &lt;img id="myimg" src="&#123;% static 'img/default.png' %&#125;" alt="" width="80" style="margin-left: 20px"&gt;&lt;/label&gt;</span><br><span class="line">                &lt;input type=<span class="string">"file"</span> id=<span class="string">"myfile"</span> name=<span class="string">"avater"</span> style=<span class="string">"display: none"</span>&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">    //文本域变化事件</span><br><span class="line">    $(<span class="string">'#myfile'</span>).change(function () &#123;</span><br><span class="line">        //文件阅读器对象</span><br><span class="line">        //<span class="number">1.</span>先生成一个文件阅读器对象</span><br><span class="line">        let myFileReadObj = new FileReader(); // 文件阅读器</span><br><span class="line">        //<span class="number">2.</span> 获取用户上传的头像文件</span><br><span class="line">        let fileObj = $(this)[<span class="number">0</span>].files[<span class="number">0</span>]; //获取文件</span><br><span class="line">        // <span class="number">3.</span>将文件对象交给文件阅读器读取</span><br><span class="line">        myFileReadObj.readAsDataURL(fileObj) //异步操作，io操作，这行代码文件还没有读完，就已经开始执行下一句代码，在前端不显示</span><br><span class="line">        //<span class="number">4.</span>利用文件阅读器将文件展示到页面去 修改src属性</span><br><span class="line">        //等待文件阅读器加载完之后，在执行</span><br><span class="line">        myFileReadObj.onload = function()&#123;  $(<span class="string">'#myimg'</span>).attr(<span class="string">'src'</span>,myFileReadObj.result)&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure><ul><li>这里我们要用到文本与变化事件，利用文件阅读器对象，我们要先生成一个文件阅读器对象，</li><li>获取用户上传的头像文件读取出来</li><li>将文件对象交给文件阅读器读取出来文件</li><li>利用文件阅读器将文件展示到页面上去，就要修改src属性，<code>myFileReadObj.readAsDataURL(fileObj)</code>和<code>$(&#39;#myimg&#39;).attr(&#39;src&#39;,myFileReadObj.result)</code>这两部是一个异步操作，如果你在执上一代码的同时文件还没有读取出来，同时他还在执行下一句代码，这样会造成你上传之后在前端是不显示你上传的头像，空白区，我们要等文件加载完毕在执行下一局，<code>myFileReadObj.onload</code> </li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"> $(<span class="string">'#id_commit'</span>).click(function () &#123;</span><br><span class="line">        // 发送ajax请求     我们发送的数据中即包含普通的键值也包含文件</span><br><span class="line">        let formDataObj = new FormData();</span><br><span class="line">        // <span class="number">1.</span>添加普通的键值对</span><br><span class="line">        &#123;<span class="comment">#console.log($('#myform').serializeArray())  // [&#123;&#125;,&#123;&#125;,&#123;&#125;,&#123;&#125;,&#123;&#125;]  只包含普通键值对#&#125;</span></span><br><span class="line">        $.each($(<span class="string">'#myform'</span>).serializeArray(),function (index,obj) &#123;</span><br><span class="line">            &#123;<span class="comment">#console.log(index,obj)#&#125;  // obj = &#123;&#125;</span></span><br><span class="line">            formDataObj.append(obj.name,obj.value)</span><br><span class="line">        &#125;);</span><br><span class="line">        // <span class="number">2.</span>添加文件数据</span><br><span class="line">        formDataObj.append(<span class="string">'avatar'</span>,$(<span class="string">'#myfile'</span>)[<span class="number">0</span>].files[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">        // <span class="number">3.</span>发送ajax请求</span><br><span class="line">        $.ajax(&#123;</span><br><span class="line">            url:<span class="string">""</span>,</span><br><span class="line">            type:<span class="string">'post'</span>,</span><br><span class="line">            data:formDataObj,</span><br><span class="line"></span><br><span class="line">            // 需要指定两个关键性的参数</span><br><span class="line">            contentType:false,</span><br><span class="line">            processData:false,</span><br><span class="line"></span><br><span class="line">            success:function (args) &#123;</span><br><span class="line">                <span class="keyword">if</span> (args.code==<span class="number">1000</span>)&#123;</span><br><span class="line">                    // 跳转到登陆页面</span><br><span class="line">                    window.location.href = args.url</span><br><span class="line">                &#125;els</span><br><span class="line">                    // 如何将对应的错误提示展示到对应的input框下面</span><br><span class="line">                    // forms组件渲染的标签的id值都是 id_字段名</span><br><span class="line">                    $.each(args.msg,function (index,obj) &#123;</span><br><span class="line">                        &#123;<span class="comment">#console.log(index,obj)  //  username        ["用户名不能为空"]#&#125;</span></span><br><span class="line">                        let targetId = <span class="string">'#id_'</span> + index;</span><br><span class="line">                        $(targetId).next().text(obj[<span class="number">0</span>]).parent().addClass(<span class="string">'has-error'</span>)</span><br><span class="line">                    &#125;)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="comment"># 产生一个空对象</span></span><br><span class="line">    register_form = myforms.MyRegForm()</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</span><br><span class="line">        back_dic = &#123;<span class="string">'code'</span>:<span class="string">''</span>, <span class="string">'msg'</span>: <span class="string">''</span>&#125;</span><br><span class="line">        <span class="comment"># 校验数据是否合法</span></span><br><span class="line">        register_form = myforms.MyRegForm(request.POST)</span><br><span class="line">        <span class="comment"># 判断数据是否合法</span></span><br><span class="line">        <span class="keyword">if</span> register_form.is_valid():</span><br><span class="line">            clean_data = register_form.cleaned_data <span class="comment"># 将校验通过的数据字典赋值给一个变量</span></span><br><span class="line">            <span class="comment"># 将字典里面吗的confirm_password键值对删除</span></span><br><span class="line">            clean_data.pop(<span class="string">'confirm_password'</span>)</span><br><span class="line">            <span class="comment"># 用户头像</span></span><br><span class="line">            file_obj = request.FILES.get(<span class="string">'avatar'</span>)</span><br><span class="line">            <span class="string">"""</span></span><br><span class="line"><span class="string">            针对用户头像一定要判断是否传之，不能直接添加到字典里面去</span></span><br><span class="line"><span class="string">            """</span></span><br><span class="line">            <span class="keyword">if</span> file_obj:</span><br><span class="line">                clean_data[<span class="string">'avatar'</span>] = file_obj</span><br><span class="line">            <span class="comment"># 直接操作数据库保存到字典里面</span></span><br><span class="line">            models.UserInfo.objects.create_user(**clean_data) <span class="comment"># 将键值对**打散传到数据库</span></span><br><span class="line">            <span class="comment"># 判断正确跳转到登录页面</span></span><br><span class="line">            back_dic[<span class="string">'url'</span>] = <span class="string">'/login/'</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            back_dic[<span class="string">'code'</span>] = <span class="number">2000</span></span><br><span class="line">            back_dic[<span class="string">'msg'</span>] = register_form.errors</span><br><span class="line">            <span class="keyword">return</span> JsonResponse(back_dic)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'register.html'</span>, locals())</span><br></pre></td></tr></table></figure><p><strong>前端：</strong></p><ul><li><p>头像的功能完成之后，剩下的就是将利用ajax将文件发送到后端，前端要先利用内置对象获取数据，添加不同键值对，我们可以利用<code>serializeArray()</code>拿到他所有的键值对，利用each循环拿到每一个对象的键值对</p></li><li><p>利用append添加文件数据，发送ajax请求，这里面我们要指定两个关键参数<code>contentType: false</code>,<code>processData: false</code>,</p></li><li><p>如果后端保存数据成功，就跳转到后端写好传过来的指定页面，如果校验数据失败就在input框下面展现出对应的错误</p></li><li><p>当我们看见错误的信息之后，如果把鼠标放上去，指定的错误就会消失，给所有的input框绑定获取焦点事件，将input下面的span标签和input外面的div标签修改内容和属性</p></li></ul><p><strong>后端</strong></p><ul><li>校验数据输入的是否合法，将合法的数据赋值给一个变量，赋值给一个变量方便我们删除确认密码的键值对，因为我们在写models的时候没有这个字段，针对用户头像一定要判断是否传之，不能直接添加到字典里面去，在models里面我们给他默认了一个头像</li><li>操作数据库保存数据，定义字典将信息返回给ajax，ajax都到在页面展示对应的页面信息</li></ul><p>存取问题：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RegisterForm</span><span class="params">(forms.Form)</span>:</span></span><br><span class="line"> data  = register_form.cleaned_data</span><br><span class="line"> models.UserInfo.objects.create_user(**data)</span><br><span class="line"> 这里我们在前端像后端存的时候出现了问题，原因是models里面的username和password必须和form表单里面的字段名一致，因为我们去表单里面验证的时候用的是form表单里面的字段名去数据库里面存，**data的时候字段名这个和数据库里面的字段名不一样</span><br></pre></td></tr></table></figure><h2 id="2-生成登录验证码"><a href="#2-生成登录验证码" class="headerlink" title="2. 生成登录验证码"></a>2. 生成登录验证码</h2><p>如何生成一个验证码，然后点击它就可以刷新呢。</p><p>利用pip3 install pillow ，这个是图片相关的模块。</p><p>导入模块：<code>from PIL import Image, ImageDraw, ImageFont</code></p><ul><li>Image 生成图片</li><li>ImageDraw 能够在图片上添加东西</li><li>ImageFont 控制字体的样式</li></ul><p><strong>推导1</strong>：</p><p>直接获取后端生成的图片二进制数据发送给前端</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> open(<span class="string">r'static/img/111.jpg'</span>,<span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">      data = f.read()</span><br><span class="line"><span class="keyword">return</span> HttpResponse(data)</span><br></pre></td></tr></table></figure><p><strong>推导2</strong></p><p>利用pillow模块动态产生图片</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">img_obj = Image.new(<span class="string">'RGB'</span>,(<span class="number">430</span>,<span class="number">35</span>),<span class="string">'green'</span>)</span><br><span class="line">img_obj = Image.new(<span class="string">'RGB'</span>,(<span class="number">430</span>,<span class="number">35</span>),get_random())</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将图片对象 保存起来</span></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'xxx.png'</span>,<span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    img_obj.save(f,<span class="string">'png'</span>)</span><br><span class="line"><span class="comment"># 再将文件对象读取出来</span></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'xxx.png'</span>,<span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    data = f.read()</span><br><span class="line"><span class="keyword">return</span> HttpResponse(data)</span><br></pre></td></tr></table></figure><p><strong>推导3</strong><br>我们可以看到利用文件存储繁琐而且IO操作效率低，我们可以借助内存管理模块</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO,StringIO</span><br><span class="line">img_obj = Image.new(<span class="string">'RGB'</span>, (<span class="number">430</span>, <span class="number">35</span>), get_random())</span><br><span class="line">io_obj = BytesIO()</span><br><span class="line">img_obj.save(io_obj,<span class="string">'png'</span>) <span class="comment"># 生成一个内存管理器对象</span></span><br><span class="line"><span class="keyword">return</span> HttpResponse(io_obj.getvalue()) <span class="comment"># 从内存管理器中读取二进制的图片数据返回给前端</span></span><br></pre></td></tr></table></figure><p><strong>推导4</strong></p><p>写成图片验证码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">img_obj = Image.new(<span class="string">'RGB'</span>, (<span class="number">430</span>, <span class="number">35</span>), get_random())</span><br><span class="line">img_draw = ImageDraw.Draw(img_obj)  <span class="comment"># 产生一个画笔对象</span></span><br><span class="line">img_font = ImageFont.truetype(<span class="string">'static/font/222.ttf'</span>,<span class="number">30</span>)  <span class="comment"># 字体样式 大小</span></span><br></pre></td></tr></table></figure><p><strong>最终成型</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_random</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> random.randint(<span class="number">0</span>,<span class="number">255</span>),random.randint(<span class="number">0</span>,<span class="number">255</span>),random.randint(<span class="number">0</span>,<span class="number">255</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_code</span><span class="params">(request)</span>:</span></span><br><span class="line">    img_obj = Image.new(<span class="string">'RGB'</span>, (<span class="number">430</span>, <span class="number">35</span>), get_random()) <span class="comment"># 注意：这里的430，35要和前端的一致</span></span><br><span class="line">    img_draw = ImageDraw.Draw(img_obj)</span><br><span class="line">    img_font = ImageFont.truetype(<span class="string">'static/font/222.ttf'</span>,<span class="number">30</span>)</span><br><span class="line">    code = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">        random_upper = chr(random.randint(<span class="number">65</span>,<span class="number">90</span>))</span><br><span class="line">        random_lower = chr(random.randint(<span class="number">97</span>,<span class="number">122</span>))</span><br><span class="line">        random_int = str(random.randint(<span class="number">0</span>,<span class="number">9</span>))</span><br><span class="line">        tmp = random.choice([random_lower,random_upper,random_int])</span><br><span class="line">        img_draw.text((i*<span class="number">60</span>+<span class="number">60</span>,<span class="number">-2</span>),tmp,get_random(),img_font)</span><br><span class="line">        code += tmp</span><br><span class="line">    print(code)</span><br><span class="line">    request.session[<span class="string">'code'</span>] = code</span><br><span class="line">    io_obj = BytesIO()</span><br><span class="line">    img_obj.save(io_obj,<span class="string">'png'</span>)</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(io_obj.getvalue())</span><br></pre></td></tr></table></figure><ul><li>实现低级验证码图片刷新验证码，这样设置后每次点击图片相当于超后端发送一次get请求获取一个新的验证码图片</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="comment"># 点击验证码图片刷新验证码   #&#125;</span></span><br><span class="line">$(<span class="string">'#code_img'</span>).click(function () &#123;</span><br><span class="line">    $(this).attr('src', '&#123;% url "get_code" %&#125;?')// src='/get_code/?'url后面加?的操作</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h2 id="3-admin的使用"><a href="#3-admin的使用" class="headerlink" title="3. admin的使用"></a>3. admin的使用</h2><p>以前写图书的展示列表，我们给它添加增删改查的功能，特别的麻烦，现在有很多张表的展示，我们不可能慢慢的写这些功能，django给我们提供了admin后台管理，我们可以利用admin实现增删改查，添加数据。</p><p>首先要创建超级用户，只有超级用户才能够操作admin的这些功能。</p><p>刚开始登录进去的时候只用一张用户表，我们想要添加其他的表，必须添加注册</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> app01 <span class="keyword">import</span> models</span><br><span class="line"><span class="comment"># Register your models here.admin</span></span><br><span class="line">admin.site.register(models.UserInfo)</span><br><span class="line">admin.site.register(models.Blog)</span><br><span class="line">admin.site.register(models.Article)</span><br><span class="line">admin.site.register(models.Atricle2Tag)</span><br><span class="line">admin.site.register(models.UpAndDown)</span><br><span class="line">admin.site.register(models.Category)</span><br><span class="line">admin.site.register(models.Tag)</span><br><span class="line">admin.site.register(models.Comment)</span><br></pre></td></tr></table></figure><p>这样我们就可以使用这些表，但是他们是英文的，我们可以在model.py里面改变他们的名字</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">     verbose_name_plural=<span class="string">'用户表'</span></span><br></pre></td></tr></table></figure><p>我们进去操作添加添加一条数据显示的是对象，</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span><span class="params">(AbstractUser)</span>:</span></span><br><span class="line">    ...</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.username</span><br></pre></td></tr></table></figure><p>避免造成不便语义不明，打印出来</p><p>在model里面的字段添加<code>verbose_name=&#39;创建时间&#39;</code>会在admin后天帮助我们把字段的名称改成中文</p><h2 id="4-制作站点"><a href="#4-制作站点" class="headerlink" title="4. 制作站点"></a>4. 制作站点</h2><p>打开博客园，在博客园的url后面输入别人的站点名称就可以进到他们的站点，如<a href="https://home.cnblogs.com/the3times在后面输入`the3times`就会进到这个人的博客园的主页，这个是url来配置的，利用url`re`匹配规则就可以实现" target="_blank" rel="noopener">https://home.cnblogs.com/the3times在后面输入`the3times`就会进到这个人的博客园的主页，这个是url来配置的，利用url`re`匹配规则就可以实现</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url(<span class="string">r'^(?P&lt;username&gt;\w+)/$'</span>,views.site,name=<span class="string">'site'</span>),</span><br></pre></td></tr></table></figure><h2 id="5-media的配置"><a href="#5-media的配置" class="headerlink" title="5. media的配置"></a>5. media的配置</h2><p>网站用户使用的静态文件默认放在static里面，用户上传的静态文件应该单独放在一个文件夹下，可以使用media配置，该配置可以让用户上传的所有的文件 固定存放在指定的文件夹下</p><p>settings.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置用户上传的文件</span></span><br><span class="line">MEDIA_ROOT = os.path.jion(BASE_DIR,<span class="string">'media'</span>)</span><br></pre></td></tr></table></figure><p>我们配置后，我们上传文件会自动生成media文件，比如我们注册上传的头像会到这个地方，你存的路径在数据库中也不会改变，</p><p>假如你在model.py里面存的路径是<code>avatar/111.png</code>media里面就会多出一个存放头像的<code>avatar/111.png</code>这个就是你存放的头像路径。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span><span class="params">(AbstractUser)</span>:</span></span><br><span class="line">    avatar = models.FileField(upload_to=<span class="string">'avatar/'</span>, default=<span class="string">'avatar/default.png'</span>, verbose_name=<span class="string">'用户头像'</span>)</span><br></pre></td></tr></table></figure><p>在前端点击这个头像能够查看到这个头像，需要我们在后端开设一个指定的文件夹资源</p><p>在url.py配置参数</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.views.static <span class="keyword">import</span> serve</span><br><span class="line"><span class="keyword">from</span> bbs <span class="keyword">import</span> settings</span><br><span class="line"></span><br><span class="line">url(<span class="string">r'^media/(?P&lt;path&gt;.*)'</span>,serve,&#123;<span class="string">'document_root'</span>:settings.MEDIA_ROOT&#125;),</span><br></pre></td></tr></table></figure><p>如果你还想暴漏更多资源，在settings修改文件夹名，想暴露源码也可以，问题就大了</p><p>最后在html配置,渲染后的路径<code>/media/avatar/default.png/</code></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;img class="media-object" src="/media/&#123;&#123; article_obj.blog.userinfo.avatar &#125;&#125;" alt="..." width="40"&gt;</span><br></pre></td></tr></table></figure><p>这样就可以看到别人的头像</p><h2 id="6-站点左边栏展示"><a href="#6-站点左边栏展示" class="headerlink" title="6. 站点左边栏展示"></a>6. 站点左边栏展示</h2><p>左侧边栏展示如何展示的，要清楚orm的查询</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment"># 1.查询当前用户所有分类及分类下的文章数</span></span><br><span class="line">category_list=models.Category.objects.filter(blog=blog).annotate(count_num=Count(<span class="string">'article__pk'</span>)).values_list(<span class="string">'name'</span>,<span class="string">'count_num'</span>,<span class="string">'pk'</span>)</span><br><span class="line">    <span class="comment"># 2.查询当前用户所有标签及标签的文章数</span></span><br><span class="line">tag_list=models.Tag.objects.filter(blog=blog).annotate(count_num=Count(<span class="string">'article__pk'</span>)).values_list(<span class="string">'name'</span>,<span class="string">'count_num'</span>,<span class="string">'pk'</span>) <span class="comment"># &lt;QuerySet [('tank的标签一', 1), ('tank的标签二', 1), ('tank的标签三', 2)]&gt;</span></span><br><span class="line"><span class="comment"># 3.按照日期归档</span></span><br><span class="line">date_list=models.Article.objects.filter(blog=blog).annotate(month=TruncMonth(<span class="string">'create_time'</span>)).values(<span class="string">'month'</span>).annotate(count_num=Count(<span class="string">'pk'</span>)).values_list(<span class="string">'month'</span>,<span class="string">'count_num'</span>)</span><br></pre></td></tr></table></figure><p>这里的日期归档我们按照年月归档，但是数据库里面有年月日，我们如何把日去掉官方提供了一个方法</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">from django.db.models.functions import TruncMonth</span><br><span class="line">Sales.objects</span><br><span class="line">.annotate(month&#x3D;TruncMonth(&#39;timestamp&#39;))  # Truncate to month and add to select list</span><br><span class="line">.values(&#39;month&#39;)  # Group By month</span><br><span class="line">.annotate(c&#x3D;Count(&#39;id&#39;))  # Select the count of the grouping</span><br><span class="line">.values(&#39;month&#39;, &#39;c&#39;)  # (might be redundant, haven&#39;t tested) select month and count</span><br></pre></td></tr></table></figure><p>上面的日期归档就是按照这个模式搬出来的</p><h2 id="7-侧边栏筛选功能"><a href="#7-侧边栏筛选功能" class="headerlink" title="7. 侧边栏筛选功能"></a>7. 侧边栏筛选功能</h2><ul><li>显示分类做好之后，点击文章标签、分类、日期归档统计的链接后，显示该条件下的所有文章列表</li></ul><p>博客园url设计案例</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https://www.cnblogs.com/jason/tag/Python/    标签</span><br><span class="line">https://www.cnblogs.com/jason/category/<span class="number">850028.</span>html 分类</span><br><span class="line">https://www.cnblogs.com/jason/archive/<span class="number">2016</span>/<span class="number">10.</span>html 日期</span><br></pre></td></tr></table></figure><p><strong>规律：</strong>前面的还是站点名，后面是每个分类后的url</p><p><strong>按照这个模式设计我们的url</strong></p><ul><li>个人站点文章是我们筛选后该站点用户所有的文章，这些标签，分类都是在在上面筛选过后加条件在筛选一次</li><li>设计url，处理该url视图函数进一步过滤符合条件的文章</li><li>为了显示在一个页面，就在站点的视图里面进行筛选，这样就不要开辟页面</li><li>按照上面的url设计在每个分类的后面还有参数，点击不同的文章分类后面出现不同的url，利用每个文章分类的主键值为文章列表</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># url(r'^(?P&lt;username&gt;\w+)/category/(\d+)/',views.site),</span></span><br><span class="line"><span class="comment"># url(r'^(?P&lt;username&gt;\w+)/tag/(\d+)/',views.site),</span></span><br><span class="line"><span class="comment"># url(r'^(?P&lt;username&gt;\w+)/archive/(\w+)/',views.site),</span></span><br></pre></td></tr></table></figure><p>前面是匹配站点的名称，后面跟不同的分类，最后匹配主键值</p><p><strong>三句和成一句</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url(<span class="string">r'^(?P&lt;username&gt;\w+)/(?P&lt;condition&gt;category|tag|archive/)(?P&lt;param&gt;.*)/'</span>,views.site),</span><br></pre></td></tr></table></figure><p><strong>后端业务逻辑</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">site</span><span class="params">(request,username,**kwargs)</span>:</span></span><br><span class="line">    <span class="comment"># 先校验当前用户名的站点是否存在</span></span><br><span class="line">    user_obj = models.UserInfo.objects.filter(username=username).first()</span><br><span class="line">    <span class="comment"># 不存在404页面</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> user_obj:</span><br><span class="line">        <span class="keyword">return</span> render(request,<span class="string">'error.html'</span>)</span><br><span class="line">    <span class="comment"># 先到个人站点</span></span><br><span class="line">    blog = user_obj.blog</span><br><span class="line">    <span class="comment"># 查询当前个人站点下所有的文章</span></span><br><span class="line">    article_list = models.Article.objects.filter(blog=blog)</span><br><span class="line">    <span class="keyword">if</span> kwargs:</span><br><span class="line">        <span class="comment"># print(kwargs)  # &#123;'condition': 'tag', 'param': '1'&#125;</span></span><br><span class="line">        condition = kwargs.get(<span class="string">'condition'</span>)</span><br><span class="line">        param = kwargs.get(<span class="string">'param'</span>)</span><br><span class="line">        <span class="comment"># 判断用户到底想按照哪个条件筛选数据</span></span><br><span class="line">        <span class="keyword">if</span> condition == <span class="string">'category'</span>:</span><br><span class="line">            article_list = article_list.filter(category_id=param)</span><br><span class="line">        <span class="keyword">elif</span> condition == <span class="string">'tag'</span>:</span><br><span class="line">            article_list = article_list.filter(tags__id=param)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            year, month = param.split(<span class="string">'-'</span>)</span><br><span class="line">            article_list = article_list.filter(create_time__year=year, create_time__month=month)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1.查询当前用户所有分类及分类下的文章数</span></span><br><span class="line">    category_list = models.Category.objects.filter(blog=blog).annotate(count_num=Count(<span class="string">'article__pk'</span>)).values_list(<span class="string">'name'</span>,<span class="string">'count_num'</span>,<span class="string">'pk'</span>)</span><br><span class="line">    <span class="comment"># 2.查询当前用户所有标签及标签的文章数</span></span><br><span class="line">    tag_list = models.Tag.objects.filter(blog=blog).annotate(count_num=Count(<span class="string">'article__pk'</span>)).values_list(<span class="string">'name'</span>,<span class="string">'count_num'</span>,<span class="string">'pk'</span>)</span><br><span class="line">    <span class="comment"># 3.按照日期归档</span></span><br><span class="line">    date_list = models.Article.objects.filter(blog=blog).annotate(month=TruncMonth(<span class="string">'create_time'</span>)).values(<span class="string">'month'</span>).annotate(count_num=Count(<span class="string">'pk'</span>)).values_list(<span class="string">'month'</span>,<span class="string">'count_num'</span>)</span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">'site.html'</span>,locals())</span><br></pre></td></tr></table></figure><p>解析：<code>**kwargs</code>可能接收额外的参数，先写上去，判断kwargs是否有值，有值再进行操作，``` {‘condition’: ‘tag’, ‘param’: ‘1’}<code>我们点击标签，后面出现我们url设计好的tag，</code>1<code>是标签1的主键值，拿到之后，判断用户像按照哪个条件筛选的，</code>article_list = article_list.filter(tags__id=param)`这个在宅筛选当前站点用户所有的文章之后在进行一次条件筛选</p><p><strong>前端</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;!-- 标签 --&gt;</span><br><span class="line">&#123;% <span class="keyword">for</span> tag <span class="keyword">in</span> tag_list %&#125;</span><br><span class="line">   &lt;p&gt;&lt;a href="/&#123;&#123; username &#125;&#125;/tag/&#123;&#123; tag.pk &#125;&#125;/"&gt;&#123;&#123; tag.name &#125;&#125;(&#123;&#123;tag.c&#125;&#125;)&lt;/a&gt;&lt;/p&gt;</span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line"> </span><br><span class="line">&lt;!-- 分类 --&gt;</span><br><span class="line">&#123;% <span class="keyword">for</span> category <span class="keyword">in</span> category_list %&#125;</span><br><span class="line">   &lt;p&gt;&lt;a href="/&#123;&#123;username&#125;&#125;/category/&#123;&#123; category.pk &#125;&#125;"&gt;&#123;&#123; category.name &#125;&#125;(&#123;&#123;category.c&#125;&#125;)&lt;/a&gt;&lt;/p&gt;</span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line"> </span><br><span class="line">&lt;!-- 归档 --&gt;</span><br><span class="line">&#123;% <span class="keyword">for</span> archive <span class="keyword">in</span> archive_list %&#125;</span><br><span class="line">   &lt;p&gt;&lt;a href="/&#123;&#123; username &#125;&#125;/archive/&#123;&#123; archive.month|date:'Y-m' &#125;&#125;/"&gt;&#123;&#123; archive.month|date:'Y年m月' &#125;&#125;(&#123;&#123; archive.c &#125;&#125;)&lt;/a&gt;&lt;/p&gt;</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure><p><code>//category/</code>把这些url补全，这里的主键值，我们在获取文章查询当前用户所有分类及分类的时候写上去，这样我们就可以在前端拿到主键值<code>values_list(&#39;name&#39;,&#39;count_num&#39;,&#39;pk&#39;)</code></p><h2 id="8-inclusion-tag的制作"><a href="#8-inclusion-tag的制作" class="headerlink" title="8. inclusion_tag的制作"></a>8. inclusion_tag的制作</h2><p>我们制作完站点页面之后制作文章详情页，我们可以在站点详情页上面显示文章，但是在一个页面上显示，显示的代码在后端特别的冗余，我们从新开辟一个文章详情页</p><ul><li>我们建立文章详情页之后，左侧的侧边栏就不会显示，因为我们需要站点的一些数据</li><li>该侧边栏在许多页面显示。</li><li>直接拷贝代码冗余</li></ul><p><strong>将侧边栏制作成inclusion_tag</strong></p><ul><li><p>在应用下创建一个名字必须叫templatetags文件夹</p></li><li><p>在该文件夹内创建一个任意名字的py文件</p></li><li><p>在该py文件内固定先写两汉代码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> template</span><br><span class="line">register = template.Library()</span><br></pre></td></tr></table></figure></li></ul><p><strong>后端封装代码</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> template</span><br><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> Count</span><br><span class="line"><span class="keyword">from</span> django.db.models.functions <span class="keyword">import</span> TruncMonth</span><br><span class="line"><span class="keyword">from</span> app01 <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line">register = template.Library()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义inclusion_tag</span></span><br><span class="line"><span class="meta">@register.inclusion_tag('left_meun.html')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">left_meun</span><span class="params">(username)</span>:</span></span><br><span class="line">    user_obj = models.UserInfo.objects.filter(username=username).first()</span><br><span class="line">    <span class="comment"># 1.查询当前用户所有分类及分类下的文章数</span></span><br><span class="line">    blog = user_obj.blog</span><br><span class="line">    category_list = models.Category.objects.filter(blog=blog).annotate(count_num=Count(<span class="string">'article__pk'</span>)).values_list(</span><br><span class="line">        <span class="string">'name'</span>, <span class="string">'count_num'</span>, <span class="string">'pk'</span>)</span><br><span class="line">    <span class="comment"># 2.查询当前用户所有标签及标签的文章数</span></span><br><span class="line">    tag_list = models.Tag.objects.filter(blog=blog).annotate(count_num=Count(<span class="string">'article__pk'</span>)).values_list(<span class="string">'name'</span>,</span><br><span class="line">                                                                                                         <span class="string">'count_num'</span>,  </span><br><span class="line">    <span class="comment"># 3.按照日期归档</span></span><br><span class="line">    date_list = models.Article.objects.filter(blog=blog).annotate(month=TruncMonth(<span class="string">'create_time'</span>)).values(</span><br><span class="line">        <span class="string">'month'</span>).annotate(count_num=Count(<span class="string">'pk'</span>)).values_list(<span class="string">'month'</span>, <span class="string">'count_num'</span>)</span><br><span class="line">    <span class="keyword">return</span> locals()</span><br></pre></td></tr></table></figure><p><strong>前端建立一个letf_meun.html把左侧边栏的代码放在这里</strong></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;div class="panel panel-success"&gt;...&lt;/div&gt;</span><br><span class="line">&lt;div class="panel panel-primary"&gt;...&lt;/div&gt;</span><br><span class="line">&lt;div class="panel panel-danger"&gt;... &lt;/div&gt;</span><br></pre></td></tr></table></figure><p>在需要侧边栏的地方写如在base.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% load mytag %&#125;</span><br><span class="line">&#123;% left_meun username %&#125;</span><br></pre></td></tr></table></figure><p>这样在每个页面需要左侧边栏的地方都可以显示了。这样就可以避免大量的冗余代码，也可以少些</p><h2 id="8-根评论子评论"><a href="#8-根评论子评论" class="headerlink" title="8 根评论子评论"></a>8 根评论子评论</h2><ul><li>允许根评论和子评论（评论评论的评论），可以评论自己的文章。</li><li>用户未登录不能评论且隐藏评论输入框(request.user.is_authenticated)。</li><li>评论内容有两种渲染方式：<ul><li>刷新页面时，从后端取出评论数据，前端循环展示</li><li>评论后DOM操作临时将评论内容渲染到评论列表，使用的是js的模版字符串语法。</li></ul></li><li>根评论朝后端提交的数据：文章主键、评论内容、</li><li>子评论朝后端提交的数据：文章主键、评论内容、父评论主键</li><li>获取父评论的方式：给回复按钮绑定一个自定义属性，属性值为父评论主键</li><li>区分子评论和根评论关键在于是否有父评论，这里面为了统一，提交根评论时也携带父评论（只不过值为null，因为数据库该字段支持为空）。</li></ul><p><strong>后端</strong></p><ul><li>需要登录后才能评论，所以使用一个登录校验装饰器</li><li>后端逻辑比较简单，接收评论内容、文章主键、父评论主键</li><li>评论内容为空值，响应提示信息</li><li>使用事物同时更新文章表和评论表。</li></ul><p>代码主要都在前端</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//设置一个全局的parentId字段</span><br><span class="line">let parentId =null</span><br><span class="line">// 用户发表评论按钮发送ajax请求</span><br><span class="line">$(<span class="string">'#id_submit'</span>).click(function () &#123;</span><br><span class="line">    //先拿到用户评论的内容</span><br><span class="line">    let conTent = $(<span class="string">'#id_comment'</span>).val();</span><br><span class="line">    //因为子评论存的时候不应该有@人名，所以我们要手动去除@username</span><br><span class="line">    <span class="keyword">if</span> (parentId)&#123;</span><br><span class="line">        let indexNum = conTent.indexOf(<span class="string">'\n'</span>) + <span class="number">1</span>;//找到\n对应的索引。然后切片，但是骨头不顾尾要+<span class="number">1</span></span><br><span class="line">        conTent = conTent.slice(indexNum)//将indexNum之前的所有数据清楚，只保留后面的部分</span><br><span class="line">    &#125;</span><br><span class="line">    $.ajax(&#123;</span><br><span class="line">        url:<span class="string">'/comment/'</span>,</span><br><span class="line">        type:<span class="string">'post'</span>,</span><br><span class="line">        data: &#123;</span><br><span class="line">            <span class="string">'article_id'</span>:<span class="string">'&#123;&#123; article_obj.pk &#125;&#125;'</span>,</span><br><span class="line">            <span class="string">'content'</span>:conTent,</span><br><span class="line">            // 如果parentId没有值，就是null，后面数据库可以为null没任何问题</span><br><span class="line">            <span class="string">'parent_id'</span>:parentId,</span><br><span class="line">            <span class="string">'csrfmiddlewaretoken'</span>:<span class="string">'&#123;&#123; csrf_token &#125;&#125;'</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        success:function (args) &#123;</span><br><span class="line">                <span class="keyword">if</span> (args.code==<span class="number">1000</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    $(<span class="string">'#error'</span>).text(args.msg)</span><br><span class="line">                    //评论框里面的内容清空</span><br><span class="line">                    $(<span class="string">'id_comment'</span>).val(<span class="string">''</span>);</span><br><span class="line">                    //临时渲染</span><br><span class="line">                    let userName=<span class="string">'&#123;&#123; request.user.username &#125;&#125;'</span>;</span><br><span class="line">                    let temp = `</span><br><span class="line">                    &lt;li class="list-group-item"&gt;</span><br><span class="line"></span><br><span class="line">                        &lt;span&gt;$&#123;userName&#125;&lt;/span&gt;</span><br><span class="line">                        &lt;span&gt;&lt;a href="#" class="pull-right"&gt;回复&lt;/a&gt;&lt;/span&gt;</span><br><span class="line">                        &lt;div&gt;</span><br><span class="line">                            $&#123;conTent&#125;</span><br><span class="line">                        &lt;/div&gt;</span><br><span class="line">                        &lt;/li&gt;</span><br><span class="line">                    `</span><br><span class="line">                    //添加到ul里面</span><br><span class="line">                    $(<span class="string">'.list-group'</span>).append(temp)</span><br><span class="line">                    //清空全局的parentId</span><br><span class="line">                    parentId = null;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">&#125;)</span><br><span class="line">//  给回复按钮绑定点击事件</span><br><span class="line">$(<span class="string">'.reply'</span>).click(function () &#123;</span><br><span class="line">    //需要评论对应的评论人姓名，还需要评论的主键值</span><br><span class="line">    //获取用户名和主键值，自定义属性</span><br><span class="line">    let commentUsername = $(this).attr(<span class="string">'username'</span>);</span><br><span class="line">    //直接修改全局</span><br><span class="line">    parentId =$(this).attr(<span class="string">'comment_id'</span>);</span><br><span class="line">    //拼接信息塞给评论框</span><br><span class="line">    $(<span class="string">'#id_comment'</span>).val(<span class="string">'@'</span>+ commentUsername + <span class="string">'\n'</span>).focus()</span><br><span class="line"></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><strong>解析步骤</strong>：</p><ul><li><p>用户放松ajax请求</p></li><li><p>拿到用户评论内容</p></li><li><p>临时渲染评论框，但是只显示一个人的名字</p></li><li><p>这个时候把临时渲染的评论框加到ul里面，根评论完成</p></li><li><p>子评论给回复按钮绑定点击事件</p></li><li><p>这个时候我们要拿到对应的评论人的用户名，还有评论的id主键值</p></li><li><p>如何获取用户名和主键值，给他们自定义属性</p><p><code>&lt;span&gt;&lt;a  class=&quot;pull-right reply&quot; username=&quot;&quot; comment_id=&quot;&quot;&gt;回复&lt;/a&gt;&lt;/span&gt;</code></p></li><li><p>拼接信息给评论框</p></li><li><p>发送信息如何发送呢，设置一个全局的子评论字段，子评论的内容直接修改全局</p></li><li><p>但是我们发送的时候parentId没有值，就是null，正好数据库的parent_id字段可以为null没有任何问题</p></li><li><p>评论时存储的有@用户名，所以我们要手动去除@username</p></li><li><p>找到\n，因为我们在拼接信息的时候\n前面就是@username用户名，我们截取到\n，切片固头不顾尾+1<code>let indexNum = conTent.indexOf(&#39;\n&#39;) + 1</code></p></li><li><p>将indexNum之前的所有数据清除，保留后面的部分</p></li><li><p>这个时候我们在写根评论的时候还有子评论的主键值，要清除全局的parentId</p></li></ul><p><strong>后端</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开启事务操作两种表</span></span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> transaction</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">comment</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="comment"># 自己也能评论</span></span><br><span class="line">    <span class="keyword">if</span> request.is_ajax():</span><br><span class="line">        <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</span><br><span class="line">            back_dic = &#123;<span class="string">'code'</span>: <span class="number">1000</span>, <span class="string">'msg'</span>: <span class="string">''</span>&#125;</span><br><span class="line">            <span class="keyword">if</span> request.user.is_authenticated:</span><br><span class="line">                article_id = request.POST.get(<span class="string">'article_id'</span>)</span><br><span class="line">                content = request.POST.get(<span class="string">'content'</span>)</span><br><span class="line">                parent_id = request.POST.get(<span class="string">'parent_id'</span>)</span><br><span class="line">                <span class="comment"># 直接操作评论表存数据，两张表</span></span><br><span class="line">                <span class="keyword">with</span> transaction.atomic():</span><br><span class="line">                    models.Article. objects.filter(pk=article_id).update(comment_num=F(<span class="string">'comment_num'</span>) + <span class="number">1</span>)</span><br><span class="line">                    models.Comment.objects.create(parent_id=parent_id,user=request.user, article_id=article_id, content=content)</span><br><span class="line"></span><br><span class="line">                back_dic[<span class="string">'msg'</span>] = <span class="string">'评论成功'</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                back_dic[<span class="string">'code'</span>] = <span class="number">10001</span></span><br><span class="line">                back_dic[<span class="string">'msg'</span>] = <span class="string">'用户未登录'</span></span><br><span class="line">            <span class="keyword">return</span> JsonResponse(back_dic)</span><br></pre></td></tr></table></figure><ul><li><p>我们需要操作多张表的时候可以开启事务</p></li><li><p>因为子评论可以为空，直接接收，可以省很多事情</p></li></ul><h2 id="9-beautifulsuop4"><a href="#9-beautifulsuop4" class="headerlink" title="9 beautifulsuop4"></a>9 beautifulsuop4</h2><ul><li>编辑别的博客复制在富文本编辑器，会有html页面代码，截取文本内容代码一起截取</li><li>xss攻击，如在里面使用script代码写内容，保存不显示</li><li>筛选标签去除html代码</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">content = request.POST.get(<span class="string">'content'</span>)</span><br><span class="line"></span><br><span class="line">soup = BeautifulSoup(content, <span class="string">'html.parser'</span>) // 把要筛选的内容放进去</span><br><span class="line">tags = soup.find_all() // 找到所有标签</span><br><span class="line"><span class="keyword">for</span> tag <span class="keyword">in</span> tags:</span><br><span class="line">    <span class="keyword">if</span> tag.name == <span class="string">'script'</span>: //</span><br><span class="line">    找到script标签</span><br><span class="line">    tag.decompose() // 删除标签</span><br><span class="line">desc = soup.text[<span class="number">0</span>:<span class="number">150</span>] // 截取文章描述</span><br><span class="line">article_obj = models.Article.objects.create(</span><br><span class="line">    title=title,</span><br><span class="line">    content=str(soup),</span><br><span class="line">    desc=desc,</span><br><span class="line">    category_id=category_id,</span><br><span class="line">    blog=request.user.blog</span><br><span class="line">)</span><br></pre></td></tr></table></figure><h2 id="10-富文本编辑器遗留问题"><a href="#10-富文本编辑器遗留问题" class="headerlink" title="10 富文本编辑器遗留问题"></a>10 富文本编辑器遗留问题</h2><ul><li>在上传图片会出现下载问题</li><li>403：forbidden</li><li>自定义富文本编辑器</li></ul><p><strong>前端</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">添加参数：uploadJson:<span class="string">'/路径/'</span></span><br><span class="line">自定义参数：extraFileUploadParams : &#123;&#125;</span><br><span class="line">添加：  csrfmiddlewaretoken:<span class="string">'&#123;&#123; csrf_token &#125;&#125;'</span></span><br></pre></td></tr></table></figure><p><strong>后端：</strong></p><ul><li>获取上传的图片文件的键</li><li>拼接上传路径</li><li>返回media开放的资源路径</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> bbs <span class="keyword">import</span> settings</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload_img</span><span class="params">(request)</span>:</span></span><br><span class="line">    back_dic = &#123;<span class="string">'error'</span>:<span class="number">0</span>,<span class="string">'url'</span>:<span class="string">''</span>&#125;</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</span><br><span class="line">        file_obj = request.FILES.get(<span class="string">'imgFile'</span>)//这里不知道键是多少，用request.FILES打印看一下</span><br><span class="line">        <span class="comment"># 手动拼接</span></span><br><span class="line">        file_path = os.path.join(settings.BASE_DIR,<span class="string">'media'</span>,<span class="string">'article_img'</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.isdir(file_path):</span><br><span class="line">            os.mkdir(file_path)</span><br><span class="line">        file_img = os.path.join(file_path,file_obj.name)</span><br><span class="line">        <span class="keyword">with</span> open(file_img,<span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> file_obj:</span><br><span class="line">                f.write(i)</span><br><span class="line">        back_dic[<span class="string">'url'</span>] = <span class="string">'/media/article_img/%s'</span>%file_obj.name</span><br><span class="line">    <span class="keyword">return</span> JsonResponse(back_dic)</span><br></pre></td></tr></table></figure><ul><li>获取键，手动拼接路径，判断是否存在文件夹，不存在创建</li><li>用<code>with open</code>保存文件</li><li>开放资源路径</li></ul><h2 id="11-修改头像问题"><a href="#11-修改头像问题" class="headerlink" title="11 修改头像问题"></a>11 修改头像问题</h2><p>修改头像出现了csrf-403-forbidden问题</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">'#id_set_avatar'</span>).click(function () &#123;</span><br><span class="line"></span><br><span class="line">   let formDataObj = new FormData();// 将普通数据和文件添加到该对象中</span><br><span class="line">   formDataObj.append(<span class="string">'avatar'</span>, $(<span class="string">'#myfile'</span>)[<span class="number">0</span>].files[<span class="number">0</span>]);</span><br><span class="line">   formDataObJ.append(<span class="string">'csrfmiddelwaretoken'</span>:<span class="string">'&#123;&#123;csrf_token&#125;&#125;'</span>)</span><br><span class="line"></span><br><span class="line">    $.ajax(&#123;</span><br><span class="line">        url: <span class="string">'&#123;% url '</span>set_avata<span class="string">r' %&#125;'</span>,</span><br><span class="line"></span><br><span class="line">        type: <span class="string">'post'</span>,</span><br><span class="line">        data:formDataObj,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        contentType: false,  // 必须的</span><br><span class="line">        processData: false,</span><br><span class="line">        // 必须的</span><br><span class="line">        success: function (args) &#123;</span><br><span class="line">            <span class="keyword">if</span> (args.code===<span class="number">1000</span>)&#123;</span><br><span class="line">                window.location.href = args.url</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>这个是正确的书写,我在加中间件的csrf的时候</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">'#id_set_avatar'</span>).click(function () &#123;</span><br><span class="line"></span><br><span class="line">   let formDataObj = new FormData();// 将普通数据和文件添加到该对象中</span><br><span class="line">    $.ajax(&#123;</span><br><span class="line">        url: <span class="string">'&#123;% url '</span>set_avata<span class="string">r' %&#125;'</span>,</span><br><span class="line"></span><br><span class="line">        type: <span class="string">'post'</span>,</span><br><span class="line">        data:&#123;<span class="string">'avatar'</span>, $(<span class="string">'#myfile'</span>)[<span class="number">0</span>].files[<span class="number">0</span>],</span><br><span class="line">             <span class="string">'csrfmiddelwaretoken'</span>:<span class="string">'&#123;&#123;csrf_token&#125;&#125;'</span>&#125;// 因为他的数据本身就是一个对象，这样写对象套对象访问不到这个数据</span><br><span class="line">        contentType: false,  // 必须的</span><br><span class="line">        processData: false,</span><br><span class="line">        // 必须的</span><br><span class="line">        success: function (args) &#123;</span><br><span class="line">            <span class="keyword">if</span> (args.code===<span class="number">1000</span>)&#123;</span><br><span class="line">                window.location.href = args.url</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;js只要用到内置对象，直接用new生成就可以了&lt;/p&gt;
&lt;h2 id=&quot;1-用户注册上传头像&quot;&gt;&lt;a href=&quot;#1-用户注册上传头像&quot; class=&quot;headerlink&quot; title=&quot;1. 用户注册上传头像&quot;&gt;&lt;/a&gt;1. 用户注册上传头像&lt;/h2&gt;&lt;figure 
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>django-中间件笔记</title>
    <link href="http://yoursite.com/2020/07/05/django-%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%AC%94%E8%AE%B0/"/>
    <id>http://yoursite.com/2020/07/05/django-%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%AC%94%E8%AE%B0/</id>
    <published>2020-07-05T12:37:55.673Z</published>
    <updated>2020-06-08T07:35:20.283Z</updated>
    
    <content type="html"><![CDATA[<h2 id="中间件"><a href="#中间件" class="headerlink" title="中间件"></a>中间件</h2><p>中间件是django 的门户，所有的请求和响应都要通过中间件</p><p>django中自带的有7个中间件，</p><h2 id="django中间件的介绍"><a href="#django中间件的介绍" class="headerlink" title="django中间件的介绍"></a>django中间件的介绍</h2><p>在django settings里面的<code>MIDDLEWARE_CLASSES</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">MIDDLEWARE = [</span><br><span class="line">    <span class="string">'django.middleware.security.SecurityMiddleware'</span>,</span><br><span class="line">    <span class="string">'django.contrib.sessions.middleware.SessionMiddleware'</span>,</span><br><span class="line">    <span class="string">'django.middleware.common.CommonMiddleware'</span>,</span><br><span class="line">    <span class="string">'django.middleware.csrf.CsrfViewMiddleware'</span>,</span><br><span class="line">    <span class="string">'django.contrib.auth.middleware.AuthenticationMiddleware'</span>,</span><br><span class="line">    <span class="string">'django.contrib.messages.middleware.MessageMiddleware'</span>,</span><br><span class="line">    <span class="string">'django.middleware.clickjacking.XFrameOptionsMiddleware'</span>,</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>我们简单的看一下里面几个的源码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SessionMiddleware</span><span class="params">(MiddlewareMixin)</span>:</span></span><br><span class="line">   </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_request</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        session_key = request.COOKIES.get(settings.SESSION_COOKIE_NAME)</span><br><span class="line">        request.session = self.SessionStore(session_key)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_response</span><span class="params">(self, request, response)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CsrfViewMiddleware</span><span class="params">(MiddlewareMixin)</span>:</span></span><br><span class="line">   </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_request</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        csrf_token = self._get_token(request)</span><br><span class="line">        <span class="keyword">if</span> csrf_token <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="comment"># Use same token next time.</span></span><br><span class="line">            request.META[<span class="string">'CSRF_COOKIE'</span>] = csrf_token</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_view</span><span class="params">(self, request, callback, callback_args, callback_kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self._accept(request)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_response</span><span class="params">(self, request, response)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure><p>我们从这两个中间件的源码可以看出，他们都有<code>process_request</code>和<code>process_response</code>两个方法，所以这个是我们需要掌握的方法，另外的三个是需要了解的<code>process_view</code>,<code>process_template_response</code>,<code>process_exception</code></p><h2 id="自定义中间件"><a href="#自定义中间件" class="headerlink" title="自定义中间件"></a>自定义中间件</h2><p>在一个项目或者应用名下常见一个任意的文件夹，在文件夹内常见任意名称的py文件，在该py文件内需要书写类（类要结成MiddlewareMixin）在这个里面书写自定义的五个方法，然后将类的路径已字符串的形式注册到配置文件中才能生效</p><p>首先我们在项目app01里面创建一个mymiddel文件夹，在里面创建py文件，然后自定义我们的中间件，最后注册到settings里面</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.utils.deprecation <span class="keyword">import</span> MiddlewareMixin</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyMiddelware1</span><span class="params">(MiddlewareMixin)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_request</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        print(<span class="string">'这是我的第1个中间间里面的process_reuqest'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_response</span><span class="params">(self, request, response)</span>:</span></span><br><span class="line">        print(<span class="string">'这是我的第1个中间件里面的process_response方法'</span>)</span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_view</span><span class="params">(self,request,*args,**kwargs)</span>:</span></span><br><span class="line">        print(args,kwargs)</span><br><span class="line">        print(<span class="string">'这是我的第1个中间件里面的process_view方法'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">prcoess_template_response</span><span class="params">(self,request,response)</span>:</span></span><br><span class="line">        print(<span class="string">'这是我的第1个中间件里面的prcoess_template_response方法'</span>)</span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_exception</span><span class="params">(self,request,exception)</span>:</span></span><br><span class="line">        print(<span class="string">'这是我的第1个中间件里面的process_exception方法'</span>)</span><br><span class="line">        print(exception)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyMiddelware2</span><span class="params">(MiddlewareMixin)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_request</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        print(<span class="string">'这是我的第2个中间间里面的process_request'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_response</span><span class="params">(self, request, response)</span>:</span></span><br><span class="line">        print(<span class="string">'这是我的第2个中间件里面的process_response方法'</span>)</span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_view</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">        print(args, kwargs)</span><br><span class="line">        print(<span class="string">'这是我的第2个中间件里面的process_view方法'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">prcoess_template_response</span><span class="params">(self, request, response)</span>:</span></span><br><span class="line">        print(<span class="string">'这是我的第2个中间件里面的prcoess_template_response方法'</span>)</span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_exception</span><span class="params">(self, request, exception)</span>:</span></span><br><span class="line">        print(<span class="string">'这是我的第2个中间件里面的process_exception方法'</span>)</span><br><span class="line">        print(exception)</span><br></pre></td></tr></table></figure><p><strong>view视图</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request)</span>:</span></span><br><span class="line">    print(<span class="string">'index视图函数'</span>)</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">'这是index的内容'</span>)</span><br></pre></td></tr></table></figure><p><strong>答案：</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">这是我的第<span class="number">1</span>个中间间里面的process_reuqest</span><br><span class="line">这是我的第<span class="number">2</span>个中间间里面的process_request</span><br><span class="line">(&lt;function index at <span class="number">0x000001571ED49AE8</span>&gt;, (), &#123;&#125;) &#123;&#125;</span><br><span class="line">这是我的第<span class="number">1</span>个中间件里面的process_view方法</span><br><span class="line">(&lt;function index at <span class="number">0x000001571ED49AE8</span>&gt;, (), &#123;&#125;) &#123;&#125;</span><br><span class="line">这是我的第<span class="number">2</span>个中间件里面的process_view方法</span><br><span class="line">index视图函数</span><br><span class="line">这是我的第<span class="number">2</span>个中间件里面的process_response方法</span><br><span class="line">这是我的第<span class="number">1</span>个中间件里面的process_response方法</span><br></pre></td></tr></table></figure><p><strong>process_request</strong></p><ul><li><p>从这里我们可以看出我们在输入url 请求的时候，都需要经过每一个中间件里面的process_request方法，他们的执行顺序是按照注册中间件的自上而下执行</p></li><li><p>没有中间件里面定义该方法，直接跳过执行下一个</p></li><li><p>如果在该方法中返回一个HttpResponse对象，请求将不再继续执行，原路返回，证明校验失败，不允许访问（截胡）</p></li><li><p>process_request方法是用来做全局相关功能的</p></li></ul><p><strong>process_response</strong></p><ul><li>响应走的时候需要每一个中间件里面的方法process_response ，里面的参数·<code>response</code> 就是django后端返回给浏览器的内容，默认返回的是形参response，也可以返回自己的</li><li>没有中间件里面定义该方法，直接跳过执行下一个</li><li>而且它返回的方式像FIFO的形式，先进先出</li></ul><p><strong>process_view</strong>(了解)</p><p><code>(&lt;function index at 0x000001571ED49AE8&gt;, (), {}) {}</code></p><ul><li>路由匹配成功之后执行视图函数之前，会自动执行中间件里面的该放法</li><li>顺序是按照配置文件中注册的中间件从上往下的顺序依次执行</li></ul><p><strong>prcoess_template_response</strong>(了解)</p><ul><li>返回的HttpResponse对象有render属性的时候才会触发</li><li>顺序是按照配置文件中注册了的中间件从下往上依次经过</li></ul><p><strong>process_exception</strong></p><ul><li>当视图函数中出现异常的情况下触发</li><li>顺序是按照配置文件中注册了的中间件从下往上依次经过</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;中间件&quot;&gt;&lt;a href=&quot;#中间件&quot; class=&quot;headerlink&quot; title=&quot;中间件&quot;&gt;&lt;/a&gt;中间件&lt;/h2&gt;&lt;p&gt;中间件是django 的门户，所有的请求和响应都要通过中间件&lt;/p&gt;
&lt;p&gt;django中自带的有7个中间件，&lt;/p&gt;
&lt;h2 id
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>各种网站的爬取</title>
    <link href="http://yoursite.com/2019/11/10/%E5%90%84%E7%A7%8D%E7%BD%91%E7%AB%99%E7%9A%84%E7%88%AC%E5%8F%96/"/>
    <id>http://yoursite.com/2019/11/10/%E5%90%84%E7%A7%8D%E7%BD%91%E7%AB%99%E7%9A%84%E7%88%AC%E5%8F%96/</id>
    <published>2019-11-09T16:00:00.000Z</published>
    <updated>2020-08-20T12:16:44.713Z</updated>
    
    <content type="html"><![CDATA[<h2 id="爬取拉勾网"><a href="#爬取拉勾网" class="headerlink" title="爬取拉勾网"></a>爬取拉勾网</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment"># 爬拉钩</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">'https://www.lagou.com/jobs/positionAjax.json?needAddtionalResult=false'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 请求体的内容</span></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">'first'</span>: <span class="string">'true'</span>,</span><br><span class="line">    <span class="string">'pn'</span>: <span class="string">'1'</span>,</span><br><span class="line">    <span class="string">'kd'</span>: <span class="string">'python'</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">header = &#123;</span><br><span class="line">    <span class="string">'user-agent'</span>: <span class="string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.24 Safari/537.36'</span>,</span><br><span class="line">    <span class="string">'referer'</span>: <span class="string">'https://www.lagou.com/jobs/list_python?labelWords=&amp;fromSearch=true&amp;suginput='</span>,</span><br><span class="line">    <span class="string">'accept'</span>: <span class="string">'application/json, text/javascript, */*; q=0.01'</span>,&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 原始的url</span></span><br><span class="line">urls = <span class="string">'https://www.lagou.com/jobs/list_python?labelWords=&amp;fromSearch=true&amp;suginput='</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 建立session</span></span><br><span class="line">s = requests.Session()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取搜索页的cookies</span></span><br><span class="line">s.get(urls,headers=header,timeout=<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 为此次获取的cookices</span></span><br><span class="line">cookie =s.cookies</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取本次的文本</span></span><br><span class="line">response = s.post(url, data=data,headers=header,cookies=cookie,timeout=<span class="number">5</span>).text</span><br><span class="line">print(response)</span><br></pre></td></tr></table></figure><p>首先我们要发送一个get请求<code>https://www.lagou.com/jobs/list_python?labelWords=&amp;fromSearch=true&amp;suginput=</code>，获取到它的cookie,带着cookie发送post请求’<code>https://www.lagou.com/jobs/positionAjax.json?needAddtionalResult=false</code></p><h2 id="爬取17k小说网"><a href="#爬取17k小说网" class="headerlink" title="爬取17k小说网"></a>爬取17k小说网</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line">res = requests.get(<span class="string">'https://www.17k.com/list/3130396.html'</span>)</span><br><span class="line">soup = BeautifulSoup(res.text, <span class="string">'lxml'</span>)</span><br><span class="line">div = soup.find(class_=<span class="string">'Main'</span>)</span><br><span class="line">dd = div.find(name=<span class="string">'dd'</span>)</span><br><span class="line">a_list = dd.find_all(name=<span class="string">'a'</span>)</span><br><span class="line">a_url_list = []</span><br><span class="line"><span class="keyword">for</span> a <span class="keyword">in</span> a_list:</span><br><span class="line">    a = a[<span class="string">'href'</span>]</span><br><span class="line">    a_url = <span class="string">'https://www.17k.com'</span> + a</span><br><span class="line">    a_url_list.append(a_url)</span><br><span class="line"><span class="comment"># print(a_url_list)</span></span><br><span class="line"><span class="keyword">for</span> navel <span class="keyword">in</span> a_url_list:</span><br><span class="line"></span><br><span class="line">    res1 = requests.get(navel)</span><br><span class="line">    res1.encoding = res.apparent_encoding <span class="comment"># 解决乱码</span></span><br><span class="line">    soup1 = BeautifulSoup(res1.text,<span class="string">'lxml'</span>)</span><br><span class="line">    navel_div = soup1.find(class_=<span class="string">'readAreaBox'</span>)</span><br><span class="line"></span><br><span class="line">    navel_title = navel_div.find(name=<span class="string">'h1'</span>).text  <span class="comment"># 小说标题</span></span><br><span class="line"></span><br><span class="line">    navel_p_list = navel_div.find_all(name=<span class="string">'p'</span>)</span><br><span class="line">    <span class="comment"># navel_content_list_str = ''</span></span><br><span class="line">    <span class="keyword">for</span> navel_content <span class="keyword">in</span> navel_p_list:</span><br><span class="line"></span><br><span class="line">        navel_content_list = navel_content.text</span><br><span class="line">        <span class="keyword">with</span> open(<span class="string">f'<span class="subst">&#123;navel_title&#125;</span>.md'</span>,<span class="string">'at'</span>,encoding=<span class="string">'utf-8'</span>)<span class="keyword">as</span> f:</span><br><span class="line"></span><br><span class="line">            f.write(<span class="string">f'<span class="subst">&#123;navel_content_list&#125;</span>'</span>+<span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    print(navel_title)</span><br></pre></td></tr></table></figure><h2 id="爬肯德基门店"><a href="#爬肯德基门店" class="headerlink" title="爬肯德基门店"></a>爬肯德基门店</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">header = &#123;</span><br><span class="line">    <span class="string">'User-Agent'</span>: <span class="string">'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.149 Safari/537.36'</span></span><br><span class="line">&#125;</span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">'cname'</span>: <span class="string">''</span>,</span><br><span class="line">    <span class="string">'pid'</span>: <span class="number">20</span>,</span><br><span class="line">    <span class="string">'keyword'</span>: <span class="string">'浦东'</span>,</span><br><span class="line">    <span class="string">'pageIndex'</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">'pageSize'</span>: <span class="number">10</span></span><br><span class="line">&#125;</span><br><span class="line">ret = requests.post(<span class="string">'http://www.kfc.com.cn/kfccda/ashx/GetStoreList.ashx?op=keyword'</span>, data=data, headers=header)</span><br><span class="line">print(ret.json())</span><br></pre></td></tr></table></figure><h2 id="爬糗事百科段子"><a href="#爬糗事百科段子" class="headerlink" title="爬糗事百科段子"></a>爬糗事百科段子</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line">ret=requests.get(<span class="string">'https://www.qiushibaike.com/text/page/2/'</span>)</span><br><span class="line"><span class="comment"># print(ret.text)</span></span><br><span class="line"></span><br><span class="line">soup=BeautifulSoup(ret.text,<span class="string">'html.parser'</span>)</span><br><span class="line"></span><br><span class="line">article_list=soup.find_all(class_=<span class="string">'article'</span>)</span><br><span class="line"><span class="comment"># print(article_list)</span></span><br><span class="line"><span class="keyword">for</span> article <span class="keyword">in</span> article_list:</span><br><span class="line">    content=article.find(class_=<span class="string">'content'</span>).text</span><br><span class="line">    print(content)</span><br><span class="line">    print(<span class="string">'-------'</span>)</span><br></pre></td></tr></table></figure><h2 id="爬取京东商品信息"><a href="#爬取京东商品信息" class="headerlink" title="爬取京东商品信息"></a>爬取京东商品信息</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="comment"># 模拟键盘输入</span></span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.keys <span class="keyword">import</span> Keys</span><br><span class="line">bro=webdriver.Chrome(executable_path=<span class="string">'./chromedriver.exe'</span>)</span><br><span class="line"><span class="comment"># 设置隐士等待</span></span><br><span class="line">bro.implicitly_wait(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_goods_info</span><span class="params">(bro)</span>:</span></span><br><span class="line">    <span class="comment"># li_list=bro.find_element_by_class_name('gl-warp').find_elements_by_tag_name('li')</span></span><br><span class="line">    <span class="comment"># goods=bro.find_elements_by_class_name('gl-item')</span></span><br><span class="line">    goods = bro.find_elements_by_css_selector(<span class="string">'.gl-item'</span>)</span><br><span class="line">    <span class="comment"># print(len(goods))</span></span><br><span class="line">    <span class="keyword">for</span> good <span class="keyword">in</span> goods:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            price = good.find_element_by_css_selector(<span class="string">'.p-price i'</span>).text</span><br><span class="line">            name = good.find_element_by_css_selector(<span class="string">'.p-name em'</span>).text</span><br><span class="line">            url = good.find_element_by_css_selector(<span class="string">'.p-img a'</span>).get_attribute(<span class="string">'href'</span>)</span><br><span class="line">            commits = good.find_element_by_css_selector(<span class="string">'.p-commit strong&gt;a'</span>).text</span><br><span class="line">            photo_url = good.find_element_by_css_selector(<span class="string">'.p-img img'</span>).get_attribute(<span class="string">'src'</span>)</span><br><span class="line"></span><br><span class="line">            print(<span class="string">'''</span></span><br><span class="line"><span class="string">            商品名字：%s</span></span><br><span class="line"><span class="string">            商品价格：%s</span></span><br><span class="line"><span class="string">            商品地址：%s</span></span><br><span class="line"><span class="string">            商品评论数：%s</span></span><br><span class="line"><span class="string">            商品图片地址：%s</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">            '''</span> % (name, price, url, commits, photo_url))</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">    next_button = bro.find_element_by_partial_link_text(<span class="string">'下一页'</span>)</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    next_button.click()</span><br><span class="line"></span><br><span class="line">    get_goods_info(bro)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    bro.get(<span class="string">'https://www.jd.com/'</span>)</span><br><span class="line"></span><br><span class="line">    input_k=bro.find_element_by_id(<span class="string">'key'</span>)</span><br><span class="line"></span><br><span class="line">    input_k.send_keys(<span class="string">'奶牛'</span>)</span><br><span class="line">    <span class="comment"># 模拟键盘的回车键</span></span><br><span class="line">    input_k.send_keys(Keys.ENTER)</span><br><span class="line">    get_goods_info(bro)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    print(e)</span><br><span class="line"></span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    bro.close()</span><br></pre></td></tr></table></figure><h2 id="自动登录12306"><a href="#自动登录12306" class="headerlink" title="自动登录12306"></a>自动登录12306</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="comment">#pillow</span></span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line"><span class="comment"># 引入超级鹰</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> chaojiying <span class="keyword">import</span> Chaojiying_Client</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> selenium.webdriver <span class="keyword">import</span> ActionChains</span><br><span class="line">bro=webdriver.Chrome(executable_path=<span class="string">'./chromedriver.exe'</span>)</span><br><span class="line">bro.implicitly_wait(<span class="number">10</span>)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    bro.get(<span class="string">'https://kyfw.12306.cn/otn/resources/login.html'</span>)</span><br><span class="line">    bro.maximize_window()  <span class="comment"># 窗口最大化，全屏</span></span><br><span class="line">    button_z=bro.find_element_by_css_selector(<span class="string">'.login-hd-account a'</span>)</span><br><span class="line">    button_z.click()</span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    <span class="comment"># 截取整个屏幕</span></span><br><span class="line">    bro.save_screenshot(<span class="string">'./main.png'</span>)</span><br><span class="line">    <span class="comment"># 验证码的位置和大小</span></span><br><span class="line">    img_t=bro.find_element_by_id(<span class="string">'J-loginImg'</span>)</span><br><span class="line">    print(img_t.size)</span><br><span class="line">    print(img_t.location)</span><br><span class="line"></span><br><span class="line">    size=img_t.size</span><br><span class="line">    location=img_t.location</span><br><span class="line"></span><br><span class="line">    img_tu = (int(location[<span class="string">'x'</span>]), int(location[<span class="string">'y'</span>]), int(location[<span class="string">'x'</span>] + size[<span class="string">'width'</span>]), int(location[<span class="string">'y'</span>] + size[<span class="string">'height'</span>]))</span><br><span class="line">    <span class="comment"># # 抠出验证码</span></span><br><span class="line">    <span class="comment"># #打开</span></span><br><span class="line">    img = Image.open(<span class="string">'./main.png'</span>)</span><br><span class="line">    <span class="comment"># 抠图</span></span><br><span class="line">    fram = img.crop(img_tu)</span><br><span class="line">    <span class="comment"># 截出来的小图</span></span><br><span class="line">    fram.save(<span class="string">'code.png'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 调用超级鹰破解</span></span><br><span class="line">    chaojiying = Chaojiying_Client(<span class="string">'306334678'</span>, <span class="string">'lqz12345'</span>, <span class="string">'903641'</span>)<span class="comment">#用户中心&gt;&gt;软件ID 生成一个替换 96001</span></span><br><span class="line">    im = open(<span class="string">'code.png'</span>, <span class="string">'rb'</span>).read()<span class="comment">#本地图片文件路径 来替换 a.jpg 有时WIN系统须要//</span></span><br><span class="line">    <span class="comment"># print(chaojiying.PostPic(im, 9004))</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">## 返回结果如果有多个 260,133|123，233,处理这种格式[[260,133],[123,233]]</span></span><br><span class="line">    res=chaojiying.PostPic(im, <span class="number">9004</span>)</span><br><span class="line">    print(res)</span><br><span class="line">    result=res[<span class="string">'pic_str'</span>]</span><br><span class="line"></span><br><span class="line">    all_list = []</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'|'</span> <span class="keyword">in</span> result:</span><br><span class="line">        list_1 = result.split(<span class="string">'|'</span>)</span><br><span class="line">        count_1 = len(list_1)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(count_1):</span><br><span class="line">            xy_list = []</span><br><span class="line">            x = int(list_1[i].split(<span class="string">','</span>)[<span class="number">0</span>])</span><br><span class="line">            y = int(list_1[i].split(<span class="string">','</span>)[<span class="number">1</span>])</span><br><span class="line">            xy_list.append(x)</span><br><span class="line">            xy_list.append(y)</span><br><span class="line">            all_list.append(xy_list)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        x = int(result.split(<span class="string">','</span>)[<span class="number">0</span>])</span><br><span class="line">        y = int(result.split(<span class="string">','</span>)[<span class="number">1</span>])</span><br><span class="line">        xy_list = []</span><br><span class="line">        xy_list.append(x)</span><br><span class="line">        xy_list.append(y)</span><br><span class="line">        all_list.append(xy_list)</span><br><span class="line">    print(all_list)</span><br><span class="line">    <span class="comment"># 用动作链，点击图片</span></span><br><span class="line">    <span class="comment"># [[260,133],[123,233]]</span></span><br><span class="line">    <span class="keyword">for</span> a <span class="keyword">in</span> all_list:</span><br><span class="line">        x = a[<span class="number">0</span>]</span><br><span class="line">        y = a[<span class="number">1</span>]</span><br><span class="line">        ActionChains(bro).move_to_element_with_offset(img_t, x, y).click().perform()</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    username=bro.find_element_by_id(<span class="string">'J-userName'</span>)</span><br><span class="line">    username.send_keys(<span class="string">'306334678'</span>)</span><br><span class="line">    password=bro.find_element_by_id(<span class="string">'J-password'</span>)</span><br><span class="line">    password.send_keys(<span class="string">'lqz12345'</span>)</span><br><span class="line">    time.sleep(<span class="number">3</span>)</span><br><span class="line">    submit_login=bro.find_element_by_id(<span class="string">'J-login'</span>)</span><br><span class="line">    submit_login.click()</span><br><span class="line">    time.sleep(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    print(bro.get_cookies())</span><br><span class="line">    time.sleep(<span class="number">10</span>)</span><br><span class="line">    bro.get(<span class="string">'https://www.12306.cn/index/'</span>)</span><br><span class="line">    time.sleep(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    print(e)</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    bro.close()</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;爬取拉勾网&quot;&gt;&lt;a href=&quot;#爬取拉勾网&quot; class=&quot;headerlink&quot; title=&quot;爬取拉勾网&quot;&gt;&lt;/a&gt;爬取拉勾网&lt;/h2&gt;&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter
      
    
    </summary>
    
    
    
      <category term="爬虫" scheme="http://yoursite.com/tags/%E7%88%AC%E8%99%AB/"/>
    
  </entry>
  
  <entry>
    <title>srapy的高级使用</title>
    <link href="http://yoursite.com/2019/11/08/srapy%E7%9A%84%E9%AB%98%E7%BA%A7%E4%BD%BF%E7%94%A8/"/>
    <id>http://yoursite.com/2019/11/08/srapy%E7%9A%84%E9%AB%98%E7%BA%A7%E4%BD%BF%E7%94%A8/</id>
    <published>2019-11-07T16:00:00.000Z</published>
    <updated>2020-08-20T12:15:45.357Z</updated>
    
    <content type="html"><![CDATA[<h2 id="srapy的高级使用"><a href="#srapy的高级使用" class="headerlink" title="srapy的高级使用"></a>srapy的高级使用</h2><h2 id="1-自动给抽屉点赞"><a href="#1-自动给抽屉点赞" class="headerlink" title="1 自动给抽屉点赞"></a>1 自动给抽屉点赞</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">bro=webdriver.Chrome(executable_path=<span class="string">'./chromedriver.exe'</span>)</span><br><span class="line">bro.implicitly_wait(<span class="number">10</span>)</span><br><span class="line">bro.get(<span class="string">'https://dig.chouti.com/'</span>)</span><br><span class="line"></span><br><span class="line">login_b=bro.find_element_by_id(<span class="string">'login_btn'</span>)</span><br><span class="line">print(login_b)</span><br><span class="line">login_b.click()</span><br><span class="line"></span><br><span class="line">username=bro.find_element_by_name(<span class="string">'phone'</span>)</span><br><span class="line">username.send_keys(<span class="string">'18953675221'</span>)</span><br><span class="line">password=bro.find_element_by_name(<span class="string">'password'</span>)</span><br><span class="line">password.send_keys(<span class="string">'lqz123'</span>)</span><br><span class="line"></span><br><span class="line">button=bro.find_element_by_css_selector(<span class="string">'button.login-btn'</span>)</span><br><span class="line">button.click()</span><br><span class="line"><span class="comment"># 可能有验证码，手动操作一下</span></span><br><span class="line">time.sleep(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">my_cookie=bro.get_cookies()  <span class="comment"># 列表</span></span><br><span class="line">print(my_cookie)</span><br><span class="line">bro.close()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这个cookie不是一个字典，不能直接给requests使用，需要转一下</span></span><br><span class="line">cookie=&#123;&#125;</span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> my_cookie:</span><br><span class="line">    cookie[item[<span class="string">'name'</span>]]=item[<span class="string">'value'</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">'User-Agent'</span>: <span class="string">'Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.105 Safari/537.36'</span>,</span><br><span class="line">    <span class="string">'Referer'</span>: <span class="string">'https://dig.chouti.com/'</span>&#125;</span><br><span class="line"><span class="comment"># ret = requests.get('https://dig.chouti.com/',headers=headers)</span></span><br><span class="line"><span class="comment"># print(ret.text)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ret=requests.get(<span class="string">'https://dig.chouti.com/top/24hr?_=1596677637670'</span>,headers=headers)</span><br><span class="line">print(ret.json())</span><br><span class="line">ll=[]</span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> ret.json()[<span class="string">'data'</span>]:</span><br><span class="line">    ll.append(item[<span class="string">'id'</span>])</span><br><span class="line"></span><br><span class="line">print(ll)</span><br><span class="line"><span class="keyword">for</span> id <span class="keyword">in</span> ll:</span><br><span class="line">    ret=requests.post(<span class="string">' https://dig.chouti.com/link/vote'</span>,headers=headers,cookies=cookie,data=&#123;<span class="string">'linkId'</span>:id&#125;)</span><br><span class="line">    print(ret.text)</span><br><span class="line"></span><br><span class="line"><span class="string">'https://dig.chouti.com/comments/create'</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">content: 说的号</span></span><br><span class="line"><span class="string">linkId: 29829529</span></span><br><span class="line"><span class="string">parentId: 0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure><h2 id="3-scrapy的请求传参"><a href="#3-scrapy的请求传参" class="headerlink" title="3 scrapy的请求传参"></a>3 scrapy的请求传参</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 把要传递的数据放到meta中</span></span><br><span class="line"><span class="keyword">yield</span> Request(urlmeta=&#123;<span class="string">'item'</span>:item&#125;)</span><br><span class="line"><span class="comment"># 在response对象中取出来</span></span><br><span class="line">item=response.meta.get(<span class="string">'item'</span>)</span><br></pre></td></tr></table></figure><h2 id="4-提升scrapy爬取数据的效率"><a href="#4-提升scrapy爬取数据的效率" class="headerlink" title="4 提升scrapy爬取数据的效率"></a>4 提升scrapy爬取数据的效率</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- 在配置文件中进行相关的配置即可:(默认还有一套setting)</span><br><span class="line"><span class="comment">#1 增加并发：</span></span><br><span class="line">默认scrapy开启的并发线程为<span class="number">32</span>个，可以适当进行增加。在settings配置文件中修改CONCURRENT_REQUESTS = <span class="number">100</span>值为<span class="number">100</span>,并发设置成了为<span class="number">100</span>。</span><br><span class="line"><span class="comment">#2 降低日志级别：</span></span><br><span class="line">在运行scrapy时，会有大量日志信息的输出，为了减少CPU的使用率。可以设置log输出信息为INFO或者ERROR即可。在配置文件中编写：LOG_LEVEL = ‘INFO’</span><br><span class="line"><span class="comment"># 3 禁止cookie：</span></span><br><span class="line">如果不是真的需要cookie，则在scrapy爬取数据时可以禁止cookie从而减少CPU的使用率，提升爬取效率。在配置文件中编写：COOKIES_ENABLED = <span class="literal">False</span></span><br><span class="line"><span class="comment"># 4禁止重试：</span></span><br><span class="line">对失败的HTTP进行重新请求（重试）会减慢爬取速度，因此可以禁止重试。在配置文件中编写：RETRY_ENABLED = <span class="literal">False</span></span><br><span class="line"><span class="comment"># 5 减少下载超时：</span></span><br><span class="line">如果对一个非常慢的链接进行爬取，减少下载超时可以能让卡住的链接快速被放弃，从而提升效率。在配置文件中进行编写：DOWNLOAD_TIMEOUT = <span class="number">10</span> 超时时间为<span class="number">10</span>s</span><br></pre></td></tr></table></figure><h2 id="5-scrapy的中间件（下载中间件）"><a href="#5-scrapy的中间件（下载中间件）" class="headerlink" title="5 scrapy的中间件（下载中间件）"></a>5 scrapy的中间件（下载中间件）</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1 都写在middlewares.py</span></span><br><span class="line"><span class="comment"># 2 爬虫中间件</span></span><br><span class="line"><span class="comment"># 3 下载中间件</span></span><br><span class="line"><span class="comment"># 4 要生效，一定要配置，配置文件</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载中间件</span></span><br><span class="line">-process_request：返回不同的对象，后续处理不同（加代理...）</span><br><span class="line">  <span class="comment"># 1 更换请求头</span></span><br><span class="line">        <span class="comment"># print(type(request.headers))</span></span><br><span class="line">        <span class="comment"># print(request.headers)</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="comment"># from scrapy.http.headers import Headers</span></span><br><span class="line">        <span class="comment"># request.headers['User-Agent']=''</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 2 加cookie ---cookie池</span></span><br><span class="line">        <span class="comment"># 假设你你已经搭建好cookie 池了，</span></span><br><span class="line">        <span class="comment"># print('00000--',request.cookies)</span></span><br><span class="line">        <span class="comment"># request.cookies=&#123;'username':'asdfasdf'&#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 3 加代理</span></span><br><span class="line">        <span class="comment"># print(request.meta)</span></span><br><span class="line">        <span class="comment"># request.meta['download_timeout'] = 20</span></span><br><span class="line">        <span class="comment"># request.meta["proxy"] = 'http://27.188.62.3:8060'</span></span><br><span class="line">-process_response：返回不同的对象，后续处理不同</span><br><span class="line">- process_exception</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">process_exception</span><span class="params">(self, request, exception, spider)</span>:</span></span><br><span class="line">        print(<span class="string">'xxxx'</span>)</span><br><span class="line">        <span class="comment"># 不允许直接改url</span></span><br><span class="line">        <span class="comment"># request.url='https://www.baidu.com'</span></span><br><span class="line">        <span class="keyword">from</span> scrapy <span class="keyword">import</span> Request</span><br><span class="line">        request=Request(url=<span class="string">'https://www.baidu.com'</span>,callback=spider.parser)</span><br><span class="line">        <span class="keyword">return</span> request</span><br></pre></td></tr></table></figure><h2 id="6-selenium在scrapy中的使用流程"><a href="#6-selenium在scrapy中的使用流程" class="headerlink" title="6 selenium在scrapy中的使用流程"></a>6 selenium在scrapy中的使用流程</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 当前爬虫用的selenium是同一个</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1 在爬虫中初始化webdriver对象</span></span><br><span class="line">    <span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">CnblogSpider</span><span class="params">(scrapy.Spider)</span>:</span></span><br><span class="line">        name = <span class="string">'cnblog'</span></span><br><span class="line">        ...</span><br><span class="line"> bro=webdriver.Chrome(executable_path=<span class="string">'../chromedriver.exe'</span>)</span><br><span class="line"><span class="comment"># 2 在中间件中使用（process_request）</span></span><br><span class="line">spider.bro.get(<span class="string">'https://dig.chouti.com/'</span>)   response=HtmlResponse(url=<span class="string">'https://dig.chouti.com/'</span>,body=spider.bro.page_source.encode(<span class="string">'utf-8'</span>),request=request)</span><br><span class="line">    <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3 在爬虫中关闭</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">close</span><span class="params">(self, reason)</span>:</span></span><br><span class="line">        print(<span class="string">"我结束了"</span>)</span><br><span class="line">        self.bro.close()</span><br></pre></td></tr></table></figure><h2 id="7-去重规则源码分析"><a href="#7-去重规则源码分析" class="headerlink" title="7 去重规则源码分析"></a>7 去重规则源码分析</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 详见代码</span></span><br></pre></td></tr></table></figure><h2 id="8-分布式爬虫（scrapy-redis）"><a href="#8-分布式爬虫（scrapy-redis）" class="headerlink" title="8 分布式爬虫（scrapy-redis）"></a>8 分布式爬虫（scrapy-redis）</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1 pip3 install scrapy-redis</span></span><br><span class="line"><span class="comment"># 2 原来继承Spider，现在继承RedisSpider</span></span><br><span class="line"><span class="comment"># 3 不能写start_urls = ['https:/www.cnblogs.com/']</span></span><br><span class="line"><span class="comment"># 4 需要写redis_key = 'myspider:start_urls'</span></span><br><span class="line"><span class="comment"># 5 setting中配置：</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># redis的连接</span></span><br><span class="line">REDIS_HOST = <span class="string">'localhost'</span>                            <span class="comment"># 主机名</span></span><br><span class="line">REDIS_PORT = <span class="number">6379</span>                                   <span class="comment"># 端口</span></span><br><span class="line"><span class="comment"># 使用scrapy-redis的去重</span></span><br><span class="line">DUPEFILTER_CLASS = <span class="string">"scrapy_redis.dupefilter.RFPDupeFilter"</span></span><br><span class="line"><span class="comment"># 使用scrapy-redis的Scheduler</span></span><br><span class="line"><span class="comment"># 分布式爬虫的配置</span></span><br><span class="line">SCHEDULER = <span class="string">"scrapy_redis.scheduler.Scheduler"</span></span><br><span class="line"><span class="comment"># 持久化的可以配置，也可以不配置</span></span><br><span class="line">ITEM_PIPELINES = &#123;</span><br><span class="line">   <span class="string">'scrapy_redis.pipelines.RedisPipeline'</span>: <span class="number">299</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 9现在要让爬虫运行起来，需要去redis中以myspider:start_urls为key，插入一个起始地址lpush myspider:start_urls https://www.cnblogs.com/</span></span><br></pre></td></tr></table></figure><h2 id="9-破解知乎登陆-js逆向和解密"><a href="#9-破解知乎登陆-js逆向和解密" class="headerlink" title="9 破解知乎登陆(js逆向和解密)"></a>9 破解知乎登陆(js逆向和解密)</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">client_id=c3cef7c66a1843f8b3a9e6a1e3160e20&amp;</span><br><span class="line">grant_type=password&amp;</span><br><span class="line">timestamp=<span class="number">1596702006088</span>&amp;</span><br><span class="line">source=com.zhihu.web&amp;</span><br><span class="line">signature=eac4a6c461f9edf86ef33ef950c7b6aa426dbb39&amp;</span><br><span class="line">username=%<span class="number">2</span>B86liuqingzheng&amp;</span><br><span class="line">password=<span class="number">1111111</span>&amp;</span><br><span class="line">captcha=&amp;</span><br><span class="line">lang=en&amp;</span><br><span class="line">utm_source=&amp;</span><br><span class="line">ref_source=other_https%<span class="number">3</span>A%<span class="number">2</span>F%<span class="number">2</span>Fwww.zhihu.com%<span class="number">2</span>Fsignin%<span class="number">3</span>Fnext%<span class="number">3</span>D%<span class="number">252</span>F<span class="string">"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 破解知乎登陆</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">import requests    #请求解析库</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">import base64  #base64解密加密库</span></span><br><span class="line"><span class="string">from PIL import Image        #图片处理库</span></span><br><span class="line"><span class="string">import hmac  #加密库</span></span><br><span class="line"><span class="string">from hashlib import sha1  #加密库</span></span><br><span class="line"><span class="string">import time</span></span><br><span class="line"><span class="string">from urllib.parse import urlencode  #url编码库</span></span><br><span class="line"><span class="string">import execjs  #python调用node.js</span></span><br><span class="line"><span class="string">from http import cookiejar as cookielib</span></span><br><span class="line"><span class="string">class Spider():</span></span><br><span class="line"><span class="string">    def __init__(self):</span></span><br><span class="line"><span class="string">        self.session = requests.session()</span></span><br><span class="line"><span class="string">        self.session.cookies = cookielib.LWPCookieJar()    #使cookie可以调用save和load方法</span></span><br><span class="line"><span class="string">        self.login_page_url = 'https://www.zhihu.com/signin?next=%2F'</span></span><br><span class="line"><span class="string">        self.login_api = 'https://www.zhihu.com/api/v3/oauth/sign_in'</span></span><br><span class="line"><span class="string">        self.captcha_api = 'https://www.zhihu.com/api/v3/oauth/captcha?lang=en'</span></span><br><span class="line"><span class="string">        self.headers = &#123;</span></span><br><span class="line"><span class="string">            'user-agent':'Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/57.0.2987.98 Safari/537.36 LBBROWSER',</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        self.captcha =''         #存验证码</span></span><br><span class="line"><span class="string">        self.signature = ''   #存签名</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    # 首次请求获取cookie</span></span><br><span class="line"><span class="string">    def get_base_cookie(self):</span></span><br><span class="line"><span class="string">        self.session.get(url=self.login_page_url, headers=self.headers)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    def deal_captcha(self):</span></span><br><span class="line"><span class="string">        r = self.session.get(url=self.captcha_api, headers=self.headers)</span></span><br><span class="line"><span class="string">        r = r.json()</span></span><br><span class="line"><span class="string">        if r.get('show_captcha'):</span></span><br><span class="line"><span class="string">            while True:</span></span><br><span class="line"><span class="string">                r = self.session.put(url=self.captcha_api, headers=self.headers)</span></span><br><span class="line"><span class="string">                img_base64 = r.json().get('img_base64')</span></span><br><span class="line"><span class="string">                with open('captcha.png', 'wb') as f:</span></span><br><span class="line"><span class="string">                    f.write(base64.b64decode(img_base64))</span></span><br><span class="line"><span class="string">                captcha_img = Image.open('captcha.png')</span></span><br><span class="line"><span class="string">                captcha_img.show()</span></span><br><span class="line"><span class="string">                self.captcha = input('输入验证码:')</span></span><br><span class="line"><span class="string">                r = self.session.post(url=self.captcha_api, data=&#123;'input_text': self.captcha&#125;,</span></span><br><span class="line"><span class="string">                                      headers=self.headers)</span></span><br><span class="line"><span class="string">                if r.json().get('success'):</span></span><br><span class="line"><span class="string">                    break</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    def get_signature(self):</span></span><br><span class="line"><span class="string">        # 生成加密签名</span></span><br><span class="line"><span class="string">        a = hmac.new(b'd1b964811afb40118a12068ff74a12f4', digestmod=sha1)</span></span><br><span class="line"><span class="string">        a.update(b'password')</span></span><br><span class="line"><span class="string">        a.update(b'c3cef7c66a1843f8b3a9e6a1e3160e20')</span></span><br><span class="line"><span class="string">        a.update(b'com.zhihu.web')</span></span><br><span class="line"><span class="string">        a.update(str(int(time.time() * 1000)).encode('utf-8'))</span></span><br><span class="line"><span class="string">        self.signature = a.hexdigest()</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    def post_login_data(self):</span></span><br><span class="line"><span class="string">        data = &#123;</span></span><br><span class="line"><span class="string">            'client_id': 'c3cef7c66a1843f8b3a9e6a1e3160e20',</span></span><br><span class="line"><span class="string">            'grant_type': 'password',</span></span><br><span class="line"><span class="string">            'timestamp': str(int(time.time() * 1000)),</span></span><br><span class="line"><span class="string">            'source': 'com.zhihu.web',</span></span><br><span class="line"><span class="string">            'signature': self.signature,</span></span><br><span class="line"><span class="string">            'username': '+8618953675221',</span></span><br><span class="line"><span class="string">            'password': '',</span></span><br><span class="line"><span class="string">            'captcha': self.captcha,</span></span><br><span class="line"><span class="string">            'lang': 'en',</span></span><br><span class="line"><span class="string">            'utm_source': '',</span></span><br><span class="line"><span class="string">            'ref_source': 'other_https://www.zhihu.com/signin?next=%2F',</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        headers = &#123;</span></span><br><span class="line"><span class="string">            'x-zse-83': '3_2.0',</span></span><br><span class="line"><span class="string">            'content-type': 'application/x-www-form-urlencoded',</span></span><br><span class="line"><span class="string">            'user-agent': 'Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/57.0.2987.98 Safari/537.36 LBBROWSER',</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        data = urlencode(data)</span></span><br><span class="line"><span class="string">        with open('zhih.js', 'rt', encoding='utf-8') as f:</span></span><br><span class="line"><span class="string">            js = execjs.compile(f.read(), cwd='node_modules')</span></span><br><span class="line"><span class="string">        data = js.call('b', data)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        r = self.session.post(url=self.login_api, headers=headers, data=data)</span></span><br><span class="line"><span class="string">        print(r.text)</span></span><br><span class="line"><span class="string">        if r.status_code == 201:</span></span><br><span class="line"><span class="string">            self.session.cookies.save('mycookie')</span></span><br><span class="line"><span class="string">            print('登录成功')</span></span><br><span class="line"><span class="string">        else:</span></span><br><span class="line"><span class="string">            print('登录失败')</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    def login(self):</span></span><br><span class="line"><span class="string">        self.get_base_cookie()</span></span><br><span class="line"><span class="string">        self.deal_captcha()</span></span><br><span class="line"><span class="string">        self.get_signature()</span></span><br><span class="line"><span class="string">        self.post_login_data()</span></span><br><span class="line"><span class="string">if __name__ == '__main__':</span></span><br><span class="line"><span class="string">    zhihu_spider = Spider()</span></span><br><span class="line"><span class="string">    zhihu_spider.login()</span></span><br></pre></td></tr></table></figure><h2 id="10-爬虫的反扒措施"><a href="#10-爬虫的反扒措施" class="headerlink" title="10 爬虫的反扒措施"></a>10 爬虫的反扒措施</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> user-agent</span><br><span class="line"><span class="number">2</span> referer</span><br><span class="line"><span class="number">3</span> cookie（cookie池，先访问一次）</span><br><span class="line"><span class="number">4</span> 频率限制（代理池，延迟）</span><br><span class="line"><span class="number">5</span> js加密（扣出来，exjs模块指向）</span><br><span class="line"><span class="number">6</span> css加密</span><br><span class="line"><span class="number">7</span> 验证码（打码平台），半手动</span><br><span class="line"><span class="number">8</span> 图片懒加载</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">热更新：不停机更新</span><br><span class="line"></span><br><span class="line">https://www.cnblogs.com/deali/p/<span class="number">13372922.</span>html</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;srapy的高级使用&quot;&gt;&lt;a href=&quot;#srapy的高级使用&quot; class=&quot;headerlink&quot; title=&quot;srapy的高级使用&quot;&gt;&lt;/a&gt;srapy的高级使用&lt;/h2&gt;&lt;h2 id=&quot;1-自动给抽屉点赞&quot;&gt;&lt;a href=&quot;#1-自动给抽屉点赞&quot; c
      
    
    </summary>
    
    
    
      <category term="爬虫" scheme="http://yoursite.com/tags/%E7%88%AC%E8%99%AB/"/>
    
  </entry>
  
  <entry>
    <title>selenium使用</title>
    <link href="http://yoursite.com/2019/11/07/selenium%E4%BD%BF%E7%94%A8/"/>
    <id>http://yoursite.com/2019/11/07/selenium%E4%BD%BF%E7%94%A8/</id>
    <published>2019-11-06T16:00:00.000Z</published>
    <updated>2020-08-20T12:15:08.652Z</updated>
    
    <content type="html"><![CDATA[<h2 id="selenium使用"><a href="#selenium使用" class="headerlink" title="selenium使用"></a>selenium使用</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 为了解决requests无法直接执行JavaScript代码的问题 </span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># pip3 install selenium</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 浏览器驱动:http://npm.taobao.org/mirrors/chromedriver/</span></span><br><span class="line"><span class="comment"># 驱动要跟浏览器版本对应  84.0.4147.105：驱动用84.0.4147.30/</span></span><br><span class="line"><span class="comment"># 下载完解压就是个exe（不同平台的可执行文件）</span></span><br><span class="line"><span class="comment"># from selenium import webdriver</span></span><br><span class="line"><span class="comment"># import time</span></span><br><span class="line"><span class="comment"># # bro=webdriver.Chrome()  # 得到一个谷歌浏览器对象，</span></span><br><span class="line"><span class="comment"># # 指定使用跟那个驱动</span></span><br><span class="line"><span class="comment"># bro=webdriver.Chrome(executable_path='./chromedriver.exe') # 得到一个谷歌浏览器对象，</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># time.sleep(2)</span></span><br><span class="line"><span class="comment"># bro.get('https://www.baidu.com/')  # 在地址栏里输入了百度</span></span><br><span class="line"><span class="comment"># time.sleep(2)</span></span><br><span class="line"><span class="comment"># print(bro.page_source)</span></span><br><span class="line"><span class="comment"># time.sleep(2)</span></span><br><span class="line"><span class="comment"># bro.close()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 模拟登陆百度</span></span><br><span class="line"><span class="comment"># from selenium import webdriver</span></span><br><span class="line"><span class="comment"># import time</span></span><br><span class="line"><span class="comment"># bro=webdriver.Chrome(executable_path='./chromedriver.exe')</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># bro.get('https://www.baidu.com/')</span></span><br><span class="line"><span class="comment"># time.sleep(0.01)</span></span><br><span class="line"><span class="comment"># input_k=bro.find_element_by_id('kw')</span></span><br><span class="line"><span class="comment"># input_k.send_keys('美女')  # 在框里写入美女</span></span><br><span class="line"><span class="comment"># time.sleep(2)</span></span><br><span class="line"><span class="comment"># sou=bro.find_element_by_id('su')  # 找到搜索按钮</span></span><br><span class="line"><span class="comment"># sou.click() # 点击搜索按钮</span></span><br><span class="line"><span class="comment"># time.sleep(4)</span></span><br><span class="line"><span class="comment"># bro.close()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># from selenium import webdriver</span></span><br><span class="line"><span class="comment"># import time</span></span><br><span class="line"><span class="comment"># bro=webdriver.Chrome(executable_path='./chromedriver.exe')</span></span><br><span class="line"><span class="comment"># bro.implicitly_wait(5)  # 隐士等待：找一个控件，如果控件没有加载出来，等待5s中  等待所有，只需要写着一句，以后找所有控件都按这个操作来</span></span><br><span class="line"><span class="comment"># bro.get('https://www.baidu.com/')</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># d_button=bro.find_element_by_link_text('登录')</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># d_button.click()</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># login_u=bro.find_element_by_id('TANGRAM__PSP_11__footerULoginBtn')</span></span><br><span class="line"><span class="comment"># login_u.click()</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># username=bro.find_element_by_id('TANGRAM__PSP_11__userName')</span></span><br><span class="line"><span class="comment"># username.send_keys('yxp654799481')</span></span><br><span class="line"><span class="comment"># password=bro.find_element_by_id('TANGRAM__PSP_11__password')</span></span><br><span class="line"><span class="comment"># password.send_keys('yxp997997')</span></span><br><span class="line"><span class="comment"># time.sleep(3)</span></span><br><span class="line"><span class="comment"># submit=bro.find_element_by_id('TANGRAM__PSP_11__submit')</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># submit.click()</span></span><br><span class="line"><span class="comment"># time.sleep(10)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># print(bro.get_cookies())</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># bro.close()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ##############选择器（find系列）</span></span><br><span class="line"><span class="comment"># ===============所有方法===================</span></span><br><span class="line"><span class="comment"># 1、find_element_by_id   # 通过id查找控件</span></span><br><span class="line"><span class="comment"># 2、find_element_by_link_text  # 通过a标签内容找</span></span><br><span class="line"><span class="comment"># 3、find_element_by_partial_link_text  # 通过a标签内容找，模糊匹配</span></span><br><span class="line"><span class="comment"># 4、find_element_by_tag_name   # 标签名</span></span><br><span class="line"><span class="comment"># 5、find_element_by_class_name  # 类名</span></span><br><span class="line"><span class="comment"># 6、find_element_by_name      # name属性</span></span><br><span class="line"><span class="comment"># 7、find_element_by_css_selector  # 通过css选择器</span></span><br><span class="line"><span class="comment"># 8、find_element_by_xpath       # 通过xpaht选择器</span></span><br><span class="line"><span class="comment"># 强调：</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1、find_elements_by_xxx的形式是查找到多个元素，结果为列表</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取元素属性</span></span><br><span class="line"><span class="comment"># 重点</span></span><br><span class="line"><span class="comment"># tag.get_attribute('href')  # 找当前控件 的href属性对的值</span></span><br><span class="line"><span class="comment"># tag.text   # 获取文本内容</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 了解</span></span><br><span class="line"><span class="comment"># print(tag.id)   # 当前控件id号</span></span><br><span class="line"><span class="comment"># print(tag.location)  # 当前控件在页面位置</span></span><br><span class="line"><span class="comment"># print(tag.tag_name)  # 标签名</span></span><br><span class="line"><span class="comment"># print(tag.size)      #标签的大小</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">####无界面浏览器（phantomjs）</span></span><br><span class="line"><span class="comment">#谷歌浏览器支持不打开页面</span></span><br><span class="line"><span class="comment"># from selenium.webdriver.chrome.options import Options</span></span><br><span class="line"><span class="comment"># from selenium import webdriver</span></span><br><span class="line"><span class="comment"># chrome_options = Options()</span></span><br><span class="line"><span class="comment"># chrome_options.add_argument('window-size=1920x3000') #指定浏览器分辨率</span></span><br><span class="line"><span class="comment"># chrome_options.add_argument('--disable-gpu') #谷歌文档提到需要加上这个属性来规避bug</span></span><br><span class="line"><span class="comment"># chrome_options.add_argument('--hide-scrollbars') #隐藏滚动条, 应对一些特殊页面</span></span><br><span class="line"><span class="comment"># chrome_options.add_argument('blink-settings=imagesEnabled=false') #不加载图片, 提升速度</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># chrome_options.add_argument('--headless') #浏览器不提供可视化页面. linux下如果系统不支持可视化不加这条会启动失败</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># bro=webdriver.Chrome(chrome_options=chrome_options,executable_path='./chromedriver.exe')</span></span><br><span class="line"><span class="comment"># bro.get('https://www.baidu.com/')</span></span><br><span class="line"><span class="comment"># print(bro.page_source)</span></span><br><span class="line"><span class="comment"># bro.close()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">######元素交互</span></span><br><span class="line"><span class="comment"># tag.send_keys()  # 往里面写内容</span></span><br><span class="line"><span class="comment"># tag.click()      # 点击控件</span></span><br><span class="line"><span class="comment"># tag.clear()      # 清空控件内容</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#####执行js(有什么用?)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># from selenium import webdriver</span></span><br><span class="line"><span class="comment"># import time</span></span><br><span class="line"><span class="comment"># bro=webdriver.Chrome(executable_path='./chromedriver.exe')</span></span><br><span class="line"><span class="comment"># bro.implicitly_wait(5)  # 隐士等待：找一个控件，如果控件没有加载出来，等待5s中  等待所有，只需要写着一句，以后找所有控件都按这个操作来</span></span><br><span class="line"><span class="comment"># bro.get('https://www.baidu.com/')</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># bro.execute_script('window.open()')</span></span><br><span class="line"><span class="comment"># bro.execute_script('window.open()')</span></span><br><span class="line"><span class="comment"># time.sleep(2)</span></span><br><span class="line"><span class="comment"># bro.close()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">####模拟浏览器前进后退</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># from selenium import webdriver</span></span><br><span class="line"><span class="comment"># import time</span></span><br><span class="line"><span class="comment"># browser=webdriver.Chrome(executable_path='./chromedriver.exe')</span></span><br><span class="line"><span class="comment"># browser.get('https://www.baidu.com')</span></span><br><span class="line"><span class="comment"># browser.get('https://www.taobao.com')</span></span><br><span class="line"><span class="comment"># browser.get('http://www.sina.com.cn/')</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># browser.back()</span></span><br><span class="line"><span class="comment"># time.sleep(1)</span></span><br><span class="line"><span class="comment"># browser.forward()</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># browser.close()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#####获取cookie</span></span><br><span class="line"><span class="comment"># bro.get_cookies()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#### 选项卡管理(了解)</span></span><br><span class="line"><span class="comment"># from selenium import webdriver</span></span><br><span class="line"><span class="comment"># import time</span></span><br><span class="line"><span class="comment"># browser=webdriver.Chrome()</span></span><br><span class="line"><span class="comment"># browser.get('https://www.baidu.com')</span></span><br><span class="line"><span class="comment"># browser.execute_script('window.open()')</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># print(browser.window_handles) #获取所有的选项卡</span></span><br><span class="line"><span class="comment"># browser.switch_to_window(browser.window_handles[1])</span></span><br><span class="line"><span class="comment"># browser.get('https://www.taobao.com')</span></span><br><span class="line"><span class="comment"># time.sleep(2)</span></span><br><span class="line"><span class="comment"># browser.switch_to_window(browser.window_handles[0])</span></span><br><span class="line"><span class="comment"># browser.get('https://www.sina.com.cn')</span></span><br><span class="line"><span class="comment"># browser.close()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##### 异常处理</span></span><br><span class="line"><span class="comment"># from selenium import webdriver</span></span><br><span class="line"><span class="comment"># from selenium.common.exceptions import TimeoutException,NoSuchElementException,NoSuchFrameException</span></span><br><span class="line"><span class="comment"># browser=webdriver.Chrome()</span></span><br><span class="line"><span class="comment"># try:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#     browser.get('')</span></span><br><span class="line"><span class="comment"># except Exception as e:</span></span><br><span class="line"><span class="comment">#     print(e)</span></span><br><span class="line"><span class="comment"># finally:</span></span><br><span class="line"><span class="comment">#     # 无论是否出异常，最终都要关掉</span></span><br><span class="line"><span class="comment">#     browser.close()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#####动作链（）</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#### 如何把屏幕拉倒最后（js控制）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># bro.execute_script('window.scrollTo(0,document.body.offsetHeight)')</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;selenium使用&quot;&gt;&lt;a href=&quot;#selenium使用&quot; class=&quot;headerlink&quot; title=&quot;selenium使用&quot;&gt;&lt;/a&gt;selenium使用&lt;/h2&gt;&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;
      
    
    </summary>
    
    
    
      <category term="爬虫" scheme="http://yoursite.com/tags/%E7%88%AC%E8%99%AB/"/>
    
  </entry>
  
  <entry>
    <title>xpath</title>
    <link href="http://yoursite.com/2019/11/07/xpath/"/>
    <id>http://yoursite.com/2019/11/07/xpath/</id>
    <published>2019-11-06T16:00:00.000Z</published>
    <updated>2020-08-20T12:16:11.667Z</updated>
    
    <content type="html"><![CDATA[<h2 id="xpath"><a href="#xpath" class="headerlink" title="xpath"></a>xpath</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># xpath: XPath 是一门在 XML 文档中查找信息的语言</span></span><br><span class="line"><span class="comment"># / :从根节点选取。</span></span><br><span class="line"><span class="comment"># // :不管位置，直接找</span></span><br><span class="line"><span class="comment"># /@属性名</span></span><br><span class="line"><span class="comment"># /text()</span></span><br><span class="line"><span class="comment"># 会复制（）</span></span><br><span class="line"></span><br><span class="line">doc=<span class="string">'''</span></span><br><span class="line"><span class="string">&lt;html&gt;</span></span><br><span class="line"><span class="string"> &lt;head&gt;</span></span><br><span class="line"><span class="string">  &lt;base href='http://example.com/' /&gt;</span></span><br><span class="line"><span class="string">  &lt;title&gt;Example website&lt;/title&gt;</span></span><br><span class="line"><span class="string"> &lt;/head&gt;</span></span><br><span class="line"><span class="string"> &lt;body&gt;</span></span><br><span class="line"><span class="string">  &lt;div id='images'&gt;</span></span><br><span class="line"><span class="string">   &lt;a href='image1.html' aa='bb'&gt;Name: My image 1 &lt;br /&gt;&lt;img src='image1_thumb.jpg' /&gt;&lt;/a&gt;</span></span><br><span class="line"><span class="string">   &lt;a href='image2.html'&gt;Name: My image 2 &lt;br /&gt;&lt;img src='image2_thumb.jpg' /&gt;&lt;/a&gt;</span></span><br><span class="line"><span class="string">   &lt;a href='image3.html'&gt;Name: My image 3 &lt;br /&gt;&lt;img src='image3_thumb.jpg' /&gt;&lt;/a&gt;</span></span><br><span class="line"><span class="string">   &lt;a href='image4.html'&gt;Name: My image 4 &lt;br /&gt;&lt;img src='image4_thumb.jpg' /&gt;&lt;/a&gt;</span></span><br><span class="line"><span class="string">   &lt;a href='image5.html' class='li li-item' name='items'&gt;Name: My image 5 &lt;br /&gt;&lt;img src='image5_thumb.jpg' /&gt;&lt;/a&gt;</span></span><br><span class="line"><span class="string">   &lt;a href='image6.html' name='items'&gt;&lt;span&gt;&lt;h5&gt;test&lt;/h5&gt;&lt;/span&gt;Name: My image 6 &lt;br /&gt;&lt;img src='image6_thumb.jpg' /&gt;&lt;/a&gt;</span></span><br><span class="line"><span class="string">  &lt;/div&gt;</span></span><br><span class="line"><span class="string"> &lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"></span><br><span class="line">html=etree.HTML(doc)</span><br><span class="line"><span class="comment"># html=etree.parse('search.html',etree.HTMLParser())</span></span><br><span class="line"><span class="comment"># 1 所有节点</span></span><br><span class="line"><span class="comment"># a=html.xpath('//*')</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2 指定节点（结果为列表）</span></span><br><span class="line"><span class="comment"># a=html.xpath('//head')</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3 子节点，子孙节点</span></span><br><span class="line"><span class="comment"># a=html.xpath('//div/a')</span></span><br><span class="line"><span class="comment"># a=html.xpath('//body/a') #无数据</span></span><br><span class="line"><span class="comment"># a=html.xpath('//body//a')</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4 父节点</span></span><br><span class="line"><span class="comment"># a=html.xpath('//body//a[@href="image1.html"]/..')</span></span><br><span class="line"><span class="comment"># a=html.xpath('//body//a[1]/..')</span></span><br><span class="line"><span class="comment"># 也可以这样</span></span><br><span class="line"><span class="comment"># a=html.xpath('//body//a[1]/parent::*')</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5 属性匹配</span></span><br><span class="line"><span class="comment"># a=html.xpath('//body//a[@href="image1.html"]')</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 6 文本获取(重要)  /text() 取当前标签的文本</span></span><br><span class="line"><span class="comment"># a=html.xpath('//body//a[@href="image1.html"]/text()')</span></span><br><span class="line"><span class="comment"># a=html.xpath('//body//a/text()')</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 7 属性获取  @href 取当前标签的属性</span></span><br><span class="line"><span class="comment"># a=html.xpath('//body//a/@href')</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># # 注意从1 开始取（不是从0）</span></span><br><span class="line"><span class="comment"># a=html.xpath('//body//a[1]/@href')</span></span><br><span class="line"><span class="comment"># 8 属性多值匹配</span></span><br><span class="line"><span class="comment">#  a 标签有多个class类，直接匹配就不可以了，需要用contains</span></span><br><span class="line"><span class="comment"># a=html.xpath('//body//a[@class="li"]')</span></span><br><span class="line"><span class="comment"># a=html.xpath('//body//a[contains(@class,"li")]')</span></span><br><span class="line"><span class="comment"># a=html.xpath('//body//a[contains(@class,"li")]/text()')</span></span><br><span class="line"><span class="comment"># 9 多属性匹配</span></span><br><span class="line"><span class="comment"># a=html.xpath('//body//a[contains(@class,"li") or @name="items"]')</span></span><br><span class="line"><span class="comment"># a=html.xpath('//body//a[contains(@class,"li") and @name="items"]/text()')</span></span><br><span class="line"><span class="comment"># a=html.xpath('//body//a[contains(@class,"li")]/text()')</span></span><br><span class="line"><span class="comment"># 10 按序选择</span></span><br><span class="line"><span class="comment"># a=html.xpath('//a[2]/text()')</span></span><br><span class="line"><span class="comment"># a=html.xpath('//a[2]/@href')</span></span><br><span class="line"><span class="comment"># 取最后一个</span></span><br><span class="line"><span class="comment"># a=html.xpath('//a[last()]/@href')</span></span><br><span class="line"><span class="comment"># 位置小于3的</span></span><br><span class="line"><span class="comment"># a=html.xpath('//a[position()&lt;3]/@href')</span></span><br><span class="line"><span class="comment"># 倒数第二个</span></span><br><span class="line"><span class="comment"># a=html.xpath('//a[last()-2]/@href')</span></span><br><span class="line"><span class="comment"># 11 节点轴选择</span></span><br><span class="line"><span class="comment"># ancestor：祖先节点</span></span><br><span class="line"><span class="comment"># 使用了* 获取所有祖先节点</span></span><br><span class="line"><span class="comment"># a=html.xpath('//a/ancestor::*')</span></span><br><span class="line"><span class="comment"># # 获取祖先节点中的div</span></span><br><span class="line"><span class="comment"># a=html.xpath('//a/ancestor::div')</span></span><br><span class="line"><span class="comment"># attribute：属性值</span></span><br><span class="line"><span class="comment"># a=html.xpath('//a[1]/attribute::*')</span></span><br><span class="line"><span class="comment"># a=html.xpath('//a[1]/@aa')</span></span><br><span class="line"><span class="comment"># child：直接子节点</span></span><br><span class="line"><span class="comment"># a=html.xpath('//a[1]/child::*')</span></span><br><span class="line"><span class="comment"># a=html.xpath('//a[1]/child::img/@src')</span></span><br><span class="line"><span class="comment"># descendant：所有子孙节点</span></span><br><span class="line"><span class="comment"># a=html.xpath('//a[6]/descendant::*')</span></span><br><span class="line"><span class="comment"># a=html.xpath('//a[6]/descendant::h5/text()')</span></span><br><span class="line"><span class="comment"># following:当前节点之后所有节点(兄弟节点和兄弟内部的节点)</span></span><br><span class="line"><span class="comment"># a=html.xpath('//a[1]/following::*')</span></span><br><span class="line"><span class="comment"># a=html.xpath('//a[1]/following::*[1]/@href')</span></span><br><span class="line"><span class="comment"># following-sibling:当前节点之后同级节点（只找兄弟）</span></span><br><span class="line"><span class="comment"># a=html.xpath('//a[1]/following-sibling::*')</span></span><br><span class="line"><span class="comment"># a=html.xpath('//a[1]/following-sibling::a')</span></span><br><span class="line"><span class="comment"># a=html.xpath('//a[1]/following-sibling::*[2]')</span></span><br><span class="line"><span class="comment"># a=html.xpath('//a[1]/following-sibling::*[2]/@href')</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">print(a)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># /</span></span><br><span class="line"><span class="comment"># //</span></span><br><span class="line"><span class="comment"># /@属性名</span></span><br><span class="line"><span class="comment"># /text()</span></span><br><span class="line"></span><br><span class="line">//以后去查找标签，bs4的find，     css，xpath（通用的）</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;xpath&quot;&gt;&lt;a href=&quot;#xpath&quot; class=&quot;headerlink&quot; title=&quot;xpath&quot;&gt;&lt;/a&gt;xpath&lt;/h2&gt;&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter
      
    
    </summary>
    
    
    
      <category term="爬虫" scheme="http://yoursite.com/tags/%E7%88%AC%E8%99%AB/"/>
    
  </entry>
  
  <entry>
    <title>scrapy的初级使用</title>
    <link href="http://yoursite.com/2019/11/07/scrapy%E7%9A%84%E5%88%9D%E7%BA%A7%E4%BD%BF%E7%94%A8/"/>
    <id>http://yoursite.com/2019/11/07/scrapy%E7%9A%84%E5%88%9D%E7%BA%A7%E4%BD%BF%E7%94%A8/</id>
    <published>2019-11-06T16:00:00.000Z</published>
    <updated>2020-08-20T12:14:41.533Z</updated>
    
    <content type="html"><![CDATA[<h2 id="scrapy"><a href="#scrapy" class="headerlink" title="scrapy"></a>scrapy</h2><h2 id="scrapy框架介绍"><a href="#scrapy框架介绍" class="headerlink" title="scrapy框架介绍"></a>scrapy框架介绍</h2><p>执行流程的五大组件</p><ul><li>引擎(EGINE)：大总管，负责控制数据的流向、</li><li>调度器(SCHEDULER)：由它来决定下一个要抓取的网址是什么，去重</li><li>下载器(DOWLOADER)：用于下载网页内容, 并将网页内容返回给EGINE，下载器是建立在twisted这个高效的异步模型上的</li><li>爬虫(SPIDERS):开发人员自定义的类，用来解析responses，并且提取items，或者发送新的请求request</li><li>项目管道(ITEM PIPLINES):在items被提取后负责处理它们，主要包括清理、验证、持久化（比如存到数据库）等操作</li></ul><p>两大中间件</p><ul><li>爬虫中间件：位于EGINE和SPIDERS之间，主要工作是处理SPIDERS的输入和输出（用的很少</li></ul><h2 id="scrapy的安装"><a href="#scrapy的安装" class="headerlink" title="scrapy的安装"></a>scrapy的安装</h2><ul><li><p>pip install scrapy</p></li><li><p>windows上安装不成按照下面的步骤</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1、pip3 install wheel #安装后，便支持通过wheel文件安装软件，wheel文件官网：https:&#x2F;&#x2F;www.lfd.uci.edu&#x2F;~gohlke&#x2F;pythonlibs</span><br><span class="line">3、pip3 install lxml</span><br><span class="line">4、pip3 install pyopenssl</span><br><span class="line">5、下载并安装pywin32：https:&#x2F;&#x2F;sourceforge.net&#x2F;projects&#x2F;pywin32&#x2F;files&#x2F;pywin32&#x2F;</span><br><span class="line">6、下载twisted的wheel文件：http:&#x2F;&#x2F;www.lfd.uci.edu&#x2F;~gohlke&#x2F;pythonlibs&#x2F;#twisted</span><br><span class="line">7、执行pip3 install 下载目录\Twisted-17.9.0-cp36-cp36m-win_amd64.whl</span><br><span class="line">8、pip3 install scrapy</span><br><span class="line"># 3 就有scrapy命令</span><br><span class="line">-D:\Python36\Scripts\scrapy.exe  用于创建项目</span><br></pre></td></tr></table></figure></li></ul><h2 id="scrapy-创建项目，爬虫，运行"><a href="#scrapy-创建项目，爬虫，运行" class="headerlink" title="scrapy 创建项目，爬虫，运行"></a>scrapy 创建项目，爬虫，运行</h2><ul><li><p>创建项目名字<code>scrapy startproject firstscrapy</code></p></li><li><p>创建爬虫<code>scrapy genspider chouti dig.chouti.com</code></p></li><li><p>运行<code>scrapy crawl chouti</code>带运行日志。scrapy crawl chouti –nolog  # 不带日志</p></li><li><p>支持右键执行爬虫,在项目里新建一个main.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scrapy.cmdline <span class="keyword">import</span> execute</span><br><span class="line">execute([<span class="string">'scrapy'</span>,<span class="string">'crawl'</span>,<span class="string">'chouti'</span>,<span class="string">'--nolog'</span>])</span><br></pre></td></tr></table></figure></li></ul><h2 id="settings-介绍"><a href="#settings-介绍" class="headerlink" title="settings 介绍"></a>settings 介绍</h2><p>在默认的情况下，scrapy会去遵循爬虫协议会，</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> 修改配置文件参数，强行爬取，不遵循协议</span><br><span class="line">ROBOTSTXT_OBEY = <span class="literal">False</span></span><br><span class="line"><span class="number">2</span> USER_AGENT = <span class="string">'Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.105 Safari/537.36'</span></span><br><span class="line"><span class="number">3</span> LOG_LEVEL=<span class="string">'ERROR'</span></span><br></pre></td></tr></table></figure><h2 id="scrapy的数据解析"><a href="#scrapy的数据解析" class="headerlink" title="scrapy的数据解析"></a>scrapy的数据解析</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#xpath：</span></span><br><span class="line">-response.xpath(<span class="string">'//a[contains(@class,"link-title")]/text()'</span>).extract()  <span class="comment"># 取文本</span></span><br><span class="line">-response.xpath(<span class="string">'//a[contains(@class,"link-title")]/@href'</span>).extract()  <span class="comment">#取属性</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#css</span></span><br><span class="line">-response.css(<span class="string">'.link-title::text'</span>).extract()  <span class="comment"># 取文本</span></span><br><span class="line">    -response.css(<span class="string">'.link-title:: ).extract_first()  # 取属性</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse</span><span class="params">(self, response)</span>:</span></span><br><span class="line">    <span class="comment"># title = response.css('.link-title')</span></span><br><span class="line">    <span class="comment"># title = response.xpath('//a[contains(@class,"link-title")]/text()').extract()</span></span><br><span class="line"></span><br><span class="line">    div_list = response.xpath(<span class="string">'//div[contains(@class,"link-item")]'</span>)</span><br><span class="line">    <span class="keyword">for</span> div <span class="keyword">in</span> div_list:</span><br><span class="line">        <span class="comment"># title = div.css('.link-title::text').extract()[0]</span></span><br><span class="line">        url = div.xpath(<span class="string">'//a[contains(@class,"link-title")]/@href'</span>).extract_first()</span><br><span class="line"></span><br><span class="line">        print(url)</span><br></pre></td></tr></table></figure><h2 id="数据持久化"><a href="#数据持久化" class="headerlink" title="数据持久化"></a>数据持久化</h2><p>方式一：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse</span><span class="params">(self, response)</span>:</span></span><br><span class="line">       ll= []</span><br><span class="line">       div_list = response.xpath(<span class="string">'//div[contains(@class,"link-item")]'</span>)</span><br><span class="line">       <span class="keyword">for</span> div <span class="keyword">in</span> div_list:</span><br><span class="line">           title = div.css(<span class="string">'.link-title::text'</span>).extract_first()</span><br><span class="line">           url = div.css(<span class="string">'.link-title::attr(href)'</span>).extract_first()</span><br><span class="line">           img_url = div.css(<span class="string">'.image-scale::attr(src)'</span>).extract_first()</span><br><span class="line">           <span class="comment"># print(img_url) # 必须列表套字典</span></span><br><span class="line">           ll.append((&#123;<span class="string">'title'</span>:title,<span class="string">'url'</span>:url,<span class="string">'img_url'</span>:img_url&#125;))</span><br><span class="line">           <span class="comment"># 数据持久化</span></span><br><span class="line">       <span class="keyword">return</span> ll</span><br></pre></td></tr></table></figure><p>方式二：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1 在items中写一个类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChouTiitem</span><span class="params">(scrapy.Item)</span>:</span></span><br><span class="line">    <span class="comment"># define the fields for your item here like:</span></span><br><span class="line">    title = scrapy.Field()</span><br><span class="line">    url = scrapy.Field()</span><br><span class="line">    img_url = scrapy.Field()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2 在spinder中导入，实例化把数据放进去</span></span><br><span class="line">item = ChouTiitem()</span><br><span class="line">            item[<span class="string">'title'</span>] = title</span><br><span class="line">            item[<span class="string">'url'</span>] = url</span><br><span class="line">            item[<span class="string">'img_url'</span>] = img_url</span><br><span class="line">            <span class="comment"># 数据持久化</span></span><br><span class="line">            <span class="keyword">yield</span> item</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3 在setting中配置（数字越小，级别越高）</span></span><br><span class="line">ITEM_PIPELINES = &#123;</span><br><span class="line">   <span class="comment"># 'app01.pipelines.App01Pipeline': 300,</span></span><br><span class="line">   <span class="string">'app01.pipelines.ChouTiPipeline'</span>: <span class="number">302</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4 在pipelines.py中写ChoutiFilePipeline</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChouTiPipeline</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">open_spider</span><span class="params">(self, spider)</span>:</span></span><br><span class="line">        print(<span class="string">'我开了'</span>)</span><br><span class="line">        self.file = open(<span class="string">'chouti.txt'</span>, <span class="string">'w'</span>, encoding=<span class="string">'utf-8'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_item</span><span class="params">(self, item, spider)</span>:</span></span><br><span class="line"></span><br><span class="line">        self.file.write(item[<span class="string">'title'</span>] + <span class="string">'\n'</span>)</span><br><span class="line">        self.file.write(item[<span class="string">'url'</span>] + <span class="string">'\n'</span>)</span><br><span class="line">        self.file.write(item[<span class="string">'img_url'</span>] + <span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> item</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">close_spider</span><span class="params">(self, spider)</span>:</span></span><br><span class="line">        print(<span class="string">'我馆了'</span>)</span><br><span class="line">        self.file.close()</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line"> 在pipelines.py中写ChoutiFilePipeline</span><br><span class="line">    -open_spider（开始的时候）</span><br><span class="line">        -close_spider（结束的时候）</span><br><span class="line">        -process_item（在这持久化）</span><br></pre></td></tr></table></figure><p>存在数据库中</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChoutiMysqlPipeline</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">open_spider</span><span class="params">(self,spider)</span>:</span></span><br><span class="line">        self.conn=pymysql.connect( host=<span class="string">'127.0.0.1'</span>, user=<span class="string">'root'</span>, password=<span class="string">"123"</span>,</span><br><span class="line">                 database=<span class="string">'chouti'</span>, port=<span class="number">3306</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">close_spider</span><span class="params">(self,spider)</span>:</span></span><br><span class="line">        self.conn.close()</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_item</span><span class="params">(self, item, spider)</span>:</span></span><br><span class="line">        cursor=self.conn.cursor()</span><br><span class="line">        sql=<span class="string">'insert into article (title,url,photo_url)values(%s,%s,%s) '</span></span><br><span class="line">        cursor.execute(sql,[item[<span class="string">'title'</span>],item[<span class="string">'url'</span>],item[<span class="string">'photo_url'</span>]])</span><br><span class="line">        self.conn.commit()</span><br><span class="line">        <span class="keyword">return</span> item</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;scrapy&quot;&gt;&lt;a href=&quot;#scrapy&quot; class=&quot;headerlink&quot; title=&quot;scrapy&quot;&gt;&lt;/a&gt;scrapy&lt;/h2&gt;&lt;h2 id=&quot;scrapy框架介绍&quot;&gt;&lt;a href=&quot;#scrapy框架介绍&quot; class=&quot;headerli
      
    
    </summary>
    
    
    
      <category term="爬虫" scheme="http://yoursite.com/tags/%E7%88%AC%E8%99%AB/"/>
    
  </entry>
  
  <entry>
    <title>爬虫requests模块</title>
    <link href="http://yoursite.com/2019/11/06/1.%20%E7%88%AC%E8%99%ABrequests%E6%A8%A1%E5%9D%97/"/>
    <id>http://yoursite.com/2019/11/06/1.%20%E7%88%AC%E8%99%ABrequests%E6%A8%A1%E5%9D%97/</id>
    <published>2019-11-05T16:00:00.000Z</published>
    <updated>2020-08-20T12:13:30.855Z</updated>
    
    <content type="html"><![CDATA[<h2 id="爬虫requests模块"><a href="#爬虫requests模块" class="headerlink" title="爬虫requests模块"></a>爬虫requests模块</h2><h2 id="requests-get请求"><a href="#requests-get请求" class="headerlink" title="requests get请求"></a>requests get请求</h2><h3 id="发送get请求"><a href="#发送get请求" class="headerlink" title="发送get请求"></a>发送get请求</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">res是python的对象，对象里，响应头，响应体。。。。</span><br><span class="line">header = &#123;</span><br><span class="line">    <span class="string">'user-agent'</span>: <span class="string">'Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.105 Safari/537.36'</span>,</span><br><span class="line">    <span class="string">'referer'</span>: <span class="string">'https://www.mzitu.com/225078/2'</span></span><br><span class="line">&#125;</span><br><span class="line">res = requests.get(<span class="string">'https://www.mzitu.com/'</span>, headers=header)</span><br><span class="line">print(res.text)</span><br><span class="line"><span class="comment"># 图片的处理</span></span><br><span class="line">res1 = requests.get(<span class="string">'https://i3.mmzztt.com/2020/03/14a02.jpg'</span>, headers=header)</span><br><span class="line">print(res1.text)</span><br><span class="line"><span class="comment"># print(res1.content)  # 二进制内容</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'a.jpg'</span>, <span class="string">'wb'</span>)<span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> res1.iter_content():</span><br><span class="line">        f.write(line)</span><br></pre></td></tr></table></figure><h3 id="请求地址中携带数据"><a href="#请求地址中携带数据" class="headerlink" title="请求地址中携带数据"></a>请求地址中携带数据</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2</span> 请求地址中携带数据(两种方式，推荐第二种)</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlencode,unquote  <span class="comment"># url的编码和解码</span></span><br><span class="line">print(unquote(<span class="string">'%E7%BE%8E%E5%A5%B3'</span>))</span><br><span class="line">%E7%BE%<span class="number">8</span>E%E5%A5%B3</span><br><span class="line">header = &#123;</span><br><span class="line">    <span class="string">'user-agent'</span>: <span class="string">'Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.105 Safari/537.36'</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 第一种</span></span><br><span class="line">res=requests.get(<span class="string">'https://www.baidu.com/s?wd=美女'</span>,headers=header)</span><br><span class="line"><span class="comment"># 第二种</span></span><br><span class="line">res=requests.get(<span class="string">'https://www.baidu.com/s'</span>,headers=header,params=&#123;<span class="string">'wd'</span>:<span class="string">'美女'</span>&#125;)</span><br><span class="line">print(res.url)</span><br><span class="line">print(res.text)</span><br></pre></td></tr></table></figure><h3 id="请求带cookie"><a href="#请求带cookie" class="headerlink" title="请求带cookie"></a>请求带cookie</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">请求带cookie(两种方式)</span><br><span class="line"><span class="comment"># 方式一，在header中放</span></span><br><span class="line">header = &#123;</span><br><span class="line">    <span class="string">'user-agent'</span>: <span class="string">'Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.105 Safari/537.36'</span>,</span><br><span class="line">    <span class="string">'cookie'</span>:<span class="string">'key=asdfasdfasdfsdfsaasdf;key2=asdfasdf;key3=asdfasdf'</span></span><br><span class="line">&#125;</span><br><span class="line">res=requests.get(<span class="string">'http://127.0.0.1:8000/index/'</span>,headers=header)</span><br><span class="line"><span class="comment"># 方式二：</span></span><br><span class="line">header = &#123;</span><br><span class="line">    <span class="string">'user-agent'</span>: <span class="string">'Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.105 Safari/537.36'</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># cookies是一个字典或者CookieJar对象</span></span><br><span class="line">res=requests.get(<span class="string">'http://127.0.0.1:8000/index/'</span>,headers=header,cookies=&#123;<span class="string">'key'</span>:<span class="string">'asdfasdf'</span>&#125;)</span><br><span class="line">print(res.text)</span><br></pre></td></tr></table></figure><h2 id="requests-post请求"><a href="#requests-post请求" class="headerlink" title="requests post请求"></a>requests post请求</h2><h3 id="发送post请求"><a href="#发送post请求" class="headerlink" title="发送post请求"></a>发送post请求</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#  发送post请求，携带数据（urlencoded和json）</span></span><br><span class="line"><span class="comment"># urlencoded</span></span><br><span class="line"> res=requests.post(<span class="string">'http://127.0.0.1:8000/index/'</span>,data=&#123;<span class="string">'name'</span>:<span class="string">'lqz'</span>&#125;)</span><br><span class="line"> print(res.text)</span><br><span class="line"><span class="comment"># json</span></span><br><span class="line"> res=requests.post(<span class="string">'http://127.0.0.1:8000/index/'</span>,json=&#123;<span class="string">'age'</span>:<span class="number">1</span>,&#125;,)</span><br><span class="line"> print(res.text)</span><br></pre></td></tr></table></figure><h3 id="自动携带cookie"><a href="#自动携带cookie" class="headerlink" title="自动携带cookie"></a>自动携带cookie</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">session=requests.session()</span><br><span class="line">res=session.post(<span class="string">'http://127.0.0.1:8000/index/'</span>)  <span class="comment"># 假设这个请求登录了</span></span><br><span class="line">res1=session.get(<span class="string">'http://127.0.0.1:8000/order/'</span>)  <span class="comment"># 现在不需要手动带cookie，session会帮咱处理</span></span><br></pre></td></tr></table></figure><h3 id="response对象"><a href="#response对象" class="headerlink" title="response对象"></a>response对象</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">respone=requests.post(<span class="string">'http://127.0.0.1:8000/index/'</span>,data=&#123;<span class="string">'name'</span>:<span class="string">'lqz'</span>&#125;)</span><br><span class="line">print(respone.text)  <span class="comment"># 响应的文本</span></span><br><span class="line">print(respone.content)  <span class="comment"># 响应体的二进制</span></span><br><span class="line">print(respone.status_code)  <span class="comment"># 响应状态码</span></span><br><span class="line">print(respone.headers)    <span class="comment"># 响应头</span></span><br><span class="line">print(respone.cookies)   <span class="comment"># cookie</span></span><br><span class="line">print(respone.cookies.get_dict()) <span class="comment">#  把cookie转成字典</span></span><br><span class="line">print(respone.cookies.items())  <span class="comment"># key和value</span></span><br><span class="line">print(respone.url)        <span class="comment"># 请求的url</span></span><br><span class="line">print(respone.history)   <span class="comment">#[]放重定向之前的地址</span></span><br><span class="line">print(respone.encoding)  <span class="comment"># 响应的编码方式</span></span><br><span class="line"></span><br><span class="line">respone.iter_content()  <span class="comment"># 图片，视频，大文件，一点一点循环取出来</span></span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> respone.iter_content():</span><br><span class="line">     f.write(line)</span><br></pre></td></tr></table></figure><h3 id="编码问题"><a href="#编码问题" class="headerlink" title="编码问题"></a>编码问题</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">res=requests.get(<span class="string">'http://www.autohome.com/news'</span>)<span class="comment"># 一旦打印出来出现乱码问题</span></span><br><span class="line"><span class="comment">#方式一</span></span><br><span class="line">res.encoding=<span class="string">'gb2312'</span></span><br><span class="line"><span class="comment"># 方式二</span></span><br><span class="line">res.encoding=res.apparent_encoding</span><br><span class="line">print(res.text)</span><br></pre></td></tr></table></figure><h3 id="解析json"><a href="#解析json" class="headerlink" title="解析json"></a>解析json</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># import json</span></span><br><span class="line"><span class="comment"># respone=requests.post('http://127.0.0.1:8000/index/',data=&#123;'name':'lqz'&#125;)</span></span><br><span class="line">print(type(respone.text))  <span class="comment"># 响应的文本</span></span><br><span class="line">print(json.loads(respone.text))</span><br><span class="line">print(respone.json())  <span class="comment"># 相当于上面那句话</span></span><br><span class="line">print(type(respone.json()))  <span class="comment"># 相当于上面那句话</span></span><br></pre></td></tr></table></figure><h3 id="高级用法之ssl"><a href="#高级用法之ssl" class="headerlink" title="高级用法之ssl"></a>高级用法之ssl</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">respone=requests.get(<span class="string">'https://www.12306.cn'</span>) <span class="comment">#不验证证书,报警告,返回200</span></span><br><span class="line">print(respone.status_code)</span><br><span class="line"><span class="comment"># 使用证书，需要手动携带</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">respone=requests.get(<span class="string">'https://www.12306.cn'</span>,</span><br><span class="line">                      cert=(<span class="string">'/path/server.crt'</span>,</span><br><span class="line">                            <span class="string">'/path/key'</span>))</span><br><span class="line">print(respone.status_code)</span><br></pre></td></tr></table></figure><h3 id="高级用法：使用代理"><a href="#高级用法：使用代理" class="headerlink" title="高级用法：使用代理"></a>高级用法：使用代理</h3><p>高匿和透明代理？如果使用高匿代理，后端无论如何拿不到你的ip，使用透明，后端能够拿到你的ip</p><ul><li>代理，免费代理，收费代理花钱买</li><li>代理池：列表放了一堆代理ip，每次随机取一个，再发请求就不会封ip了</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">respone=requests.get(<span class="string">'http://127.0.0.1:8000/index/'</span>,proxies=&#123;<span class="string">'http'</span>:<span class="string">'代理的地址和端口号'</span>,&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 后端如何拿到透明代理的ip，  后端：X-Forwarded-For</span></span><br><span class="line"> respone=requests.get(<span class="string">'https://www.baidu.com/'</span>,proxies=&#123;<span class="string">'http'</span>:<span class="string">'27.46.20.226:8888'</span>,&#125;)</span><br><span class="line">print(respone.text)</span><br></pre></td></tr></table></figure><h3 id="超时，认证，异常处理，上传文件"><a href="#超时，认证，异常处理，上传文件" class="headerlink" title="超时，认证，异常处理，上传文件"></a>超时，认证，异常处理，上传文件</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 超时设置</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">respone=requests.get(<span class="string">'https://www.baidu.com'</span>,</span><br><span class="line">                      timeout=<span class="number">0.0001</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 认证设置（你见不到了）</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">r=requests.get(<span class="string">'xxx'</span>,auth=(<span class="string">'user'</span>,<span class="string">'password'</span>))</span><br><span class="line">print(r.status_code)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 异常</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> requests.exceptions <span class="keyword">import</span> * <span class="comment">#可以查看requests.exceptions获取异常类型</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    r=requests.get(<span class="string">'http://www.baidu.com'</span>,timeout=<span class="number">0.00001</span>)</span><br><span class="line"><span class="keyword">except</span> ReadTimeout:</span><br><span class="line">     print(<span class="string">'===:'</span>)</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    print(e)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 上传文件</span></span><br><span class="line">res=requests.post(<span class="string">'http://127.0.0.1:8000/index/'</span>,files=&#123;<span class="string">'myfile'</span>:open(<span class="string">'a.jpg'</span>,<span class="string">'rb'</span>)&#125;)</span><br><span class="line"><span class="comment"># print(res.text)</span></span><br></pre></td></tr></table></figure><h2 id="模拟登陆某网站"><a href="#模拟登陆某网站" class="headerlink" title="模拟登陆某网站"></a>模拟登陆某网站</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#http://www.aa7a.cn/</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">session=requests.session()</span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">'username'</span>: <span class="string">'616564099@qq.com'</span>,</span><br><span class="line">    <span class="string">'password'</span>: <span class="string">'lqz123'</span>,</span><br><span class="line">    <span class="string">'captcha'</span>: <span class="string">'zdu4'</span>,</span><br><span class="line">    <span class="string">'remember'</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">'ref'</span>: <span class="string">'http://www.aa7a.cn/user.php?act=logout'</span>,</span><br><span class="line">    <span class="string">'act'</span>: <span class="string">'act_login'</span>,</span><br><span class="line">&#125;</span><br><span class="line">rest = session.post(<span class="string">'http://www.aa7a.cn/user.php'</span>,data=data)</span><br><span class="line">print(rest.text)</span><br><span class="line"><span class="comment"># 拿到cookie</span></span><br><span class="line">cookie=rest.cookies</span><br><span class="line">print(cookie)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 携带着cookies，表示登录了，页面中会有我们的用户信息616564099@qq.com</span></span><br><span class="line">rest1=session.get(<span class="string">'http://www.aa7a.cn/index.php'</span>)</span><br><span class="line"><span class="comment"># rest1=requests.get('http://www.aa7a.cn/index.php')</span></span><br><span class="line">print(<span class="string">'616564099@qq.com'</span> <span class="keyword">in</span> rest1.text)</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="爬取梨视频"><a href="#爬取梨视频" class="headerlink" title="爬取梨视频"></a>爬取梨视频</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">res=requests.get(<span class="string">'https://www.pearvideo.com/category_loading.jsp?reqType=5&amp;categoryId=1&amp;start=0'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># print(res.text)</span></span><br><span class="line">re_video=<span class="string">'&lt;a href="(.*?)" class="vervideo-lilink actplay"&gt;'</span></span><br><span class="line">video_urls=re.findall(re_video,res.text)</span><br><span class="line"><span class="comment"># https://www.pearvideo.com/</span></span><br><span class="line"><span class="comment"># print(video_urls)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> video <span class="keyword">in</span> video_urls:</span><br><span class="line">    url=<span class="string">'https://www.pearvideo.com/'</span>+video</span><br><span class="line">    print(url)</span><br><span class="line">    <span class="comment"># 向视频详情发送get请求</span></span><br><span class="line">    res_video=requests.get(url)</span><br><span class="line">    <span class="comment"># print(res_video.text)</span></span><br><span class="line">    <span class="comment"># break</span></span><br><span class="line">    re_video_mp4=<span class="string">'hdUrl="",sdUrl="",ldUrl="",srcUrl="(.*?)",vdoUrl=srcUrl,skinRes'</span></span><br><span class="line">    video_url=re.findall(re_video_mp4,res_video.text)[<span class="number">0</span>]</span><br><span class="line">    print(video_url)</span><br><span class="line">    video_name=video_url.rsplit(<span class="string">'/'</span>,<span class="number">1</span>)[<span class="number">-1</span>]</span><br><span class="line">    print(video_name)</span><br><span class="line">    res_video_content=requests.get(video_url)</span><br><span class="line">    <span class="keyword">with</span> open(video_name,<span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> res_video_content.iter_content():</span><br><span class="line">            f.write(line)</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;爬虫requests模块&quot;&gt;&lt;a href=&quot;#爬虫requests模块&quot; class=&quot;headerlink&quot; title=&quot;爬虫requests模块&quot;&gt;&lt;/a&gt;爬虫requests模块&lt;/h2&gt;&lt;h2 id=&quot;requests-get请求&quot;&gt;&lt;a href=&quot;
      
    
    </summary>
    
    
    
      <category term="爬虫" scheme="http://yoursite.com/tags/%E7%88%AC%E8%99%AB/"/>
    
  </entry>
  
  <entry>
    <title>bs4模块</title>
    <link href="http://yoursite.com/2019/11/06/bs4%E6%A8%A1%E5%9D%97/"/>
    <id>http://yoursite.com/2019/11/06/bs4%E6%A8%A1%E5%9D%97/</id>
    <published>2019-11-05T16:00:00.000Z</published>
    <updated>2020-08-20T12:14:07.246Z</updated>
    
    <content type="html"><![CDATA[<h2 id="bs4模块"><a href="#bs4模块" class="headerlink" title="bs4模块"></a>bs4模块</h2><h3 id="使用前戏"><a href="#使用前戏" class="headerlink" title="使用前戏"></a>使用前戏</h3><p>html.parser内置，不需要安装第三方模块</p><p>pip3 install lxml</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="comment"># pip3 install beautifulsoup4  解析html和xml，修改html和xml</span></span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"></span><br><span class="line">res=requests.get(<span class="string">'https://www.autohome.com.cn/news/1/#liststart'</span>)</span><br><span class="line"><span class="comment"># 解析器方式一内置html.parser</span></span><br><span class="line">soup=BeautifulSoup(res.text,<span class="string">'html.parser'</span>) </span><br><span class="line"><span class="comment"># lxml</span></span><br><span class="line">soup=BeautifulSoup(res.text,<span class="string">'lxml'</span>)</span><br><span class="line">ul=soup.find(class_=<span class="string">'article'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 继续找ul下的s所有li</span></span><br><span class="line">li_list=ul.find_all(name=<span class="string">'li'</span>)</span><br><span class="line"><span class="comment"># print(len(li_list))</span></span><br><span class="line"><span class="keyword">for</span> li <span class="keyword">in</span> li_list:</span><br><span class="line">    <span class="comment"># 找每个li下的东西</span></span><br><span class="line">    title=li.find(name=<span class="string">'h3'</span>)</span><br><span class="line">    <span class="keyword">if</span> title:</span><br><span class="line">        title=title.text</span><br><span class="line">     url=<span class="string">'https:'</span>+li.find(<span class="string">'a'</span>).attrs.get(<span class="string">'href'</span>)</span><br><span class="line">        desc=li.find(<span class="string">'p'</span>).text</span><br><span class="line">        img=<span class="string">'https:'</span>+li.find(name=<span class="string">'img'</span>).get(<span class="string">'src'</span>)</span><br><span class="line">        print(<span class="string">'''</span></span><br><span class="line"><span class="string">        新闻标题：%s</span></span><br><span class="line"><span class="string">        新闻地址：%s</span></span><br><span class="line"><span class="string">        新闻摘要：%s</span></span><br><span class="line"><span class="string">        新闻图片：%s</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        '''</span>%(title,url,desc,img))</span><br></pre></td></tr></table></figure><h2 id="bs4的使用"><a href="#bs4的使用" class="headerlink" title="bs4的使用"></a>bs4的使用</h2><h3 id="一-介绍"><a href="#一-介绍" class="headerlink" title="一 介绍"></a>一 介绍</h3><p>Beautiful Soup 是一个可以从HTML或XML文件中提取数据的Python库.它能够通过你喜欢的转换器实现惯用的文档导航,查找,修改文档的方式.Beautiful Soup会帮你节省数小时甚至数天的工作时间.你可能在寻找 Beautiful Soup3 的文档,Beautiful Soup 3 目前已经停止开发,官网推荐在现在的项目中使用Beautiful Soup 4, 移植到BS4</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#安装 Beautiful Soup</span><br><span class="line">pip install beautifulsoup4</span><br><span class="line"></span><br><span class="line">#安装解析器</span><br><span class="line">Beautiful Soup支持Python标准库中的HTML解析器,还支持一些第三方的解析器,其中一个是 lxml .根据操作系统不同,可以选择下列方法来安装lxml:</span><br><span class="line"></span><br><span class="line">$ apt-get install Python-lxml</span><br><span class="line"></span><br><span class="line">$ easy_install lxml</span><br><span class="line"></span><br><span class="line">$ pip install lxml</span><br><span class="line"></span><br><span class="line">另一个可供选择的解析器是纯Python实现的 html5lib , html5lib的解析方式与浏览器相同,可以选择下列方法来安装html5lib:</span><br><span class="line"></span><br><span class="line">$ apt-get install Python-html5lib</span><br><span class="line"></span><br><span class="line">$ easy_install html5lib</span><br><span class="line"></span><br><span class="line">$ pip install html5lib</span><br></pre></td></tr></table></figure><p><strong>下表列出了主要的解析器,以及它们的优缺点,官网推荐使用lxml作为解析器,因为效率更高. 在Python2.7.3之前的版本和Python3中3.2.2之前的版本,必须安装lxml或html5lib, 因为那些Python版本的标准库中内置的HTML解析方法不够稳定.</strong></p><table><thead><tr><th>解析器</th><th>使用方法</th><th>优势</th><th>劣势</th></tr></thead><tbody><tr><td>Python标准库</td><td><code>BeautifulSoup(markup, &quot;html.parser&quot;)</code></td><td>Python的内置标准库执行速度适中文档容错能力强</td><td>Python 2.7.3 or 3.2.2)前 的版本中文档容错能力差</td></tr><tr><td>lxml HTML 解析器</td><td><code>BeautifulSoup(markup, &quot;lxml&quot;)</code></td><td>速度快文档容错能力强</td><td>需要安装C语言库</td></tr><tr><td>lxml XML 解析器</td><td><code>BeautifulSoup(markup, [&quot;lxml&quot;, &quot;xml&quot;])``BeautifulSoup(markup, &quot;xml&quot;)</code></td><td>速度快唯一支持XML的解析器</td><td>需要安装C语言库</td></tr><tr><td>html5lib</td><td><code>BeautifulSoup(markup, &quot;html5lib&quot;)</code></td><td>最好的容错性以浏览器的方式解析文档生成HTML5格式的文档</td><td>速度慢不依赖外部扩展</td></tr></tbody></table><h3 id="二-基本使用"><a href="#二-基本使用" class="headerlink" title="二 基本使用"></a>二 基本使用</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">html_doc &#x3D; &quot;&quot;&quot;</span><br><span class="line">&lt;html&gt;&lt;head&gt;&lt;title&gt;The Dormouse&#39;s story&lt;&#x2F;title&gt;&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;p class&#x3D;&quot;title&quot;&gt;&lt;b&gt;The Dormouse&#39;s story&lt;&#x2F;b&gt;&lt;&#x2F;p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p class&#x3D;&quot;story&quot;&gt;Once upon a time there were three little sisters; and their names were</span><br><span class="line">&lt;a href&#x3D;&quot;http:&#x2F;&#x2F;example.com&#x2F;elsie&quot; class&#x3D;&quot;sister&quot; id&#x3D;&quot;link1&quot;&gt;Elsie&lt;&#x2F;a&gt;,</span><br><span class="line">&lt;a href&#x3D;&quot;http:&#x2F;&#x2F;example.com&#x2F;lacie&quot; class&#x3D;&quot;sister&quot; id&#x3D;&quot;link2&quot;&gt;Lacie&lt;&#x2F;a&gt; and</span><br><span class="line">&lt;a href&#x3D;&quot;http:&#x2F;&#x2F;example.com&#x2F;tillie&quot; class&#x3D;&quot;sister&quot; id&#x3D;&quot;link3&quot;&gt;Tillie&lt;&#x2F;a&gt;;</span><br><span class="line">and they lived at the bottom of a well.&lt;&#x2F;p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p class&#x3D;&quot;story&quot;&gt;...&lt;&#x2F;p&gt;</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">#基本使用：容错处理,文档的容错能力指的是在html代码不完整的情况下,使用该模块可以识别该错误。使用BeautifulSoup解析上述代码,能够得到一个 BeautifulSoup 的对象,并能按照标准的缩进格式的结构输出</span><br><span class="line">from bs4 import BeautifulSoup</span><br><span class="line">soup&#x3D;BeautifulSoup(html_doc,&#39;lxml&#39;) #具有容错功能</span><br><span class="line">res&#x3D;soup.prettify() #处理好缩进，结构化显示</span><br><span class="line">print(res)</span><br></pre></td></tr></table></figure><h3 id="三-遍历文档树"><a href="#三-遍历文档树" class="headerlink" title="三 遍历文档树"></a>三 遍历文档树</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#遍历文档树：即直接通过标签名字选择，特点是选择速度快，但如果存在多个相同的标签则只返回第一个</span><br><span class="line">#1、用法</span><br><span class="line">#2、获取标签的名称</span><br><span class="line">#3、获取标签的属性</span><br><span class="line">#4、获取标签的内容</span><br><span class="line">#5、嵌套选择</span><br><span class="line">#6、子节点、子孙节点</span><br><span class="line">#7、父节点、祖先节点</span><br><span class="line">#8、兄弟节点</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#遍历文档树：即直接通过标签名字选择，特点是选择速度快，但如果存在多个相同的标签则只返回第一个</span></span><br><span class="line">html_doc = <span class="string">"""</span></span><br><span class="line"><span class="string">&lt;html&gt;&lt;head&gt;&lt;title&gt;The Dormouse's story&lt;/title&gt;&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">&lt;p id="my p" class="title"&gt;&lt;b id="bbb" class="boldest"&gt;The Dormouse's story&lt;/b&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;p class="story"&gt;Once upon a time there were three little sisters; and their names were</span></span><br><span class="line"><span class="string">&lt;a href="http://example.com/elsie" class="sister" id="link1"&gt;Elsie&lt;/a&gt;,</span></span><br><span class="line"><span class="string">&lt;a href="http://example.com/lacie" class="sister" id="link2"&gt;Lacie&lt;/a&gt; and</span></span><br><span class="line"><span class="string">&lt;a href="http://example.com/tillie" class="sister" id="link3"&gt;Tillie&lt;/a&gt;;</span></span><br><span class="line"><span class="string">and they lived at the bottom of a well.&lt;/p&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;p class="story"&gt;...&lt;/p&gt;</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#1、用法</span></span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line">soup=BeautifulSoup(html_doc,<span class="string">'lxml'</span>)</span><br><span class="line"><span class="comment"># soup=BeautifulSoup(open('a.html'),'lxml')</span></span><br><span class="line"></span><br><span class="line">print(soup.p) <span class="comment">#存在多个相同的标签则只返回第一个</span></span><br><span class="line">print(soup.a) <span class="comment">#存在多个相同的标签则只返回第一个</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#2、获取标签的名称</span></span><br><span class="line">print(soup.p.name)</span><br><span class="line"></span><br><span class="line"><span class="comment">#3、获取标签的属性</span></span><br><span class="line">print(soup.p.attrs)</span><br><span class="line"></span><br><span class="line"><span class="comment">#4、获取标签的内容</span></span><br><span class="line">print(soup.p.string) <span class="comment"># p下的文本只有一个时，取到，否则为None</span></span><br><span class="line">print(soup.p.strings) <span class="comment">#拿到一个生成器对象, 取到p下所有的文本内容</span></span><br><span class="line">print(soup.p.text) <span class="comment">#取到p下所有的文本内容</span></span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> soup.stripped_strings: <span class="comment">#去掉空白</span></span><br><span class="line">    print(line)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">如果tag包含了多个子节点,tag就无法确定 .string 方法应该调用哪个子节点的内容, .string 的输出结果是 None，如果只有一个子节点那么就输出该子节点的文本，比如下面的这种结构，soup.p.string 返回为None,但soup.p.strings就可以找到所有文本</span></span><br><span class="line"><span class="string">&lt;p id='list-1'&gt;</span></span><br><span class="line"><span class="string">    哈哈哈哈</span></span><br><span class="line"><span class="string">    &lt;a class='sss'&gt;</span></span><br><span class="line"><span class="string">        &lt;span&gt;</span></span><br><span class="line"><span class="string">            &lt;h1&gt;aaaa&lt;/h1&gt;</span></span><br><span class="line"><span class="string">        &lt;/span&gt;</span></span><br><span class="line"><span class="string">    &lt;/a&gt;</span></span><br><span class="line"><span class="string">    &lt;b&gt;bbbbb&lt;/b&gt;</span></span><br><span class="line"><span class="string">&lt;/p&gt;</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#5、嵌套选择</span></span><br><span class="line">print(soup.head.title.string)</span><br><span class="line">print(soup.body.a.string)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#6、子节点、子孙节点</span></span><br><span class="line">print(soup.p.contents) <span class="comment">#p下所有子节点</span></span><br><span class="line">print(soup.p.children) <span class="comment">#得到一个迭代器,包含p下所有子节点</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i,child <span class="keyword">in</span> enumerate(soup.p.children):</span><br><span class="line">    print(i,child)</span><br><span class="line"></span><br><span class="line">print(soup.p.descendants) <span class="comment">#获取子孙节点,p下所有的标签都会选择出来</span></span><br><span class="line"><span class="keyword">for</span> i,child <span class="keyword">in</span> enumerate(soup.p.descendants):</span><br><span class="line">    print(i,child)</span><br><span class="line"></span><br><span class="line"><span class="comment">#7、父节点、祖先节点</span></span><br><span class="line">print(soup.a.parent) <span class="comment">#获取a标签的父节点</span></span><br><span class="line">print(soup.a.parents) <span class="comment">#找到a标签所有的祖先节点，父亲的父亲，父亲的父亲的父亲...</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#8、兄弟节点</span></span><br><span class="line">print(<span class="string">'=====&gt;'</span>)</span><br><span class="line">print(soup.a.next_sibling) <span class="comment">#下一个兄弟</span></span><br><span class="line">print(soup.a.previous_sibling) <span class="comment">#上一个兄弟</span></span><br><span class="line"></span><br><span class="line">print(list(soup.a.next_siblings)) <span class="comment">#下面的兄弟们=&gt;生成器对象</span></span><br><span class="line">print(soup.a.previous_siblings) <span class="comment">#上面的兄弟们=&gt;生成器对象</span></span><br></pre></td></tr></table></figure><h3 id="四-搜索文档树"><a href="#四-搜索文档树" class="headerlink" title="四 搜索文档树"></a>四 搜索文档树</h3><p><strong>1、五种过滤器</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#搜索文档树：BeautifulSoup定义了很多搜索方法,这里着重介绍2个: find() 和 find_all() .其它方法的参数和用法类似</span></span><br><span class="line">html_doc = <span class="string">"""</span></span><br><span class="line"><span class="string">&lt;html&gt;&lt;head&gt;&lt;title&gt;The Dormouse's story&lt;/title&gt;&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">&lt;p id="my p" class="title"&gt;&lt;b id="bbb" class="boldest"&gt;The Dormouse's story&lt;/b&gt;</span></span><br><span class="line"><span class="string">&lt;/p&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;p class="story"&gt;Once upon a time there were three little sisters; and their names were</span></span><br><span class="line"><span class="string">&lt;a href="http://example.com/elsie" class="sister" id="link1"&gt;Elsie&lt;/a&gt;,</span></span><br><span class="line"><span class="string">&lt;a href="http://example.com/lacie" class="sister" id="link2"&gt;Lacie&lt;/a&gt; and</span></span><br><span class="line"><span class="string">&lt;a href="http://example.com/tillie" class="sister" id="link3"&gt;Tillie&lt;/a&gt;;</span></span><br><span class="line"><span class="string">and they lived at the bottom of a well.&lt;/p&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;p class="story"&gt;...&lt;/p&gt;</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line">soup=BeautifulSoup(html_doc,<span class="string">'lxml'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#1、五种过滤器: 字符串、正则表达式、列表、True、方法</span></span><br><span class="line"><span class="comment">#1.1、字符串：即标签名</span></span><br><span class="line">print(soup.find_all(<span class="string">'b'</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#1.2、正则表达式</span></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line">print(soup.find_all(re.compile(<span class="string">'^b'</span>))) <span class="comment">#找出b开头的标签，结果有body和b标签</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#1.3、列表：如果传入列表参数,Beautiful Soup会将与列表中任一元素匹配的内容返回.下面代码找到文档中所有&lt;a&gt;标签和&lt;b&gt;标签:</span></span><br><span class="line">print(soup.find_all([<span class="string">'a'</span>,<span class="string">'b'</span>]))</span><br><span class="line"></span><br><span class="line"><span class="comment">#1.4、True：可以匹配任何值,下面代码查找到所有的tag,但是不会返回字符串节点</span></span><br><span class="line">print(soup.find_all(<span class="literal">True</span>))</span><br><span class="line"><span class="keyword">for</span> tag <span class="keyword">in</span> soup.find_all(<span class="literal">True</span>):</span><br><span class="line">    print(tag.name)</span><br><span class="line"></span><br><span class="line"><span class="comment">#1.5、方法:如果没有合适过滤器,那么还可以定义一个方法,方法只接受一个元素参数 ,如果这个方法返回 True 表示当前元素匹配并且被找到,如果不是则反回 False</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">has_class_but_no_id</span><span class="params">(tag)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> tag.has_attr(<span class="string">'class'</span>) <span class="keyword">and</span> <span class="keyword">not</span> tag.has_attr(<span class="string">'id'</span>)</span><br><span class="line"></span><br><span class="line">print(soup.find_all(has_class_but_no_id))</span><br></pre></td></tr></table></figure><p><strong>2、find_all( name , attrs , recursive , text , \</strong>kwargs )**</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#2、find_all( name , attrs , recursive , text , **kwargs )</span></span><br><span class="line"><span class="comment">#2.1、name: 搜索name参数的值可以使任一类型的 过滤器 ,字符窜,正则表达式,列表,方法或是 True .</span></span><br><span class="line">print(soup.find_all(name=re.compile(<span class="string">'^t'</span>)))</span><br><span class="line"></span><br><span class="line"><span class="comment">#2.2、keyword: key=value的形式，value可以是过滤器：字符串 , 正则表达式 , 列表, True .</span></span><br><span class="line">print(soup.find_all(id=re.compile(<span class="string">'my'</span>)))</span><br><span class="line">print(soup.find_all(href=re.compile(<span class="string">'lacie'</span>),id=re.compile(<span class="string">'\d'</span>))) <span class="comment">#注意类要用class_</span></span><br><span class="line">print(soup.find_all(id=<span class="literal">True</span>)) <span class="comment">#查找有id属性的标签</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 有些tag属性在搜索不能使用,比如HTML5中的 data-* 属性:</span></span><br><span class="line">data_soup = BeautifulSoup(<span class="string">'&lt;div data-foo="value"&gt;foo!&lt;/div&gt;'</span>,<span class="string">'lxml'</span>)</span><br><span class="line"><span class="comment"># data_soup.find_all(data-foo="value") #报错：SyntaxError: keyword can't be an expression</span></span><br><span class="line"><span class="comment"># 但是可以通过 find_all() 方法的 attrs 参数定义一个字典参数来搜索包含特殊属性的tag:</span></span><br><span class="line">print(data_soup.find_all(attrs=&#123;<span class="string">"data-foo"</span>: <span class="string">"value"</span>&#125;))</span><br><span class="line"><span class="comment"># [&lt;div data-foo="value"&gt;foo!&lt;/div&gt;]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#2.3、按照类名查找，注意关键字是class_，class_=value,value可以是五种选择器之一</span></span><br><span class="line">print(soup.find_all(<span class="string">'a'</span>,class_=<span class="string">'sister'</span>)) <span class="comment">#查找类为sister的a标签</span></span><br><span class="line">print(soup.find_all(<span class="string">'a'</span>,class_=<span class="string">'sister ssss'</span>)) <span class="comment">#查找类为sister和sss的a标签，顺序错误也匹配不成功</span></span><br><span class="line">print(soup.find_all(class_=re.compile(<span class="string">'^sis'</span>))) <span class="comment">#查找类为sister的所有标签</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#2.4、attrs</span></span><br><span class="line">print(soup.find_all(<span class="string">'p'</span>,attrs=&#123;<span class="string">'class'</span>:<span class="string">'story'</span>&#125;))</span><br><span class="line"></span><br><span class="line"><span class="comment">#2.5、text: 值可以是：字符，列表，True，正则</span></span><br><span class="line">print(soup.find_all(text=<span class="string">'Elsie'</span>))</span><br><span class="line">print(soup.find_all(<span class="string">'a'</span>,text=<span class="string">'Elsie'</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#2.6、limit参数:如果文档树很大那么搜索会很慢.如果我们不需要全部结果,可以使用 limit 参数限制返回结果的数量.效果与SQL中的limit关键字类似,当搜索到的结果数量达到 limit 的限制时,就停止搜索返回结果</span></span><br><span class="line">print(soup.find_all(<span class="string">'a'</span>,limit=<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#2.7、recursive:调用tag的 find_all() 方法时,Beautiful Soup会检索当前tag的所有子孙节点,如果只想搜索tag的直接子节点,可以使用参数 recursive=False .</span></span><br><span class="line">print(soup.html.find_all(<span class="string">'a'</span>))</span><br><span class="line">print(soup.html.find_all(<span class="string">'a'</span>,recursive=<span class="literal">False</span>))</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">像调用 find_all() 一样调用tag</span></span><br><span class="line"><span class="string">find_all() 几乎是Beautiful Soup中最常用的搜索方法,所以我们定义了它的简写方法. BeautifulSoup 对象和 tag 对象可以被当作一个方法来使用,这个方法的执行结果与调用这个对象的 find_all() 方法相同,下面两行代码是等价的:</span></span><br><span class="line"><span class="string">soup.find_all("a")</span></span><br><span class="line"><span class="string">soup("a")</span></span><br><span class="line"><span class="string">这两行代码也是等价的:</span></span><br><span class="line"><span class="string">soup.title.find_all(text=True)</span></span><br><span class="line"><span class="string">soup.title(text=True)</span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure><p><strong>3、find( name , attrs , recursive , text , \</strong>kwargs )**</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#3、find( name , attrs , recursive , text , **kwargs )</span></span><br><span class="line">find_all() 方法将返回文档中符合条件的所有tag,尽管有时候我们只想得到一个结果.比如文档中只有一个&lt;body&gt;标签,那么使用 find_all() 方法来查找&lt;body&gt;标签就不太合适, 使用 find_all 方法并设置 limit=<span class="number">1</span> 参数不如直接使用 find() 方法.下面两行代码是等价的:</span><br><span class="line"></span><br><span class="line">soup.find_all(<span class="string">'title'</span>, limit=<span class="number">1</span>)</span><br><span class="line"><span class="comment"># [&lt;title&gt;The Dormouse's story&lt;/title&gt;]</span></span><br><span class="line">soup.find(<span class="string">'title'</span>)</span><br><span class="line"><span class="comment"># &lt;title&gt;The Dormouse's story&lt;/title&gt;</span></span><br><span class="line"></span><br><span class="line">唯一的区别是 find_all() 方法的返回结果是值包含一个元素的列表,而 find() 方法直接返回结果.</span><br><span class="line">find_all() 方法没有找到目标是返回空列表, find() 方法找不到目标时,返回 <span class="literal">None</span> .</span><br><span class="line">print(soup.find(<span class="string">"nosuchtag"</span>))</span><br><span class="line"><span class="comment"># None</span></span><br><span class="line"></span><br><span class="line">soup.head.title 是 tag的名字 方法的简写.这个简写的原理就是多次调用当前tag的 find() 方法:</span><br><span class="line"></span><br><span class="line">soup.head.title</span><br><span class="line"><span class="comment"># &lt;title&gt;The Dormouse's story&lt;/title&gt;</span></span><br><span class="line">soup.find(<span class="string">"head"</span>).find(<span class="string">"title"</span>)</span><br><span class="line"><span class="comment"># &lt;title&gt;The Dormouse's story&lt;/title&gt;</span></span><br></pre></td></tr></table></figure><p><strong>4、其他方法</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>5、CSS选择器</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#该模块提供了select方法来支持css,详见官网:https://www.crummy.com/software/BeautifulSoup/bs4/doc/index.zh.html#id37</span></span><br><span class="line">html_doc = <span class="string">"""</span></span><br><span class="line"><span class="string">&lt;html&gt;&lt;head&gt;&lt;title&gt;The Dormouse's story&lt;/title&gt;&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">&lt;p class="title"&gt;</span></span><br><span class="line"><span class="string">    &lt;b&gt;The Dormouse's story&lt;/b&gt;</span></span><br><span class="line"><span class="string">    Once upon a time there were three little sisters; and their names were</span></span><br><span class="line"><span class="string">    &lt;a href="http://example.com/elsie" class="sister" id="link1"&gt;</span></span><br><span class="line"><span class="string">        &lt;span&gt;Elsie&lt;/span&gt;</span></span><br><span class="line"><span class="string">    &lt;/a&gt;</span></span><br><span class="line"><span class="string">    &lt;a href="http://example.com/lacie" class="sister" id="link2"&gt;Lacie&lt;/a&gt; and</span></span><br><span class="line"><span class="string">    &lt;a href="http://example.com/tillie" class="sister" id="link3"&gt;Tillie&lt;/a&gt;;</span></span><br><span class="line"><span class="string">    &lt;div class='panel-1'&gt;</span></span><br><span class="line"><span class="string">        &lt;ul class='list' id='list-1'&gt;</span></span><br><span class="line"><span class="string">            &lt;li class='element'&gt;Foo&lt;/li&gt;</span></span><br><span class="line"><span class="string">            &lt;li class='element'&gt;Bar&lt;/li&gt;</span></span><br><span class="line"><span class="string">            &lt;li class='element'&gt;Jay&lt;/li&gt;</span></span><br><span class="line"><span class="string">        &lt;/ul&gt;</span></span><br><span class="line"><span class="string">        &lt;ul class='list list-small' id='list-2'&gt;</span></span><br><span class="line"><span class="string">            &lt;li class='element'&gt;&lt;h1 class='yyyy'&gt;Foo&lt;/h1&gt;&lt;/li&gt;</span></span><br><span class="line"><span class="string">            &lt;li class='element xxx'&gt;Bar&lt;/li&gt;</span></span><br><span class="line"><span class="string">            &lt;li class='element'&gt;Jay&lt;/li&gt;</span></span><br><span class="line"><span class="string">        &lt;/ul&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">    and they lived at the bottom of a well.</span></span><br><span class="line"><span class="string">&lt;/p&gt;</span></span><br><span class="line"><span class="string">&lt;p class="story"&gt;...&lt;/p&gt;</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line">soup=BeautifulSoup(html_doc,<span class="string">'lxml'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#1、CSS选择器</span></span><br><span class="line">print(soup.p.select(<span class="string">'.sister'</span>))</span><br><span class="line">print(soup.select(<span class="string">'.sister span'</span>))</span><br><span class="line"></span><br><span class="line">print(soup.select(<span class="string">'#link1'</span>))</span><br><span class="line">print(soup.select(<span class="string">'#link1 span'</span>))</span><br><span class="line"></span><br><span class="line">print(soup.select(<span class="string">'#list-2 .element.xxx'</span>))</span><br><span class="line"></span><br><span class="line">print(soup.select(<span class="string">'#list-2'</span>)[<span class="number">0</span>].select(<span class="string">'.element'</span>)) <span class="comment">#可以一直select,但其实没必要,一条select就可以了</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2、获取属性</span></span><br><span class="line">print(soup.select(<span class="string">'#list-2 h1'</span>)[<span class="number">0</span>].attrs)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3、获取内容</span></span><br><span class="line">print(soup.select(<span class="string">'#list-2 h1'</span>)[<span class="number">0</span>].get_text())</span><br></pre></td></tr></table></figure><h3 id="五-修改文档树"><a href="#五-修改文档树" class="headerlink" title="五 修改文档树"></a>五 修改文档树</h3><h3 id="六-总结"><a href="#六-总结" class="headerlink" title="六 总结"></a>六 总结</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 总结:</span><br><span class="line">#1、推荐使用lxml解析库</span><br><span class="line">#2、讲了三种选择器:标签选择器,find与find_all，css选择器</span><br><span class="line">    1、标签选择器筛选功能弱,但是速度快</span><br><span class="line">    2、建议使用find,find_all查询匹配单个结果或者多个结果</span><br><span class="line">    3、如果对css选择器非常熟悉建议使用select</span><br><span class="line">#3、记住常用的获取属性attrs和文本值get_text()的方法</span><br></pre></td></tr></table></figure><h2 id="3-代理池搭建"><a href="#3-代理池搭建" class="headerlink" title="3 代理池搭建"></a>3 代理池搭建</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># github，下载免费代理池开源代码（建议读一下别人的代码）</span></span><br><span class="line"><span class="comment"># git clone git@github.com:jhao104/proxy_pool.git</span></span><br><span class="line"><span class="comment"># pycharm打开，修改配置文件（reids地址修改）</span></span><br><span class="line"><span class="comment"># 启动爬虫：</span></span><br><span class="line">python proxyPool.py schedule</span><br><span class="line"><span class="comment"># 启动服务：</span></span><br><span class="line">python3 proxyPool.py server</span><br><span class="line"></span><br><span class="line"><span class="comment"># 随机获取一个代理</span></span><br><span class="line">requests.get(<span class="string">"http://127.0.0.1:5010/get/"</span>).json()</span><br><span class="line"><span class="comment">#删除一个代理</span></span><br><span class="line">requests.get(<span class="string">"http://127.0.0.1:5010/delete/?proxy=&#123;&#125;"</span>.format(proxy))</span><br></pre></td></tr></table></figure><h2 id="4-验证码破解之-打码平台介绍"><a href="#4-验证码破解之-打码平台介绍" class="headerlink" title="4 验证码破解之-打码平台介绍"></a>4 验证码破解之-打码平台介绍</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1 验证码破解 图像处理</span></span><br><span class="line"><span class="comment"># 2 专业打码平台，破解验证码（收费）</span></span><br><span class="line"><span class="comment"># 申请超级鹰，注册</span></span><br><span class="line"><span class="comment"># 登录，下载sdk（代码如下），填入用户名密码，软件id</span></span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding:utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> md5</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Chaojiying_Client</span><span class="params">()</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, username, password, soft_id)</span>:</span></span><br><span class="line">        self.username = username</span><br><span class="line">        password =  password.encode(<span class="string">'utf8'</span>)</span><br><span class="line">        self.password = md5(password).hexdigest()</span><br><span class="line">        self.soft_id = soft_id</span><br><span class="line">        self.base_params = &#123;</span><br><span class="line">            <span class="string">'user'</span>: self.username,</span><br><span class="line">            <span class="string">'pass2'</span>: self.password,</span><br><span class="line">            <span class="string">'softid'</span>: self.soft_id,</span><br><span class="line">        &#125;</span><br><span class="line">        self.headers = &#123;</span><br><span class="line">            <span class="string">'Connection'</span>: <span class="string">'Keep-Alive'</span>,</span><br><span class="line">            <span class="string">'User-Agent'</span>: <span class="string">'Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 5.1; Trident/4.0)'</span>,</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">PostPic</span><span class="params">(self, im, codetype)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        im: 图片字节</span></span><br><span class="line"><span class="string">        codetype: 题目类型 参考 http://www.chaojiying.com/price.html</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        params = &#123;</span><br><span class="line">            <span class="string">'codetype'</span>: codetype,</span><br><span class="line">        &#125;</span><br><span class="line">        params.update(self.base_params)</span><br><span class="line">        files = &#123;<span class="string">'userfile'</span>: (<span class="string">'ccc.jpg'</span>, im)&#125;</span><br><span class="line">        r = requests.post(<span class="string">'http://upload.chaojiying.net/Upload/Processing.php'</span>, data=params, files=files, headers=self.headers)</span><br><span class="line">        <span class="keyword">return</span> r.json()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">ReportError</span><span class="params">(self, im_id)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        im_id:报错题目的图片ID</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        params = &#123;</span><br><span class="line">            <span class="string">'id'</span>: im_id,</span><br><span class="line">        &#125;</span><br><span class="line">        params.update(self.base_params)</span><br><span class="line">        r = requests.post(<span class="string">'http://upload.chaojiying.net/Upload/ReportError.php'</span>, data=params, headers=self.headers)</span><br><span class="line">        <span class="keyword">return</span> r.json()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    chaojiying = Chaojiying_Client(<span class="string">'306334678'</span>, <span class="string">'lqz12345'</span>, <span class="string">'903641'</span>)<span class="comment">#用户中心&gt;&gt;软件ID 生成一个替换 96001</span></span><br><span class="line">    im = open(<span class="string">'a.jpg'</span>, <span class="string">'rb'</span>).read()<span class="comment">#本地图片文件路径 来替换 a.jpg 有时WIN系统须要//</span></span><br><span class="line">    print(chaojiying.PostPic(im, <span class="number">1902</span>))<span class="comment">#1902 验证码类型  官方网站&gt;&gt;价格体系 3.4+版 print 后要加()</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;bs4模块&quot;&gt;&lt;a href=&quot;#bs4模块&quot; class=&quot;headerlink&quot; title=&quot;bs4模块&quot;&gt;&lt;/a&gt;bs4模块&lt;/h2&gt;&lt;h3 id=&quot;使用前戏&quot;&gt;&lt;a href=&quot;#使用前戏&quot; class=&quot;headerlink&quot; title=&quot;使用前戏&quot;
      
    
    </summary>
    
    
    
      <category term="爬虫" scheme="http://yoursite.com/tags/%E7%88%AC%E8%99%AB/"/>
    
  </entry>
  
  <entry>
    <title>基于python面向对象多人聊天室流程</title>
    <link href="http://yoursite.com/2019/09/09/%E5%9F%BA%E4%BA%8Epython%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E5%A4%9A%E4%BA%BA%E8%81%8A%E5%A4%A9%E5%AE%A4/"/>
    <id>http://yoursite.com/2019/09/09/%E5%9F%BA%E4%BA%8Epython%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E5%A4%9A%E4%BA%BA%E8%81%8A%E5%A4%A9%E5%AE%A4/</id>
    <published>2019-09-08T16:00:00.000Z</published>
    <updated>2020-08-19T12:46:20.609Z</updated>
    
    <content type="html"><![CDATA[<h2 id="项目环境"><a href="#项目环境" class="headerlink" title="项目环境"></a>项目环境</h2><ul><li><strong>项目环境</strong><ul><li>项目名称：多人聊天室</li><li>项目模式：C/S</li><li>开发环境：win10+python3.6+pycharm</li><li>所需知识：python GUI编程，多线程编程，网络编程，数据库编程</li></ul></li></ul><h2 id="程序设计"><a href="#程序设计" class="headerlink" title="程序设计"></a>程序设计</h2><p>了解一下服务器扮演的角色，下面是服务器的业务流程。大致是怎样工作的</p><ul><li>首先服务器在指定的端口进行监听，等待客户的链接</li><li>客户端链接到服务器之后，服务器开启单线程来处理该用户的请求</li><li>处理线程等待客户端发送的请求</li><li>服务器根据客户端请求类型的不同，调用不同处理的函数</li><li>处理完客户端请求之后，再次回到第三步继续等待处理客户端新的请求</li></ul><p>客户端退出登录，服务器也会关闭对客户端的处理线程，释放资源</p><p><img src="C:%5CUsers%5C%E5%B0%8F%E5%AD%90%5CDesktop%5C%E6%9C%AA%E5%91%BD%E5%90%8D%E6%96%87%E4%BB%B6(3).png" alt=""></p><h2 id="响应协议设计"><a href="#响应协议设计" class="headerlink" title="响应协议设计"></a>响应协议设计</h2><p>我们都知道三次握手和四次挥手，这里呢我们约定了客户端发送什么样格式的数据给服务器，服务器又需要返回什么样格式的数据给客户端，客户端会有不同的请求，所以我们针对不同的请求个响应定义了需求个相应号，来区分不同的请求和响应</p><p>网络上一般使用json和xml格式来传输数据，但是用他们来传输，对于我们的项目有点复杂，我们的项目没有这么复杂的数据，我们采用<code>|</code>进行分割 ，然后拿到数据进行<code>split</code>一下就可以了。</p><ul><li>登录响应格式: <code>1001|ret|nickname|username</code>,其中<code>ret</code> 代表服务器端验证的结果，如果是<code>0</code>,表示服务端验证失败，后面的<code>nickname username</code> 会为空字符串，若是<code>1</code> ，表示服务端验证成功，<code>nickname</code> 为服务端返回的该用户的昵称，<code>username</code> 是该用户的用户名。</li><li>聊天的响应格式：<code>1002|nickname|message</code>, <code>nicakname</code> 是为聊天信息发送者的昵称，<code>message</code> 是发送的聊天信息</li></ul><p>下面我们定义了服务端需要的一些常量，以及为了实现客户端和服务端通信定义的一些协议编号，协议编号如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">config.py</span><br><span class="line"><span class="comment"># ----服务器相关配置----</span></span><br><span class="line">SERVER_IP = <span class="string">'127.0.0.1'</span>  <span class="comment"># 服务器IP地址</span></span><br><span class="line">SERVER_PORT = <span class="number">8090</span>  <span class="comment"># 服务器端口号</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ----数据协议相关配置----</span></span><br><span class="line">REQUEST_LOGIN = <span class="string">'0001'</span>  <span class="comment"># 登录请求</span></span><br><span class="line">REQUEST_CHAT = <span class="string">'0002'</span>  <span class="comment"># 聊天请求</span></span><br><span class="line">RESPONSE_LOGIN_RESULT = <span class="string">'1001'</span>  <span class="comment"># 登录结果响应</span></span><br><span class="line">RESPONSE_CHAT = <span class="string">'1002'</span>  <span class="comment"># 聊天响应</span></span><br><span class="line">DELIMITER = <span class="string">'|'</span>  <span class="comment"># 自定义协议数据分隔符</span></span><br></pre></td></tr></table></figure><h2 id="面向对象的思想"><a href="#面向对象的思想" class="headerlink" title="面向对象的思想"></a>面向对象的思想</h2><p><img src="C:%5CUsers%5C%E5%B0%8F%E5%AD%90%5CDesktop%5C6542225df68080716bed0ceb3e072d00.png" alt=""></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;项目环境&quot;&gt;&lt;a href=&quot;#项目环境&quot; class=&quot;headerlink&quot; title=&quot;项目环境&quot;&gt;&lt;/a&gt;项目环境&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;项目环境&lt;/strong&gt;&lt;ul&gt;
&lt;li&gt;项目名称：多人聊天室&lt;/li&gt;
&lt;li&gt;项目模式：C
      
    
    </summary>
    
    
    
      <category term="python" scheme="http://yoursite.com/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>魔法方法</title>
    <link href="http://yoursite.com/2019/08/07/%E9%AD%94%E6%B3%95%E6%96%B9%E6%B3%95/"/>
    <id>http://yoursite.com/2019/08/07/%E9%AD%94%E6%B3%95%E6%96%B9%E6%B3%95/</id>
    <published>2019-08-06T16:00:00.000Z</published>
    <updated>2020-07-10T02:45:35.119Z</updated>
    
    <content type="html"><![CDATA[<h2 id="魔法方法"><a href="#魔法方法" class="headerlink" title="魔法方法"></a>魔法方法</h2><p>1.<code>__init__</code>类在实例化的时候会触发它的执行</p><p>2.<code>__str__</code>打印对象的时候会触发</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, age)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.name</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">a = A(<span class="string">'张三'</span>, <span class="number">24</span>)</span><br><span class="line"></span><br><span class="line">print(a)</span><br></pre></td></tr></table></figure><p>其实打印<code>a</code> 这个对象的时候，调用的就是<code>a.__str__</code>这个方法，先找自己类里面有没有<code>__str__</code>这个方法，没有就到object去找，object里面的<code>__str__</code>一旦被调用，返回的就是这个方法的内存地址</p><p>3.<code>__repr__</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, age)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line"></span><br><span class="line">    <span class="comment"># def __str__(self):</span></span><br><span class="line">    <span class="comment">#     return self.name</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.name</span><br><span class="line"></span><br><span class="line">a = A(<span class="string">'张三'</span>, <span class="number">24</span>)</span><br><span class="line">print(a)</span><br><span class="line">print(str(a))</span><br><span class="line">print(repr(a))</span><br></pre></td></tr></table></figure><p><code>__repr__</code> 是<code>__str__</code>的备胎，当你注释掉<code>__str__</code>，他就会启用<code>__repr__</code>,但是当你注释掉<code>__repr__</code></p><p><code>print(repr(a))</code>打印的是object里面repr 的内存地址</p><p>4.<code>__call__</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,name)</span>:</span></span><br><span class="line">        self.name =name </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> self.__dict__:</span><br><span class="line">            print(k,self.__dict__[k])</span><br><span class="line">a = A(<span class="string">'aax'</span>)</span><br><span class="line">a()</span><br><span class="line">a = A(<span class="string">'aax'</span>)()</span><br></pre></td></tr></table></figure><p>a()对象加一个括号就是调用<code>__call__</code></p><p>5.item系列</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, age, sex)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line">        self.sex = sex</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span><span class="params">(self, item)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> hasattr(self,item):</span><br><span class="line">            <span class="keyword">return</span> self.__dict__[item]</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setitem__</span><span class="params">(self, key, value)</span>:</span></span><br><span class="line">        self.__dict__[key] = value</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__delitem__</span><span class="params">(self, key)</span>:</span></span><br><span class="line">        <span class="keyword">del</span> self.__dict__[key]</span><br><span class="line">f = Foo(<span class="string">'zz'</span>, <span class="string">'38'</span>, <span class="string">'男'</span>)</span><br><span class="line">print(f[<span class="string">'name'</span>])</span><br><span class="line">f[<span class="string">'hobby'</span>] = <span class="string">'base'</span></span><br><span class="line">print(f.hobby,f[<span class="string">'hobby'</span>])</span><br><span class="line">print(f.__dict__)</span><br><span class="line"><span class="keyword">del</span> f[<span class="string">'hobby'</span>] <span class="comment"># 自己实现的</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f</span>.<span class="title">name</span> # <span class="title">object</span> 原生支持的 <span class="title">__delattr__</span></span></span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(f.__dict__)</span></span></span><br></pre></td></tr></table></figure><p>以前我们查找属性 只能f.name并不能像字典那样f[‘name’],我们可以用item自定义我们自己的</p><p>6 <code>__new__</code>构造方法，创建一个对象</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">class A:</span><br><span class="line">    def __init__(self):</span><br><span class="line">        self.x &#x3D; 1</span><br><span class="line">        print(&#39;in init function&#39;)</span><br><span class="line"></span><br><span class="line">    def __new__(cls, *args, **kwargs):</span><br><span class="line">        print(&#39;in new function&#39;)</span><br><span class="line">        return object.__new__(A, *args, **kwargs)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">a &#x3D; A()</span><br><span class="line">print(a.x)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">in new function</span><br><span class="line">in init function</span><br><span class="line">1</span><br></pre></td></tr></table></figure><p>new创建self，在我们执行new的时候还没有self，所以new只能默认传类，这个时候<code>__new__</code>也没有self，借助object.<strong>new</strong>(A, <em>args, *</em>kwargs)创建一个新的对象，return给<strong>init</strong>   self。 (<strong>new</strong>就是一个新的裸体的人，<strong>init</strong>就是穿了衣服的人)</p><p>7 <code>__eq__</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,x,y)</span>:</span></span><br><span class="line">        self.x=x</span><br><span class="line">        self.y = y</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__eq__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self.x + self.y == other.x + other.y:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">a = A(<span class="number">1</span>,<span class="number">2</span>)</span><br><span class="line">b = A(<span class="number">99</span>,<span class="number">33</span>)</span><br><span class="line">print(a == b)</span><br><span class="line"><span class="literal">False</span></span><br></pre></td></tr></table></figure><p>正常的情况是比较内存地址，我们重新定制这个eq方法会用我们定制的</p><p>8.<code>__getattr__</code>和<code>__setattr__</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setattr__</span><span class="params">(self, key, value)</span>:</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> type(value) <span class="keyword">is</span> str:</span><br><span class="line">            self.__dict__[key] = value</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(<span class="string">'必须是字符串'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, item)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self[item]</span><br><span class="line"></span><br><span class="line">a = A(<span class="string">'123'</span>)</span><br><span class="line">a.name = <span class="number">121</span></span><br><span class="line">print(a.name)</span><br></pre></td></tr></table></figure><p><code>__getattr__</code>和<code>__setattr__</code>是 .拦截方法,不能用a[‘name’] ,对象.属性会调用<strong>setattr</strong>，当我们赋值的时候如果不是字符串它返回的是信息是必须是字符串，当我们用a.name修改属性值的时候如果不是字符串，返回的也是必须是字符串，当我们打印的时候就是123</p><p>9 上下文管理</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'我在管理的时候会触发'</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'xx'</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, exc_type, exc_val, exc_tb)</span>:</span></span><br><span class="line">        print(<span class="string">'我用完了'</span>)</span><br><span class="line">        print(<span class="string">'1'</span>,exc_type)</span><br><span class="line">        print(<span class="string">'2'</span>,exc_val)</span><br><span class="line">        print(<span class="string">'3'</span>,exc_tb)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> A() <span class="keyword">as</span> f:<span class="comment"># 触发类__enter__</span></span><br><span class="line">    print(f)</span><br><span class="line"><span class="comment"># 当管理完了，会触发__exit__</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;魔法方法&quot;&gt;&lt;a href=&quot;#魔法方法&quot; class=&quot;headerlink&quot; title=&quot;魔法方法&quot;&gt;&lt;/a&gt;魔法方法&lt;/h2&gt;&lt;p&gt;1.&lt;code&gt;__init__&lt;/code&gt;类在实例化的时候会触发它的执行&lt;/p&gt;
&lt;p&gt;2.&lt;code&gt;__str__&lt;
      
    
    </summary>
    
    
    
      <category term="python" scheme="http://yoursite.com/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>git的使用</title>
    <link href="http://yoursite.com/2019/08/07/git%E7%9A%84%E4%BD%BF%E7%94%A8/"/>
    <id>http://yoursite.com/2019/08/07/git%E7%9A%84%E4%BD%BF%E7%94%A8/</id>
    <published>2019-08-06T16:00:00.000Z</published>
    <updated>2020-07-10T09:09:36.018Z</updated>
    
    <content type="html"><![CDATA[<h2 id="git的使用"><a href="#git的使用" class="headerlink" title="git的使用"></a>git的使用</h2><h2 id="git和github-的区别"><a href="#git和github-的区别" class="headerlink" title="git和github 的区别"></a>git和github 的区别</h2><ul><li>Git 是一种方法。而 GitHub 只是使用这种方法的一个代码仓库，就是git是操作的，GitHub是个网址</li></ul><h2 id="初始化git仓储"><a href="#初始化git仓储" class="headerlink" title="初始化git仓储"></a>初始化git仓储</h2><p>新建一个项目project，点进目录右击选择<strong>git bash</strong></p><p><img src="C:%5CUsers%5C%E5%B0%8F%E5%AD%90%5CDesktop%5C1589027002(1).jpg" alt="1589027002(1)"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git init <span class="comment"># 初始化仓库，这个git对我们项目的代码进行备份</span></span><br></pre></td></tr></table></figure><p><strong>配置用户名和邮箱</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git config --<span class="keyword">global</span>   user.name <span class="string">"xiaoming"</span> <span class="comment"># 用户名</span></span><br><span class="line"></span><br><span class="line">git config --<span class="keyword">global</span> user.email  <span class="string">"xx@sina.com"</span> <span class="comment"># 邮箱</span></span><br></pre></td></tr></table></figure><p><strong>把代码存储到 git 仓储中</strong></p><ul><li><p><strong>分两步走：</strong></p><ul><li><p>把代码放到<code>.git</code>隐藏目录的大门(暂存区)</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git add ./readme.md <span class="comment"># ./readme.md 文件路径要说明</span></span><br></pre></td></tr></table></figure></li><li><p>把门口的代码放入房间里面</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git commit -m <span class="string">"这是对这次添加东西的说明"</span></span><br></pre></td></tr></table></figure></li></ul></li></ul><p><strong>区域划分：</strong></p><ul><li><strong>工作区</strong>：就是你在电脑里能看到的目录，比如我的learngit文件夹就是一个工作区。</li><li><strong>版本库</strong>：工作区有一个隐藏目录.git，这个不算工作区，而是Git的版本库。</li><li><strong>暂存区</strong>：Git的版本库里存了很多东西，其中最重要的就是称为stage（或者叫index）的暂存区，还有Git为我们自动创建的第一个分支master。</li></ul><p><strong>查询当前所处的工作状态</strong>：<code>git status</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">On branch master</span><br><span class="line">nothing to commit, working tree clean</span><br><span class="line"><span class="comment"># 我们提交完了，当前的工作区是干净的</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(use <span class="string">"git add &lt;file&gt;..."</span> to update what will be committed)</span><br><span class="line">  (use <span class="string">"git checkout -- &lt;file&gt;..."</span> to discard changes <span class="keyword">in</span> working directory)</span><br><span class="line"></span><br><span class="line">modified:   readme.txt</span><br><span class="line"><span class="comment"># 把文件放在了暂存区</span></span><br><span class="line"></span><br><span class="line">(use <span class="string">"git add &lt;file&gt;..."</span> to update what will be committed)</span><br><span class="line">(use <span class="string">"git checkout -- &lt;file&gt;..."</span> to discard changes <span class="keyword">in</span> working directory)</span><br><span class="line"></span><br><span class="line">modified:   readme.txt</span><br><span class="line"><span class="comment"># 我们的文件修改了，但是没有放到暂存区(大门口)</span></span><br></pre></td></tr></table></figure><p>如果我们修改了两个文件是不是要add两次命令呢，不需要</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git add ./ <span class="comment"># 当前目录只要是修改过的文件都放到暂存区</span></span><br></pre></td></tr></table></figure><p>一次性把我们修改的代码放到房子里面去</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git commit --all -m <span class="string">"一些说明"</span></span><br></pre></td></tr></table></figure><p><strong>查看日志</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git log <span class="comment"># 查看历史提交的日志</span></span><br><span class="line">git log --oneline <span class="comment"># 简洁版的日志</span></span><br></pre></td></tr></table></figure><p><strong>git 版本回退</strong></p><p>先用日志功能查看我们修改过的功能，在选择回退的版本</p><p>修改过后的版本日志</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ git log --oneline</span><br><span class="line">489310a (HEAD -&gt; master) 添加了js和一个功能</span><br><span class="line"><span class="number">01</span>ebf78 我们完成四个功能</span><br><span class="line"><span class="number">20e8</span>c3c 我们完成三个功能</span><br><span class="line">bc9c3b5 这次加了一个功能</span><br><span class="line"><span class="number">6</span>dad8ac 这是我的开始</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git reset --hard Head~<span class="number">1</span>  <span class="comment"># 1 表示退回到上上次代码提交的状态</span></span><br><span class="line"> <span class="comment"># 0 表示上一次</span></span><br></pre></td></tr></table></figure><p>退回后的版本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">01ebf78 (HEAD -&gt; master) 我们完成四个功能</span><br><span class="line"><span class="number">20e8</span>c3c 我们完成三个功能</span><br><span class="line">bc9c3b5 这次加了一个功能</span><br><span class="line"><span class="number">6</span>dad8ac 这是我的开始</span><br></pre></td></tr></table></figure><p><strong>通过版本号回退</strong><br>查看日志</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ git log --oneline</span><br><span class="line">489310a (HEAD -&gt; master) 添加了js和一个功能</span><br><span class="line"><span class="number">01</span>ebf78 我们完成四个功能 <span class="comment"># 01ebf78版本号</span></span><br><span class="line"><span class="number">20e8</span>c3c 我们完成三个功能 <span class="comment"># 20e8c3c版本号</span></span><br><span class="line">bc9c3b5 这次加了一个功能</span><br><span class="line"><span class="number">6</span>dad8ac 这是我的开始</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git -reset --hard <span class="number">01</span>ebf78 <span class="comment"># 精确的回退到某一次的提交状态</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">01ebf78 (HEAD -&gt; master) 我们完成四个功能</span><br><span class="line"><span class="number">20e8</span>c3c 我们完成三个功能</span><br><span class="line">bc9c3b5 这次加了一个功能</span><br><span class="line"><span class="number">6</span>dad8ac 这是我的开始</span><br></pre></td></tr></table></figure><p>假如说我们退回之后又后悔之前的操作咋办呢？</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git -reset --hard <span class="number">01</span>ebf78 <span class="comment"># 精确的回退到某一次的提交状态</span></span><br></pre></td></tr></table></figure><p>但是如果我们把窗口关掉了，记不住版本号，又想回到以前的状态咋办呢</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git reflog  <span class="comment"># 可以看到每一次切换的版本的记录，可以看到所有提交的版本号</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">01ebf78 (HEAD -&gt; master) HEAD@&#123;0&#125;: reset: moving to Head~1</span><br><span class="line"><span class="number">489310</span>a HEAD@&#123;<span class="number">1</span>&#125;: commit: 添加了js和一个功能</span><br><span class="line">01ebf78 (HEAD -&gt; master) HEAD@&#123;2&#125;: commit: 我们完成四个功能</span><br><span class="line"><span class="number">20e8</span>c3c HEAD@&#123;<span class="number">3</span>&#125;: commit: 我们完成三个功能</span><br><span class="line">bc9c3b5 HEAD@&#123;<span class="number">4</span>&#125;: commit: 这次加了一个功能</span><br><span class="line"><span class="number">6</span>dad8ac HEAD@&#123;<span class="number">5</span>&#125;: commit (initial): 这是我的开始</span><br></pre></td></tr></table></figure><h2 id="分支管理"><a href="#分支管理" class="headerlink" title="分支管理"></a>分支管理</h2><p><strong>主分支：默认的是master</strong></p><p><strong>创建分支：</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git branch dev <span class="comment"># 创建了一个dev分支 创建dev分支里面的东西和master分支的东西是一样的</span></span><br></pre></td></tr></table></figure><p><strong>切换分支：</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout dev <span class="comment"># 切换到指定分支</span></span><br></pre></td></tr></table></figure><p><strong>查看分支：</strong> </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">git branch</span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">$ git branch</span></span><br><span class="line"><span class="string">  dec</span></span><br><span class="line"><span class="string">  dev</span></span><br><span class="line"><span class="string">* master # 当前所在分支</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure><p><strong>合并分支：</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git merge dev <span class="comment"># 指定分支的名称</span></span><br></pre></td></tr></table></figure><p>比如我们我们创建分支，在分支里面已经完成了我们的功能五，但是当我们去切换到master的时候我们忘记在分支里面添加了功能五，又在master里完成了功能五，当我们去合并的时候会出现</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ git merge dev</span><br><span class="line">Auto-merging readme.md</span><br><span class="line">CONFLICT (content): Merge conflict <span class="keyword">in</span> readme.md</span><br><span class="line">Automatic merge failed; fix conflicts <span class="keyword">and</span> then commit the result.</span><br></pre></td></tr></table></figure><p>合并的时候如果有冲突，需要手动去处理，如何去处理呢，那就是要到你完成的功能里面去选择，处理完后还需要再提交一次。</p><h2 id="远程仓库"><a href="#远程仓库" class="headerlink" title="远程仓库"></a>远程仓库</h2><p><strong>提交代码到GitHub</strong>（当作git的服务器）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git push [地址] master <span class="comment">#</span></span><br></pre></td></tr></table></figure><p><strong>拿到远程的代码</strong></p><p>首先要建立一个新的仓储</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git push https://github.com/zc117809/test112.git master</span><br></pre></td></tr></table></figure><p><strong>克隆</strong></p><p>要先建立一个文件，在文件里打开<strong>git bash</strong>输入</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/zc117809/test112.git</span><br></pre></td></tr></table></figure><p>多次执行会覆盖本地的内容</p><h3 id="ssh-方式上传代码"><a href="#ssh-方式上传代码" class="headerlink" title="ssh 方式上传代码"></a>ssh 方式上传代码</h3><p>有公钥和私钥，这两个是有关联的</p><ul><li><p>生成公钥和私钥</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -kegen -t rsa -c <span class="string">"邮箱"</span></span><br></pre></td></tr></table></figure></li></ul><h2 id="多人协作"><a href="#多人协作" class="headerlink" title="多人协作"></a>多人协作</h2><p>小明和小红现在同时写作开发，小红在服务器上pull到小明的数据，pull完之后，小红在html文件上做了一个功能，备份到本地，这个时候小明又更新了版本，小红又去pull这个时候会出现冲突，小红新添加的功能会和小明更新的版本上出现错乱。</p><p><strong>总结：</strong></p><ul><li>查看远程库信息，使用<code>git remote -v</code>；</li><li>本地新建的分支如果不推送到远程，对其他人就是不可见的；</li><li>从本地推送分支，使用<code>git push origin branch-name</code>，如果推送失败，先用<code>git pull</code>抓取远程的新提交；</li><li>在本地创建和远程分支对应的分支，使用<code>git checkout -b branch-name origin/branch-name</code>，本地和远程分支的名称最好一致；</li><li>建立本地分支和远程分支的关联，使用<code>git branch --set-upstream branch-name origin/branch-name</code>；</li><li>从远程抓取分支，使用<code>git pull</code>，如果有冲突，要先处理冲突。</li><li>解决完之后还要上传到服务器push</li></ul><p>当我们push时，加上-u参数，在下一次push时我们只需要写上<code>git push</code> 就能上传我们的代码(加上-u之后，git拉取当前我们分支与远程指定的分支进行关联，<code>git push origin master</code>)</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;git的使用&quot;&gt;&lt;a href=&quot;#git的使用&quot; class=&quot;headerlink&quot; title=&quot;git的使用&quot;&gt;&lt;/a&gt;git的使用&lt;/h2&gt;&lt;h2 id=&quot;git和github-的区别&quot;&gt;&lt;a href=&quot;#git和github-的区别&quot; class=&quot;
      
    
    </summary>
    
    
    
      <category term="python" scheme="http://yoursite.com/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>JWT</title>
    <link href="http://yoursite.com/2018/01/13/9.JWT/"/>
    <id>http://yoursite.com/2018/01/13/9.JWT/</id>
    <published>2018-01-12T16:00:00.000Z</published>
    <updated>2020-08-19T12:49:14.974Z</updated>
    
    <content type="html"><![CDATA[<h2 id="JWT"><a href="#JWT" class="headerlink" title="JWT"></a>JWT</h2><p><img src="https://pythonav.com/media/uploads/2019/11/14/image-20191112150846485.png" alt="img"></p><h3 id="传统token和jwt认证的区别"><a href="#传统token和jwt认证的区别" class="headerlink" title="传统token和jwt认证的区别"></a>传统token和jwt认证的区别</h3><ul><li><p>基于传统的token认证方式</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">用户登录， 服务端给返回token,并将token保存在服务端</span><br><span class="line">以后在访问的时候，需要携带token，服务端获取token后，再去数据库获取token校验</span><br></pre></td></tr></table></figure></li></ul><ul><li><p>JWT</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">用户登录，服务端给用户返回一个token（服务端不保存）</span><br><span class="line">以后访问的时候，需要携带token，在服务端获取token，在做token的校验</span><br><span class="line">优势：相较于传统的token相比，在无需保存在服务端token</span><br></pre></td></tr></table></figure><h3 id="Jwt实现的过程"><a href="#Jwt实现的过程" class="headerlink" title="Jwt实现的过程"></a>Jwt实现的过程</h3></li></ul><p>jwt的生成token格式如下，即：由 <code>.</code> 连接的三段字符串组成。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c</span><br></pre></td></tr></table></figure><p>生成规则</p><ul><li><p>第一段：HEADER部分，固定包含算法和token类型，对此json进行base64url加密，这就是token的第一段。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"alg"</span>: <span class="string">"HS256"</span>,</span><br><span class="line">  <span class="string">"typ"</span>: <span class="string">"JWT"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>第二段: PAYLOAD部分，包含一些数据，对此json进行base64url加密，这就是token的第二段。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"sub"</span>: <span class="string">"1234567890"</span>,</span><br><span class="line">  <span class="string">"name"</span>: <span class="string">"John Doe"</span>,</span><br><span class="line">  <span class="string">"iat"</span>: <span class="number">1516239022</span></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>第三段： SIGNATURE部分，把前两段的base密文通过<code>.</code>拼接起来，然后对其进行<code>HS256</code>加密，再然后对<code>hs256</code>密文进行base64url加密，最终得到token的第三段。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">base64url(</span><br><span class="line">    HMACSHA256(</span><br><span class="line">      base64UrlEncode(header) + <span class="string">"."</span> + base64UrlEncode(payload),</span><br><span class="line">      your<span class="number">-256</span>-bit-secret (秘钥加盐)</span><br><span class="line">    )</span><br><span class="line">)</span><br></pre></td></tr></table></figure></li></ul><p>最后将三段字符串通过 <code>.</code>拼接起来就生成了jwt的token</p><p><strong>注意</strong>：base64url加密是先做base64加密，然后再将 <code>-</code> 替代 <code>+</code> 及 <code>_</code> 替代 <code>/</code> 。</p><h3 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h3><p>我们可以先用pyjwt，后面用<code>rest_framework_jwt</code>实现</p><ul><li><p>实现</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> jwt <span class="keyword">import</span> exceptions</span><br><span class="line">SALT = <span class="string">'iv%x6xo7l7_u9bf_u!9#g#m*)*=ej@bek5)(@u3kh*72+unjv='</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_token</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># 构造header</span></span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">'typ'</span>: <span class="string">'jwt'</span>,</span><br><span class="line">        <span class="string">'alg'</span>: <span class="string">'HS256'</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># 构造payload</span></span><br><span class="line">    payload = &#123;</span><br><span class="line">        <span class="string">'user_id'</span>: <span class="number">1</span>, <span class="comment"># 自定义用户ID</span></span><br><span class="line">        <span class="string">'username'</span>: <span class="string">'wupeiqi'</span>, <span class="comment"># 自定义用户名</span></span><br><span class="line">        <span class="string">'exp'</span>: datetime.datetime.utcnow() + datetime.timedelta(minutes=<span class="number">5</span>) <span class="comment"># 超时时间</span></span><br><span class="line">    &#125;</span><br><span class="line">    result = jwt.encode(payload=payload, key=SALT, algorithm=<span class="string">"HS256"</span>, headers=headers).decode(<span class="string">'utf-8'</span>)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    token = create_token()</span><br><span class="line">    print(token)</span><br></pre></td></tr></table></figure></li></ul><h3 id="jwt校验token"><a href="#jwt校验token" class="headerlink" title="jwt校验token"></a>jwt校验token</h3><p>一般在认证成功后，把jwt生成的token返回给用户，以后用户再次访问时候需要携带token，此时jwt需要对token进行<code>超时</code>及<code>合法性</code>校验。</p><p>获取token之后，会按照以下步骤进行校验：</p><ul><li><p>将token分割成 <code>header_segment</code>、<code>payload_segment</code>、<code>crypto_segment</code> 三部分</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">jwt_token = <span class="string">"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c"</span></span><br><span class="line">signing_input, crypto_segment = jwt_token.rsplit(<span class="string">b'.'</span>, <span class="number">1</span>)</span><br><span class="line">header_segment, payload_segment = signing_input.split(<span class="string">b'.'</span>, <span class="number">1</span>)</span><br></pre></td></tr></table></figure></li><li><p>对第一部分<code>header_segment</code>进行base64url解密，得到<code>header</code></p></li><li><p>对第二部分<code>payload_segment</code>进行base64url解密，得到<code>payload</code></p></li><li><p>对第三部分<code>crypto_segment</code>进行base64url解密，得到<code>signature</code></p></li><li><p>对第三部分<code>signature</code>部分数据进行合法性校验</p><ul><li>拼接前两段密文，即：<code>signing_input</code></li><li>从第一段明文中获取加密算法，默认：<code>HS256</code></li><li>使用 算法+盐 对<code>signing_input</code> 进行加密，将得到的结果和<code>signature</code>密文进行比较。</li></ul></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> jwt <span class="keyword">import</span> exceptions</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_payload</span><span class="params">(token)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    根据token获取payload</span></span><br><span class="line"><span class="string">    :param token:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 从token中获取payload【不校验合法性】</span></span><br><span class="line">        <span class="comment"># unverified_payload = jwt.decode(token, None, False)</span></span><br><span class="line">        <span class="comment"># print(unverified_payload)</span></span><br><span class="line">        <span class="comment"># 从token中获取payload【校验合法性】</span></span><br><span class="line">        verified_payload = jwt.decode(token, SALT, <span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> verified_payload</span><br><span class="line">    <span class="keyword">except</span> exceptions.ExpiredSignatureError:</span><br><span class="line">        print(<span class="string">'token已失效'</span>)</span><br><span class="line">    <span class="keyword">except</span> jwt.DecodeError:</span><br><span class="line">        print(<span class="string">'token认证失败'</span>)</span><br><span class="line">    <span class="keyword">except</span> jwt.InvalidTokenError:</span><br><span class="line">        print(<span class="string">'非法的token'</span>)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    token = <span class="string">"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE1NzM1NTU1NzksInVzZXJuYW1lIjoid3VwZWlxaSIsInVzZXJfaWQiOjF9.xj-7qSts6Yg5Ui55-aUOHJS4KSaeLq5weXMui2IIEJU"</span></span><br><span class="line">    payload = get_payload(token)</span><br></pre></td></tr></table></figure><h3 id="jwt认证算法：签发和校验"><a href="#jwt认证算法：签发和校验" class="headerlink" title="jwt认证算法：签发和校验"></a>jwt认证算法：签发和校验</h3><ul><li><p>签发 ：根据登录请求提交来的账号，密码，设备信息签发token</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>）用基本信息存储json字典，采用base64算法加密得到 头字符串</span><br><span class="line"><span class="number">2</span>）用关键信息存储json字典，采用base64算法加密得到 体字符串</span><br><span class="line"><span class="number">3</span>）用头、体加密字符串再加安全码信息存储json字典，采用hash md5算法加密得到 签名字符串</span><br><span class="line"></span><br><span class="line">账号密码就能根据User表得到user对象，形成的三段字符串用 . 拼接成token返回给前台</span><br></pre></td></tr></table></figure></li></ul><ul><li><p>校验：根据客户端带来的token的请求，反解出user对象</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>）将token按 . 拆分为三段字符串，第一段 头加密字符串 一般不需要做任何处理</span><br><span class="line"><span class="number">2</span>）第二段 体加密字符串，要反解出用户主键，通过主键从User表中就能得到登录用户，过期时间和设备信息都是安全信息，确保token没过期，且时同一设备来的</span><br><span class="line"><span class="number">3</span>）再用 第一段 + 第二段 + 服务器安全码 不可逆md5加密，与第三段 签名字符串 进行碰撞校验，通过后才能代表第二段校验得到的user对象就是合法的登录用户</span><br></pre></td></tr></table></figure></li></ul><h3 id="认证的流程开发"><a href="#认证的流程开发" class="headerlink" title="认证的流程开发"></a>认证的流程开发</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>）用账号密码访问登录接口，登录接口逻辑中调用 签发token 算法，得到token，返回给客户端，客户端自己存到cookies中</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>）校验token的算法应该写在认证类中(在认证类中调用)，全局配置给认证组件，所有视图类请求，都会进行认证校验，所以请求带了token，就会反解出user对象，在视图类中用request.user就能访问登录的用户</span><br><span class="line"></span><br><span class="line">注：登录接口需要做 认证 + 权限 两个局部禁用</span><br></pre></td></tr></table></figure><h2 id="drf-jwt安装和使用"><a href="#drf-jwt安装和使用" class="headerlink" title="drf jwt安装和使用"></a>drf jwt安装和使用</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pip install djangorestframework-jwt</span><br><span class="line"><span class="comment"># 1 创建超级用户</span></span><br><span class="line">python3 manage.py createsuperuser</span><br><span class="line"><span class="comment"># 2 配置路由urls.py</span></span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path</span><br><span class="line"><span class="keyword">from</span> rest_framework_jwt.views <span class="keyword">import</span> obtain_jwt_token</span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">'login/'</span>, obtain_jwt_token),</span><br><span class="line">]</span><br><span class="line"><span class="comment"># 3 postman测试</span></span><br><span class="line">向后端接口发送post请求，携带用户名密码，即可看到生成的token</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4 setting.py中配置认证使用jwt提供的jsonwebtoken</span></span><br><span class="line"><span class="comment"># 5 postman发送访问请求（必须带jwt空格）</span></span><br></pre></td></tr></table></figure><h3 id="使用全套的djangorestframework-jwt-内置权限类"><a href="#使用全套的djangorestframework-jwt-内置权限类" class="headerlink" title="使用全套的djangorestframework-jwt(内置权限类)"></a>使用全套的djangorestframework-jwt(内置权限类)</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># urls.py</span></span><br><span class="line"><span class="keyword">from</span> rest_framework_jwt.views <span class="keyword">import</span> obtain_jwt_token</span><br><span class="line">urlpatterns = [</span><br><span class="line"></span><br><span class="line">    path(<span class="string">'login/'</span>,obtain_jwt_token),</span><br><span class="line">    path(<span class="string">'order/'</span>,views.OrderView.as_view())</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># views.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderView</span><span class="params">(GenericAPIView)</span>:</span></span><br><span class="line">    authentication_classes = [JSONWebTokenAuthentication]</span><br><span class="line">    permission_classes = [IsAuthenticated] <span class="comment"># 加上游客不能访问，不加游客能访问</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> Response(<span class="string">'订单信息'</span>)</span><br></pre></td></tr></table></figure><ul><li>这里的登录视图rest_framework_jwt帮我们在内部做了视图，我们只需要在配置一个登录的路由去调用它就可以了</li><li>关于视图里面的函数做认证，我们需要配置一个内置用户访问权限限制，JSONWebTokenAuthentication和IsAuthenticated才是一套的控制登录用户访问，</li><li>JSONWebTokenAuthentication加这个游客是可以访问的，校验规则：这里里面必须填authenticate，jwt空格传，才解析，如果不传不解析，到request里面没有东西，</li></ul><h3 id="控制登录接口返回的数据格式"><a href="#控制登录接口返回的数据格式" class="headerlink" title="控制登录接口返回的数据格式"></a>控制登录接口返回的数据格式</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> 自己写登录接口</span><br><span class="line"><span class="number">2.</span> 用内置，控制返回的数据格式</span><br><span class="line">-jwt的配置信息中有这个属性</span><br><span class="line"><span class="string">'JWT_RESPONSE_PAYLOAD_HANDLER'</span>:</span><br><span class="line"><span class="string">'rest_framework_jwt.utils.jwt_response_payload_handler'</span>,</span><br><span class="line">-重写jwt_response_payload_handler，配置成咱们自己的</span><br></pre></td></tr></table></figure><ul><li><p>用内置，控制返回的数据格式</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">第一步：</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderView</span><span class="params">(GenericAPIView)</span>:</span></span><br><span class="line">    authentication_classes = [JSONWebTokenAuthentication]</span><br><span class="line">    permission_classes = [IsAuthenticated]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> Response(<span class="string">'订单信息'</span>)</span><br><span class="line"></span><br><span class="line">第二步：</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">jwt_response_payload_handler</span><span class="params">(token, user=None, request=None)</span>:</span>  <span class="comment"># 返回什么样式，前端就是上面样式</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">'token'</span>: token,</span><br><span class="line">        <span class="string">'msg'</span>: <span class="string">'登录成功'</span>,</span><br><span class="line">        <span class="string">'status'</span>: <span class="number">100</span>,</span><br><span class="line">        <span class="string">'username'</span>: user.username</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">第三步：在自己的settings配置</span><br><span class="line">JWT_AUTH = &#123;</span><br><span class="line">    <span class="string">'JWT_RESPONSE_PAYLOAD_HANDLER'</span>:<span class="string">'api.utils.ahth.jwt_response_payload_handler'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="自定义权限类"><a href="#自定义权限类" class="headerlink" title="自定义权限类"></a>自定义权限类</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> api.utils.ahth <span class="keyword">import</span> MyJwtAuthentication</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderView2</span><span class="params">(GenericAPIView)</span>:</span></span><br><span class="line">    authentication_classes = [MyJwtAuthentication]</span><br><span class="line">    <span class="comment"># permission_classes = [IsAuthenticated]</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">        print(request.user)</span><br><span class="line">        print(<span class="number">1111</span>)</span><br><span class="line">        <span class="keyword">return</span> Response(<span class="string">'商品信息'</span>)</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="comment"># 第一种  </span></span><br><span class="line"><span class="keyword">from</span> rest_framework.authentication <span class="keyword">import</span> BaseAuthentication</span><br><span class="line"><span class="keyword">from</span> rest_framework_jwt.authentication <span class="keyword">import</span> BaseJSONWebTokenAuthentication</span><br><span class="line"><span class="keyword">from</span> rest_framework.exceptions <span class="keyword">import</span> AuthenticationFailed</span><br><span class="line"><span class="keyword">from</span>  rest_framework_jwt.authentication <span class="keyword">import</span> jwt_decode_handler</span><br><span class="line"><span class="keyword">from</span> rest_framework_jwt.utils <span class="keyword">import</span> jwt_decode_handler <span class="comment"># 跟上面死一样的   </span></span><br><span class="line"><span class="keyword">from</span> api.models <span class="keyword">import</span> User</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyJwtAuthentication</span><span class="params">(BaseAuthentication)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">authenticate</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        jwt_value=request.META.get(<span class="string">'HTTP_AUTHORIZATION'</span>)</span><br><span class="line">        <span class="keyword">if</span> jwt_value:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment">#jwt提供了通过三段token，取出payload的方法，并且有校验功能</span></span><br><span class="line">                payload=jwt_decode_handler(jwt_value)</span><br><span class="line">            <span class="keyword">except</span> jwt.ExpiredSignature:</span><br><span class="line">                <span class="keyword">raise</span> AuthenticationFailed(<span class="string">'签名过期'</span>)</span><br><span class="line">            <span class="keyword">except</span> jwt.InvalidTokenError:</span><br><span class="line">                <span class="keyword">raise</span> AuthenticationFailed(<span class="string">'用户非法'</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="comment"># 所有异常都会走到这</span></span><br><span class="line">                <span class="keyword">raise</span> AuthenticationFailed(str(e))</span><br><span class="line">            <span class="comment"># 因为payload就是用户信息的字典</span></span><br><span class="line">            print(payload)</span><br><span class="line">            <span class="comment"># return payload, jwt_value</span></span><br><span class="line">            <span class="comment"># 需要得到user对象，</span></span><br><span class="line">            <span class="comment"># 第一种，去数据库查</span></span><br><span class="line">             user=models.User.objects.get(pk=payload.get(<span class="string">'user_id'</span>))</span><br><span class="line">            <span class="comment"># 第二种不查库</span></span><br><span class="line">            <span class="comment">#user=User(id=payload.get('user_id'),username=payload.get('username'))# 生成对象里面</span></span><br><span class="line">            <span class="keyword">return</span> user,jwt_value</span><br><span class="line">        <span class="comment"># 没有值，直接抛异常</span></span><br><span class="line">        <span class="keyword">raise</span> AuthenticationFailed(<span class="string">'您没有携带认证信息'</span>)</span><br><span class="line">        </span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第2种</span></span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">DrfJwtTokenAuth</span><span class="params">(JSONWebTokenAuthentication)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">authenticate</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        jwt_value = request.META.get(<span class="string">'HTTP_AUTHORIZATION'</span>)<span class="comment"># 从请求头中取出token值</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            payload = jwt_decode_handler(jwt_value)<span class="comment"># 从token值中取出payload（字典）</span></span><br><span class="line">        <span class="keyword">except</span> exceptions.ExpiredSignatureError:<span class="comment"># 捕获异常</span></span><br><span class="line">            <span class="keyword">raise</span> AuthenticationFailed(<span class="string">'token已失效'</span>)</span><br><span class="line">        <span class="keyword">except</span> jwt.DecodeError:</span><br><span class="line">            <span class="keyword">raise</span> AuthenticationFailed(<span class="string">'token认证失败'</span>)</span><br><span class="line">        <span class="keyword">except</span> jwt.InvalidTokenError:</span><br><span class="line">            <span class="keyword">raise</span> AuthenticationFailed(<span class="string">'非法的token'</span>)</span><br><span class="line">        <span class="keyword">return</span> self.authenticate_credentials(payload), jwt_value</span><br><span class="line">    <span class="comment"># 从payload中取出user对象，内部是查询数据库实现的</span></span><br><span class="line">        <span class="comment"># authenticate_credentials是JSONWebTokenAuthentication提供的方法</span></span><br><span class="line">        </span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">当认证通过后，需要返回一个包含user对象的二元组，获取这个user对象的方式有两种；</span></span><br><span class="line"><span class="string">第一种是通过payload中的user_id或者username查数据哭获取user对象；</span></span><br><span class="line"><span class="string">第二种是通过用户类实例化一个该user对象【仅仅是一个对象，不是user用户对象】</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure><h3 id="手动签发token，多方式登录"><a href="#手动签发token，多方式登录" class="headerlink" title="手动签发token，多方式登录"></a>手动签发token，多方式登录</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">vews.py</span><br><span class="line"><span class="keyword">from</span> rest_framework.viewsets <span class="keyword">import</span> ViewSet</span><br><span class="line"><span class="keyword">from</span> api.ser <span class="keyword">import</span> UserModelSerializer</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginView</span><span class="params">(ViewSet)</span>:</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(self,request,*args,**kwargs)</span>:</span></span><br><span class="line">        login_ser = UserModelSerializer(data=request.data,context=&#123;<span class="string">'request'</span>:request&#125;)</span><br><span class="line">        login_ser.is_valid(raise_exception=<span class="literal">True</span>)</span><br><span class="line">        token = login_ser.context.get(<span class="string">'token'</span>)</span><br><span class="line">        username = login_ser.context.get(<span class="string">'username'</span>)</span><br><span class="line">        <span class="keyword">return</span> Response(&#123;<span class="string">'status'</span>:<span class="number">100</span>,<span class="string">'msg'</span>:<span class="string">"成功"</span>,<span class="string">'token'</span>:token,<span class="string">'username'</span>:username&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">ser.py</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> api <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> rest_framework_jwt.utils <span class="keyword">import</span> jwt_encode_handler</span><br><span class="line"><span class="keyword">from</span> rest_framework_jwt.utils <span class="keyword">import</span>  jwt_payload_handler <span class="comment"># 签发token</span></span><br><span class="line"><span class="keyword">from</span> rest_framework.exceptions <span class="keyword">import</span>  ValidationError</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserModelSerializer</span><span class="params">(serializers.ModelSerializer)</span>:</span></span><br><span class="line">    username = serializers.CharField() <span class="comment"># 这里要去覆盖username。因为他是唯一字段</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = models.User</span><br><span class="line">        fields = [<span class="string">'username'</span>, <span class="string">'password'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate</span><span class="params">(self, attrs)</span>:</span></span><br><span class="line">        print(self.context)</span><br><span class="line">        username = attrs.get(<span class="string">'username'</span>)</span><br><span class="line">        password = attrs.get(<span class="string">'password'</span>)</span><br><span class="line">        <span class="comment"># 判断，username 数据不同，查询字段不一样</span></span><br><span class="line">        <span class="comment"># 正则匹配手机</span></span><br><span class="line">        <span class="keyword">import</span> re</span><br><span class="line">        <span class="keyword">if</span> re.match(<span class="string">'^1[3-9][0-9]&#123;9&#125;$'</span>,username):</span><br><span class="line">          user = models.User.objects.filter(mobile=username).first()</span><br><span class="line">        <span class="keyword">elif</span> re.match(<span class="string">'^.+@.+$'</span>, username):</span><br><span class="line">            user = models.User.objects.filter(email=username).first()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            user = models.User.objects.filter(username=username).first()</span><br><span class="line">        <span class="keyword">if</span> user:</span><br><span class="line">            <span class="comment"># 校验密码</span></span><br><span class="line">            <span class="keyword">if</span> user.check_password(password):</span><br><span class="line">                <span class="comment"># 签发token</span></span><br><span class="line">                payload = jwt_payload_handler(user)</span><br><span class="line">                token = jwt_encode_handler(payload)</span><br><span class="line">                self.context[<span class="string">'token'</span>] = token</span><br><span class="line">                self.context[<span class="string">'username'</span>] = user.username</span><br><span class="line">                <span class="keyword">return</span> attrs</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">raise</span> ValidationError(<span class="string">'密码错误'</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValidationError(<span class="string">'用户不存在'</span>)</span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">from rest_framework_jwt.utils import jwt_encode_handler</span></span><br><span class="line"><span class="string">from rest_framework_jwt.utils import  jwt_payload_handler # 签发token</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    payload = jwt_payload_handler(user) # 把user传入，得到payload</span></span><br><span class="line"><span class="string">    token = jwt_encode_handler(payload) 把payload 传进去得到token</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure><ul><li>payload = jwt_payload_handler(user) # 把user传入，得到payload,</li><li>token = jwt_encode_handler(payload) 把payload 传进去得到token</li><li>因为username在user是一个字段，因为我们走的是post，它默认是查数据库保存，我们创建一个useraname字段覆盖，重新覆盖username字段，数据中它是unique，post，认为你保存数据，自己有校验没过</li></ul></li></ul><h3 id="jwt的参数配置"><a href="#jwt的参数配置" class="headerlink" title="jwt的参数配置"></a>jwt的参数配置</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># jwt的配置</span></span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line">JWT_AUTH=&#123;</span><br><span class="line">    <span class="string">'JWT_RESPONSE_PAYLOAD_HANDLER'</span>:<span class="string">'app02.utils.my_jwt_response_payload_handler'</span>,</span><br><span class="line">    <span class="string">'JWT_EXPIRATION_DELTA'</span>: datetime.timedelta(days=<span class="number">7</span>), <span class="comment"># 过期时间，手动配置</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="pyjwt的应用"><a href="#pyjwt的应用" class="headerlink" title="pyjwt的应用"></a>pyjwt的应用</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">视图</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> app01.utils.jwt_token <span class="keyword">import</span> create_token</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProLoginView</span><span class="params">(APIView)</span>:</span></span><br><span class="line">    <span class="string">"""jwt登录认证"""</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self,request,*args,**kwargs)</span>:</span></span><br><span class="line">        user = request.data.get(<span class="string">'username'</span>)</span><br><span class="line">        pwd = request.data.get(<span class="string">'password'</span>)</span><br><span class="line">        user_obj = models.UserInfo.objects.filter(username=user,password=pwd).first()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> user_obj:</span><br><span class="line">            <span class="keyword">return</span> Response(&#123;<span class="string">'code'</span>:<span class="number">1000</span>,<span class="string">'error'</span>:<span class="string">'用户名或密码错误'</span>&#125;)</span><br><span class="line">        token = create_token(&#123;<span class="string">'id'</span>:user_obj.id,<span class="string">'name'</span>:user_obj.username&#125;)</span><br><span class="line">        <span class="keyword">return</span> Response(&#123;<span class="string">'code'</span>: <span class="number">10001</span>, <span class="string">'data'</span>: token&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> app01.exensions.auth <span class="keyword">import</span> JwtQueryParamsAuthentication</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProOrderView</span><span class="params">(APIView)</span>:</span></span><br><span class="line">    authentication_classes = [JwtQueryParamsAuthentication]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line"></span><br><span class="line">        print(request.user)</span><br><span class="line">        <span class="keyword">return</span> Response(<span class="string">'订单列表'</span>)</span><br><span class="line"></span><br><span class="line">生成token</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_token</span><span class="params">(payload,timeout=<span class="number">1</span>)</span>:</span></span><br><span class="line">    </span><br><span class="line">    salt = settings.SECRET_KEY</span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">'typ'</span>: <span class="string">'jwt'</span>,</span><br><span class="line">        <span class="string">'alg'</span>: <span class="string">'HS256'</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># 构造payload</span></span><br><span class="line">    payload[<span class="string">'exp'</span>] = datetime.datetime.utcnow() + datetime.timedelta(minutes=timeout)  <span class="comment"># 超时时间</span></span><br><span class="line"></span><br><span class="line">    token = jwt.encode(payload=payload, key=salt, algorithm=<span class="string">"HS256"</span>, headers=headers).decode(<span class="string">'utf-8'</span>)</span><br><span class="line">    <span class="keyword">return</span> token</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">认证token</span><br><span class="line"><span class="keyword">from</span> rest_framework.authentication <span class="keyword">import</span> BaseAuthentication</span><br><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</span><br><span class="line"><span class="keyword">from</span> jwt <span class="keyword">import</span> exceptions</span><br><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line"><span class="keyword">from</span> rest_framework.exceptions <span class="keyword">import</span> AuthenticationFailed</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JwtQueryParamsAuthentication</span><span class="params">(BaseAuthentication)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">authenticate</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        token = request.query_params.get(<span class="string">'token'</span>)</span><br><span class="line">        salt = settings.SECRET_KEY</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            payload = jwt.decode(token, salt, <span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">except</span> exceptions.ExpiredSignatureError:</span><br><span class="line">            msg = <span class="string">'token已失效'</span></span><br><span class="line">            <span class="keyword">raise</span> AuthenticationFailed(&#123;<span class="string">'code'</span>:<span class="number">1003</span>,<span class="string">"msg"</span>:msg&#125;)</span><br><span class="line">        <span class="keyword">except</span> jwt.DecodeError:</span><br><span class="line">            msg = <span class="string">'token认证失败'</span></span><br><span class="line">            <span class="keyword">raise</span> AuthenticationFailed(&#123;<span class="string">'code'</span>: <span class="number">1003</span>, <span class="string">"msg"</span>: msg&#125;)</span><br><span class="line">        <span class="keyword">except</span> jwt.InvalidTokenError:</span><br><span class="line">            msg = <span class="string">'非法的token'</span></span><br><span class="line">            <span class="keyword">raise</span> AuthenticationFailed(&#123;<span class="string">'code'</span>: <span class="number">1003</span>, <span class="string">"msg"</span>: msg&#125;)</span><br><span class="line">        <span class="keyword">return</span> (payload, token) <span class="comment"># payload就是user,</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">#可以有三种返回值</span></span><br><span class="line">        <span class="comment"># 抛出异常，后面的函数就不会执行</span></span><br><span class="line">        <span class="comment"># return一个元组（1，2）认证通过，在视图中调用request.user,就是元组的一个值，request.auth时第二个值</span></span><br><span class="line">        <span class="comment"># return None 在验证</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;JWT&quot;&gt;&lt;a href=&quot;#JWT&quot; class=&quot;headerlink&quot; title=&quot;JWT&quot;&gt;&lt;/a&gt;JWT&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;https://pythonav.com/media/uploads/2019/11/14/image-2019
      
    
    </summary>
    
    
    
      <category term="drf" scheme="http://yoursite.com/tags/drf/"/>
    
  </entry>
  
  <entry>
    <title>自动生成文档</title>
    <link href="http://yoursite.com/2018/01/12/8.drf-%E8%87%AA%E5%8A%A8%E7%94%9F%E6%88%90%E6%8E%A5%E5%8F%A3%E6%96%87%E6%A1%A3/"/>
    <id>http://yoursite.com/2018/01/12/8.drf-%E8%87%AA%E5%8A%A8%E7%94%9F%E6%88%90%E6%8E%A5%E5%8F%A3%E6%96%87%E6%A1%A3/</id>
    <published>2018-01-11T16:00:00.000Z</published>
    <updated>2020-08-19T12:49:09.475Z</updated>
    
    <content type="html"><![CDATA[<p>REST framework可以自动帮助我们生成接口文档。</p><p>接口文档以网页的方式呈现。</p><p>自动接口文档能生成的是继承自<code>APIView</code>及其子类的视图。</p><h2 id="1-1-安装依赖"><a href="#1-1-安装依赖" class="headerlink" title="1.1. 安装依赖"></a>1.1. 安装依赖</h2><p>REST framewrok生成接口文档需要<code>coreapi</code>库的支持。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install coreapi</span><br></pre></td></tr></table></figure><h2 id="1-2-设置接口文档访问路径"><a href="#1-2-设置接口文档访问路径" class="headerlink" title="1.2. 设置接口文档访问路径"></a>1.2. 设置接口文档访问路径</h2><p>在总路由中添加接口文档路径。</p><p>文档路由对应的视图配置为<code>rest_framework.documentation.include_docs_urls</code>，</p><p>参数<code>title</code>为接口文档网站的标题。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.documentation <span class="keyword">import</span> include_docs_urls</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    ...</span><br><span class="line">    path(<span class="string">'docs/'</span>, include_docs_urls(title=<span class="string">'站点页面标题'</span>))</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h2 id="1-3-文档描述说明的定义位置"><a href="#1-3-文档描述说明的定义位置" class="headerlink" title="1.3. 文档描述说明的定义位置"></a>1.3. 文档描述说明的定义位置</h2><p>1） 单一方法的视图，可直接使用类视图的文档字符串，如</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookListView</span><span class="params">(generics.ListAPIView)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    返回所有图书信息.</span></span><br><span class="line"><span class="string">    """</span></span><br></pre></td></tr></table></figure><p>2）包含多个方法的视图，在类视图的文档字符串中，分开方法定义，如</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookListCreateView</span><span class="params">(generics.ListCreateAPIView)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    get:</span></span><br><span class="line"><span class="string">    返回所有图书信息.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    post:</span></span><br><span class="line"><span class="string">    新建图书.</span></span><br><span class="line"><span class="string">    """</span></span><br></pre></td></tr></table></figure><p>3）对于视图集ViewSet，仍在类视图的文档字符串中封开定义，但是应使用action名称区分，如</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookInfoViewSet</span><span class="params">(mixins.ListModelMixin, mixins.RetrieveModelMixin, GenericViewSet)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    list:</span></span><br><span class="line"><span class="string">    返回图书列表数据</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    retrieve:</span></span><br><span class="line"><span class="string">    返回图书详情数据</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    latest:</span></span><br><span class="line"><span class="string">    返回最新的图书数据</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    read:</span></span><br><span class="line"><span class="string">    修改图书的阅读量</span></span><br><span class="line"><span class="string">    """</span></span><br></pre></td></tr></table></figure><h2 id="1-4-访问接口文档网页"><a href="#1-4-访问接口文档网页" class="headerlink" title="1.4. 访问接口文档网页"></a>1.4. 访问接口文档网页</h2><p>浏览器访问 127.0.0.1:8000/docs/，即可看到自动生成的接口文档。</p><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggghbdeu1pj31is0u013r.jpg" alt="æ¥å£ææ¡£ç½é¡µ"></p><h4 id="两点说明："><a href="#两点说明：" class="headerlink" title="两点说明："></a>两点说明：</h4><p>1） 视图集ViewSet中的retrieve名称，在接口文档网站中叫做read</p><p>2）参数的Description需要在模型类或序列化器类的字段中以help_text选项定义，如：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    ...</span><br><span class="line">    age = models.IntegerField(default=<span class="number">0</span>, verbose_name=<span class="string">'年龄'</span>, help_text=<span class="string">'年龄'</span>)</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><p>或</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StudentSerializer</span><span class="params">(serializers.ModelSerializer)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Student</span><br><span class="line">        fields = <span class="string">"__all__"</span></span><br><span class="line">        extra_kwargs = &#123;</span><br><span class="line">            <span class="string">'age'</span>: &#123;</span><br><span class="line">                <span class="string">'required'</span>: <span class="literal">True</span>,</span><br><span class="line">                <span class="string">'help_text'</span>: <span class="string">'年龄'</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;REST framework可以自动帮助我们生成接口文档。&lt;/p&gt;
&lt;p&gt;接口文档以网页的方式呈现。&lt;/p&gt;
&lt;p&gt;自动接口文档能生成的是继承自&lt;code&gt;APIView&lt;/code&gt;及其子类的视图。&lt;/p&gt;
&lt;h2 id=&quot;1-1-安装依赖&quot;&gt;&lt;a href=&quot;#1-1-
      
    
    </summary>
    
    
    
      <category term="drf" scheme="http://yoursite.com/tags/drf/"/>
    
  </entry>
  
</feed>
