<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><link rel="stylesheet" type="text/css" href="//fonts.loli.net/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.5"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.5"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><title>drf- CBV和APIView源码解读 | Simple</title><meta name="generator" content="Hexo 4.2.1"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">drf- CBV和APIView源码解读</h1><a id="logo" href="/.">Simple</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="search"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">drf- CBV和APIView源码解读</h1><div class="post-meta"><a href="/2020/07/09/drf-%20CBV%E5%92%8CAPIView%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/#comments" class="comment-count"></a><p><span class="date">Jul 09, 2020</span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>Hits</i></i></span></p></div><div class="post-content"><h1 id="CBV源码"><a href="#CBV源码" class="headerlink" title="CBV源码"></a>CBV源码</h1><h2 id="1-入口点："><a href="#1-入口点：" class="headerlink" title="1. 入口点："></a>1. 入口点：</h2>   <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">视图</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Books</span><span class="params">(View)</span>:</span></span><br><span class="line"> <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request)</span>:</span></span><br><span class="line"> <span class="keyword">return</span> JsonResponse(back_dic)</span><br></pre></td></tr></table></figure>
   <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.views <span class="keyword">import</span> View</span><br><span class="line">url(<span class="string">r'^books/'</span>,views.Book.as_view()) <span class="comment"># 类调用的方法绑定方法</span></span><br></pre></td></tr></table></figure>

   <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@classonlymethod</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">as_view</span><span class="params">(cls, **initkwargs)</span>:</span></span><br></pre></td></tr></table></figure>

<p>   这里我们可以看到as_view上面加了一个类方法，去@classonlymethod它继承的classmethod的方法，这个重定义的类方法比classmethod更强大，Book.as_view()，调用的时候可以不用加括号</p>
<h2 id="2-请求来时"><a href="#2-请求来时" class="headerlink" title="2. 请求来时"></a>2. 请求来时</h2> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@classonlymethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">as_view</span><span class="params">(cls, **initkwargs)</span>:</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">view</span><span class="params">(request, *args, **kwargs)</span>:</span> <span class="comment"># 档次请求的request,如request.method,request.POST</span></span><br><span class="line">            self = cls(**initkwargs)</span><br><span class="line">            <span class="keyword">if</span> hasattr(self, <span class="string">'get'</span>) <span class="keyword">and</span> <span class="keyword">not</span> hasattr(self, <span class="string">'head'</span>):</span><br><span class="line">                self.head = self.get</span><br><span class="line">            self.request = request</span><br><span class="line">            self.args = args</span><br><span class="line">            self.kwargs = kwargs</span><br><span class="line">            <span class="keyword">return</span> self.dispatch(request, *args, **kwargs)</span><br><span class="line">        view.view_class = cls</span><br><span class="line">        view.view_initkwargs = initkwargs</span><br><span class="line"></span><br><span class="line">        update_wrapper(view, cls.dispatch, assigned=())</span><br><span class="line">        <span class="keyword">return</span> view</span><br></pre></td></tr></table></figure>


<p>​        请求来了，路径匹配，执行函数的内存地址<code>(request)</code>,会把当前请求的<code>request</code>对象当作第一个参数传过来，执行<code>as_view</code>的内层函数<code>def view()</code>,<code>cls(**initkwargs)</code> 实例化得到一个对象，<code>cls</code>就是<code>Books</code>对象，用反射判断有没有<code>get</code>这个方法，<code>self.request = request</code>把当前请求的<code>request</code>赋值到<code>Books</code>对象里面的<code>request</code>，在视图函数里print(self.request)这个<code>request</code>和参数里面的<code>request</code>是一样的，指向一个内存地址。</p>
<p>​       <code>return self.dispatch(request, *args, **kwargs)</code>,<code>self.dispatch</code>,self是books，所以要到当前类视图函数寻找dispatch方法，没有才去到View去找发现了dispatch方法.</p>
 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dispatch</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> request.method.lower() <span class="keyword">in</span> self.http_method_names:</span><br><span class="line">          handler = getattr(self, request.method.lower(), self.http_method_not_allowed)</span><br><span class="line">      <span class="keyword">else</span>:</span><br><span class="line">          handler = self.http_method_not_allowed</span><br><span class="line">      <span class="keyword">return</span> handler(request, *args, **kwargs)</span><br></pre></td></tr></table></figure>

<p>request就是当次请求的request.lower()转成小写，判断视图函数里面有没有<code>self.http_method_names</code>这个方法，在强调一遍这里的self始终是Book对象，没有就去父类View里面找到这个方法<code>http_method_names = [&#39;get&#39;, &#39;post&#39;, &#39;put&#39;, &#39;patch&#39;, &#39;delete&#39;, &#39;head&#39;, &#39;options&#39;, &#39;trace&#39;]</code>,反射的意思：<code>handler=getattr(self,&#39;get&#39;)</code>,你写的<code>Book</code>类的<code>get</code>方法的内存地址,执行<code>get(request)</code>,原理还是FBV.</p>
<p>提示：如何我们只接受get请求可以在视图函数里面重写<code>http_method_names</code></p>
<h1 id="APIView源码"><a href="#APIView源码" class="headerlink" title="APIView源码"></a>APIView源码</h1><p>它的原理就是通过中间件之后执行的代码</p>
<h2 id="1-入口："><a href="#1-入口：" class="headerlink" title="1. 入口："></a>1. 入口：</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">视图</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BooksAPIView</span><span class="params">(APIView)</span></span></span><br><span class="line"><span class="class">	<span class="title">def</span> <span class="title">get</span><span class="params">(self,request)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">url</span><br><span class="line">url(<span class="string">r'^books/'</span>,views.BooksAPIView.as_view()),</span><br></pre></td></tr></table></figure>

<p>这里的和CBV的原理一样，但是这里的as_view,前面加了@classmethod,这里调的是APIView里面的as_view方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@classmethod</span></span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">as_view</span><span class="params">(cls, **initkwargs)</span>:</span></span><br><span class="line">       view = super().as_view(**initkwargs)</span><br><span class="line">       view.cls = cls</span><br><span class="line">       view.initkwargs = initkwargs</span><br><span class="line">       </span><br><span class="line">       <span class="keyword">return</span> csrf_exempt(view)</span><br></pre></td></tr></table></figure>

<p>我们看到super调用了父类(View)的as_view方法，最后还是CBV里面的内层函数，这里的view是父类类面return 返回的view，<code>csrf_exempt</code>：不管你有没有把中间件里面的csrf中间件去掉， 都没有csrf认证了，</p>
<h2 id="2-dispatch"><a href="#2-dispatch" class="headerlink" title="2.dispatch"></a>2.dispatch</h2><p>​        我们把目光继续跳到父类view里面，执行到dispatch里面后，先去BooksAPIView去找发现没有这个函数，就绪它继承的父类APIView里面去找，我们可以找到这个dispatch方法，没有去APIView父类（View），如果想看查找顺序用mro，</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dispatch</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">   </span><br><span class="line">      self.args = args</span><br><span class="line">      self.kwargs = kwargs</span><br><span class="line">      <span class="comment"># 重新包装一个request对象，以后再用的时候就是新的request对象</span></span><br><span class="line">      request = self.initialize_request(request, *args, **kwargs)</span><br><span class="line">      self.request = request</span><br><span class="line">      self.headers = self.default_response_headers  <span class="comment"># deprecate?</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span>:</span><br><span class="line">          self.initial(request, *args, **kwargs)</span><br><span class="line">          <span class="keyword">if</span> request.method.lower() <span class="keyword">in</span> self.http_method_names:</span><br><span class="line">              handler = getattr(self, request.method.lower(),</span><br><span class="line">                                self.http_method_not_allowed)</span><br><span class="line">          <span class="keyword">else</span>:</span><br><span class="line">              handler = self.http_method_not_allowed</span><br><span class="line"></span><br><span class="line">          response = handler(request, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">except</span> Exception <span class="keyword">as</span> exc:</span><br><span class="line">          response = self.handle_exception(exc)</span><br><span class="line"></span><br><span class="line">      self.response = self.finalize_response(request, response, *args, **kwargs)</span><br><span class="line">      <span class="keyword">return</span> self.response</span><br></pre></td></tr></table></figure>

<p>这个是APIView的dispatch方法，请求来了在路由匹配上执行到了view里面的内层函数，调用了dispatch，按照查找顺序就到了这里面，<code>request = self.initialize_request(request, *args, **kwargs)</code>这个request是当次请求的request赋值给了<code>self.initialize_request</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">initialize_request</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Returns the initial request object.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    parser_context = self.get_parser_context(request)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Request(</span><br><span class="line">        request,</span><br><span class="line">        parsers=self.get_parsers(),</span><br><span class="line">        authenticators=self.get_authenticators(),</span><br><span class="line">        negotiator=self.get_content_negotiator(),</span><br><span class="line">        parser_context=parser_context</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>

<p>这个代码先忽略掉，<code>self.initialize_request(request, *args, **kwargs)</code>的request是当次请求的request， request = self.initialize_request，这个request是一个新的request对象，self.request = request把这个新的request赋值给了当前类的 request,视图函数里面的request已经不是django原生的request，是drf中间定义的request对象，我们导入<code>from rest_framework.request import Request</code>查看到，</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BooksAPIView</span><span class="params">(APIView)</span></span></span><br><span class="line"><span class="class">	<span class="title">def</span> <span class="title">get</span><span class="params">(self,request)</span>:</span></span><br><span class="line">        print(request.data)</span><br></pre></td></tr></table></figure>

<p>验证：原生的request里面没有data这个属性，这个是drf的request的data属性。</p>
<h2 id="3-drf的Request类"><a href="#3-drf的Request类" class="headerlink" title="3.drf的Request类"></a>3.drf的Request类</h2><h3 id="3-1-原生request的封装"><a href="#3-1-原生request的封装" class="headerlink" title="3.1 原生request的封装"></a>3.1 原生request的封装</h3><p>上面我们执行到<code>request = self.initialize_request(request, *args, **kwargs)</code>的self调用</p>
<p>initialize_request这个方法，到视图类里面去找没有，再到APIView里面找到了initialize_request这个方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">initialize_request</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">       <span class="string">"""</span></span><br><span class="line"><span class="string">       Returns the initial request object.</span></span><br><span class="line"><span class="string">       """</span></span><br><span class="line">       parser_context = self.get_parser_context(request)</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> Request(</span><br><span class="line">           request,</span><br><span class="line">           parsers=self.get_parsers(),</span><br><span class="line">           authenticators=self.get_authenticators(),</span><br><span class="line">           negotiator=self.get_content_negotiator(),</span><br><span class="line">           parser_context=parser_context</span><br><span class="line">       )</span><br></pre></td></tr></table></figure>

<p>这里return 一个Request对象，里面有一个原生的request对象，原生的request对象被封装到了Request</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Request</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Wrapper allowing to enhance a standard `HttpRequest` instance.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Kwargs:</span></span><br><span class="line"><span class="string">        - request(HttpRequest). The original request instance.</span></span><br><span class="line"><span class="string">        - parsers_classes(list/tuple). The parsers to use for parsing the</span></span><br><span class="line"><span class="string">          request content.</span></span><br><span class="line"><span class="string">        - authentication_classes(list/tuple). The authentications used to try</span></span><br><span class="line"><span class="string">          authenticating the request's user.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, request, parsers=None, authenticators=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                 negotiator=None, parser_context=None)</span>:</span></span><br><span class="line">        <span class="keyword">assert</span> isinstance(request, HttpRequest), (</span><br><span class="line">            <span class="string">'The `request` argument must be an instance of '</span></span><br><span class="line">            <span class="string">'`django.http.HttpRequest`, not `&#123;&#125;.&#123;&#125;`.'</span></span><br><span class="line">            .format(request.__class__.__module__, request.__class__.__name__)</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        self._request = request</span><br><span class="line">        self.parsers = parsers <span class="keyword">or</span> ()</span><br><span class="line">        self.authenticators = authenticators <span class="keyword">or</span> ()</span><br><span class="line">        self.negotiator = negotiator <span class="keyword">or</span> self._default_negotiator()</span><br><span class="line">        self.parser_context = parser_context</span><br><span class="line">        self._data = Empty</span><br><span class="line">        self._files = Empty</span><br><span class="line">        self._full_data = Empty</span><br><span class="line">        self._content_type = Empty</span><br><span class="line">        self._stream = Empty</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.parser_context <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            self.parser_context = &#123;&#125;</span><br><span class="line">        self.parser_context[<span class="string">'request'</span>] = self</span><br><span class="line">        self.parser_context[<span class="string">'encoding'</span>] = request.encoding <span class="keyword">or</span> settings.DEFAULT_CHARSET</span><br><span class="line"></span><br><span class="line">        force_user = getattr(request, <span class="string">'_force_auth_user'</span>, <span class="literal">None</span>)</span><br><span class="line">        force_token = getattr(request, <span class="string">'_force_auth_token'</span>, <span class="literal">None</span>)</span><br><span class="line">        <span class="keyword">if</span> force_user <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">or</span> force_token <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            forced_auth = ForcedAuthentication(force_user, force_token)</span><br><span class="line">            self.authenticators = (forced_auth,)</span><br></pre></td></tr></table></figure>

<p> self._request = request在这里是原生的request对象，被包装到class Request可以用<code>from rest_framwork.request import Request</code></p>
<h3 id="3-2-原生method-，request-data，request-query-params"><a href="#3-2-原生method-，request-data，request-query-params" class="headerlink" title="3.2 原生method ，request.data，request.query_params"></a>3.2 原生method ，request.data，request.query_params</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">视图函数</span><br><span class="line">print(request.method)</span><br><span class="line"><span class="keyword">return</span> HttpResponse(<span class="string">'ok'</span>)</span><br></pre></td></tr></table></figure>

<p>当我们打印的时候为什么还能打印出原来request对象的属性呢，这个是点拦截属性， 魔法语法，</p>
<p>点的时候会调用<code>__getattr__</code> 这个是Request重新写了这个方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, attr)</span>:</span></span><br><span class="line"></span><br><span class="line">       <span class="keyword">try</span>:</span><br><span class="line">           <span class="keyword">return</span> getattr(self._request, attr)</span><br><span class="line">       <span class="keyword">except</span> AttributeError:</span><br><span class="line">           <span class="keyword">return</span> self.__getattribute__(attr)</span><br></pre></td></tr></table></figure>

<p>通过反射如果取method这个方法，到self._request去取出来的，如果有异常通过下面的方式取，以后是由request对象就像使用之前的request对象一样的，其实就是通过魔法方法，让你发现跟原来的一样，没有发觉。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">print(request.data),这个是方法，@property修饰了</span><br></pre></td></tr></table></figure>

<p>源码：request.data</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@property</span></span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">data</span><span class="params">(self)</span>:</span></span><br><span class="line">       <span class="keyword">if</span> <span class="keyword">not</span> _hasattr(self, <span class="string">'_full_data'</span>):</span><br><span class="line">           self._load_data_and_files()</span><br><span class="line">       <span class="keyword">return</span> self._full_data</span><br></pre></td></tr></table></figure>

<p>我们我们一直按照_full_data点下去，其实就是一个字典，不管使用了什么方式，什么编码传过来的数据都在request.data</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self,request)</span>:</span></span><br><span class="line">       print(request.data)</span><br><span class="line">       <span class="keyword">return</span> HttpResponse(<span class="string">'OK'</span>)</span><br><span class="line">   urlencoded:&lt;QueryDict: &#123;<span class="string">'name'</span>: [<span class="string">'aaaa'</span>], <span class="string">'age'</span>: [<span class="string">'111'</span>]&#125;&gt;</span><br><span class="line">   json:&#123;<span class="string">'name'</span>: <span class="string">'zzz'</span>, <span class="string">'age'</span>: <span class="number">333</span>&#125;</span><br></pre></td></tr></table></figure>

<p>我们发现返回的是一个QueryDict我们导入模块看一下<code>from django.http import QueryDict</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">QueryDict</span><span class="params">(MultiValueDict)</span>:</span></span><br><span class="line">    </span><br><span class="line">     <span class="function"><span class="keyword">def</span> <span class="title">copy</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""Returns a mutable copy of this object."""</span></span><br><span class="line">        <span class="keyword">return</span> self.__deepcopy__(&#123;&#125;)</span><br></pre></td></tr></table></figure>

<p>它继承了字典，但是不能改，但是它copy一遍在修改</p>
<p>get请求传过来的数据</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">request.GET这个能取出来，在Request又写了一个</span><br><span class="line">print(request.query_params)在get请求，地址参数里</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@property</span></span><br><span class="line"> <span class="function"><span class="keyword">def</span> <span class="title">query_params</span><span class="params">(self)</span>:</span></span><br><span class="line">     <span class="string">"""</span></span><br><span class="line"><span class="string">     More semantically correct name for request.GET.</span></span><br><span class="line"><span class="string">     """</span></span><br><span class="line">     <span class="keyword">return</span> self._request.GET</span><br></pre></td></tr></table></figure>

<p>这样写是为了符合rest_framwork的规范，文件也是一样重写了</p>
<p>好我们收回，把思路跳到我们查询请求的方式APIView里面的<code>dispatch</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">     <span class="comment"># 三大认证模块</span></span><br><span class="line">     self.initial(request, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">     <span class="comment"># Get the appropriate handler method</span></span><br><span class="line">     <span class="keyword">if</span> request.method.lower() <span class="keyword">in</span> self.http_method_names:</span><br><span class="line">         handler = getattr(self, request.method.lower(),</span><br><span class="line">                           self.http_method_not_allowed)</span><br><span class="line">     <span class="keyword">else</span>:</span><br><span class="line">         handler = self.http_method_not_allowed</span><br><span class="line"></span><br><span class="line">     <span class="comment"># 响应模块</span></span><br><span class="line">     response = handler(request, *args, **kwargs)</span><br><span class="line"></span><br><span class="line"> <span class="keyword">except</span> Exception <span class="keyword">as</span> exc:</span><br><span class="line">     <span class="comment"># 异常模块</span></span><br><span class="line">     response = self.handle_exception(exc)</span><br><span class="line"></span><br><span class="line"> <span class="comment"># 渲染模块</span></span><br><span class="line"> self.response = self.finalize_response(request, response, *args, **kwargs)</span><br><span class="line"> <span class="keyword">return</span> self.response</span><br></pre></td></tr></table></figure>

<p>这里的异常处理无论出现什么错误，返回的都是json格式的错误。</p>
</div><div class="post-copyright"><blockquote><p>Original author: Simple</p><p>Original link: <a href="http://yoursite.com/2020/07/09/drf- CBV和APIView源码解读/">http://yoursite.com/2020/07/09/drf- CBV和APIView源码解读/</a></p><p>Copyright Notice: Please indicate the source of the reprint (must retain the author's signature and link)</p></blockquote></div><div class="tags"></div><div class="post-share"><div class="social-share"><span>Share:</span></div></div><div class="post-nav"><a href="/2020/07/09/%E5%89%8D%E7%AB%AF%E4%B9%8BCSS/" class="pre">前端之CSS</a><a href="/2020/07/09/django-cookie%20%E5%92%8Csession/" class="next">django-cookie 和session</a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">Contents</i></div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#CBV源码"><span class="toc-text">CBV源码</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-入口点："><span class="toc-text">1. 入口点：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-请求来时"><span class="toc-text">2. 请求来时</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#APIView源码"><span class="toc-text">APIView源码</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-入口："><span class="toc-text">1. 入口：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-dispatch"><span class="toc-text">2.dispatch</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-drf的Request类"><span class="toc-text">3.drf的Request类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-原生request的封装"><span class="toc-text">3.1 原生request的封装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-原生method-，request-data，request-query-params"><span class="toc-text">3.2 原生method ，request.data，request.query_params</span></a></li></ol></li></ol></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/07/09/django-csrf%20%E8%B7%A8%E7%AB%99%E8%AF%B7%E6%B1%82%E4%BC%AA%E9%80%A0/">django-csrf 跨站请求伪造</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/09/%E5%89%8D%E7%AB%AF%E4%B9%8BCSS/">前端之CSS</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/09/drf-%20CBV%E5%92%8CAPIView%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/">drf- CBV和APIView源码解读</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/09/django-cookie%20%E5%92%8Csession/">django-cookie 和session</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/09/mysql-%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/">mysql-存储引擎</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/09/django-%E6%89%B9%E9%87%8F%E6%8F%92%E5%85%A5/">django-批量插入</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/09/%E7%94%B1django%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%BC%95%E5%8F%91%E7%9A%84%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/">由django中间件引发的编程思想</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/05/bbs/">bbs</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/05/django-%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%AC%94%E8%AE%B0/">django-中间件笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/10/11/drf-%E8%B7%AF%E7%94%B1%E5%92%8C%E8%AE%A4%E8%AF%81/">drf路由的配置</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> Tags</i></div><div class="tagcloud"><a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/rest-framework/" style="font-size: 15px;">rest_framework</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> Archive</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/">2020</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/">2019</a><span class="archive-list-count">6</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> Blogroll</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">Site Map</a> |  <a href="/atom.xml">Subscribe to this site</a> |  <a href="/about/">Contact the blogger</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次，本站总访客数:<i id="busuanzi_container_site_uv"><i id="busuanzi_value_site_uv"></i></i>人</p><p><span> Copyright &copy;<a href="/." rel="nofollow">Simple.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/" target="_blank" rel="noopener"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.5"></script><div id="fullscreen-img" class="hide"><span class="close"></span></div><script type="text/javascript" src="/js/imgview.js?v=2.0.5" async></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.5" async></script><link rel="stylesheet" type="text/css" href="/share/css/share.css"><script type="text/javascript" src="/share/js/social-share.js" charset="utf-8"></script><script type="text/javascript" src="/share/js/qrcode.js" charset="utf-8"></script></body></html>