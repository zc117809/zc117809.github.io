
 <!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="UTF-8">
  
    <title>bbs | Hexo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="John Doe">
    

    
    <meta name="description" content="bbs技术点总结[TOC] js只要用到内置对象，直接用new生成就可以了 1. 用户注册上传头像123456789101112131415161718192021222324&lt;div class&#x3D;&quot;form-group&quot;&gt;                &lt;label for&#x3D;&quot;myfile&quot;&gt;头像                    &amp;#123;% load stati">
<meta property="og:type" content="article">
<meta property="og:title" content="bbs">
<meta property="og:url" content="http://yoursite.com/2020/07/05/bbs/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="bbs技术点总结[TOC] js只要用到内置对象，直接用new生成就可以了 1. 用户注册上传头像123456789101112131415161718192021222324&lt;div class&#x3D;&quot;form-group&quot;&gt;                &lt;label for&#x3D;&quot;myfile&quot;&gt;头像                    &amp;#123;% load stati">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2020-07-05T12:20:55.424Z">
<meta property="article:modified_time" content="2020-07-05T12:20:37.011Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">

    
    <link rel="alternative" href="/atom.xml" title="Hexo" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    
<link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/%02.css">
<link rel="stylesheet" href="/.css">

<meta name="generator" content="Hexo 4.2.1"></head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="Hexo" title="Hexo"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Hexo">Hexo</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="Search" />
						<input type="hidden" name="q" value="site:yoursite.com">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2020/07/05/bbs/" title="bbs" itemprop="url">bbs</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="John Doe" target="_blank" itemprop="author">John Doe</a>
		
  <p class="article-time">
    <time datetime="2020-07-05T12:20:55.424Z" itemprop="datePublished"> Published 2020-07-05</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">Contents</strong>
		
			<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#bbs技术点总结"><span class="toc-number">1.</span> <span class="toc-text">bbs技术点总结</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-用户注册上传头像"><span class="toc-number">1.1.</span> <span class="toc-text">1. 用户注册上传头像</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-生成登录验证码"><span class="toc-number">1.2.</span> <span class="toc-text">2. 生成登录验证码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-admin的使用"><span class="toc-number">1.3.</span> <span class="toc-text">3. admin的使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-制作站点"><span class="toc-number">1.4.</span> <span class="toc-text">4. 制作站点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-media的配置"><span class="toc-number">1.5.</span> <span class="toc-text">5. media的配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-站点左边栏展示"><span class="toc-number">1.6.</span> <span class="toc-text">6. 站点左边栏展示</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-侧边栏筛选功能"><span class="toc-number">1.7.</span> <span class="toc-text">7. 侧边栏筛选功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-inclusion-tag的制作"><span class="toc-number">1.8.</span> <span class="toc-text">8. inclusion_tag的制作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-根评论子评论"><span class="toc-number">1.9.</span> <span class="toc-text">8 根评论子评论</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-beautifulsuop4"><span class="toc-number">1.10.</span> <span class="toc-text">9 beautifulsuop4</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-富文本编辑器遗留问题"><span class="toc-number">1.11.</span> <span class="toc-text">10 富文本编辑器遗留问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-修改头像问题"><span class="toc-number">1.12.</span> <span class="toc-text">11 修改头像问题</span></a></li></ol></li></ol>
		
		</div>
		
		<h1 id="bbs技术点总结"><a href="#bbs技术点总结" class="headerlink" title="bbs技术点总结"></a>bbs技术点总结</h1><p>[TOC]</p>
<p>js只要用到内置对象，直接用new生成就可以了</p>
<h2 id="1-用户注册上传头像"><a href="#1-用户注册上传头像" class="headerlink" title="1. 用户注册上传头像"></a>1. 用户注册上传头像</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;div class="form-group"&gt;</span><br><span class="line">                &lt;label <span class="keyword">for</span>=<span class="string">"myfile"</span>&gt;头像</span><br><span class="line">                    &#123;% load static %&#125;</span><br><span class="line">                    &lt;img id="myimg" src="&#123;% static 'img/default.png' %&#125;" alt="" width="80" style="margin-left: 20px"&gt;&lt;/label&gt;</span><br><span class="line">                &lt;input type=<span class="string">"file"</span> id=<span class="string">"myfile"</span> name=<span class="string">"avater"</span> style=<span class="string">"display: none"</span>&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">    //文本域变化事件</span><br><span class="line">    $(<span class="string">'#myfile'</span>).change(function () &#123;</span><br><span class="line">        //文件阅读器对象</span><br><span class="line">        //<span class="number">1.</span>先生成一个文件阅读器对象</span><br><span class="line">        let myFileReadObj = new FileReader(); // 文件阅读器</span><br><span class="line">        //<span class="number">2.</span> 获取用户上传的头像文件</span><br><span class="line">        let fileObj = $(this)[<span class="number">0</span>].files[<span class="number">0</span>]; //获取文件</span><br><span class="line">        // <span class="number">3.</span>将文件对象交给文件阅读器读取</span><br><span class="line">        myFileReadObj.readAsDataURL(fileObj) //异步操作，io操作，这行代码文件还没有读完，就已经开始执行下一句代码，在前端不显示</span><br><span class="line">        //<span class="number">4.</span>利用文件阅读器将文件展示到页面去 修改src属性</span><br><span class="line">        //等待文件阅读器加载完之后，在执行</span><br><span class="line">        myFileReadObj.onload = function()&#123;  $(<span class="string">'#myimg'</span>).attr(<span class="string">'src'</span>,myFileReadObj.result)&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li>这里我们要用到文本与变化事件，利用文件阅读器对象，我们要先生成一个文件阅读器对象，</li>
<li>获取用户上传的头像文件读取出来</li>
<li>将文件对象交给文件阅读器读取出来文件</li>
<li>利用文件阅读器将文件展示到页面上去，就要修改src属性，<code>myFileReadObj.readAsDataURL(fileObj)</code>和<code>$(&#39;#myimg&#39;).attr(&#39;src&#39;,myFileReadObj.result)</code>这两部是一个异步操作，如果你在执上一代码的同时文件还没有读取出来，同时他还在执行下一句代码，这样会造成你上传之后在前端是不显示你上传的头像，空白区，我们要等文件加载完毕在执行下一局，<code>myFileReadObj.onload</code> </li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"> $(<span class="string">'#id_commit'</span>).click(function () &#123;</span><br><span class="line">        // 发送ajax请求     我们发送的数据中即包含普通的键值也包含文件</span><br><span class="line">        let formDataObj = new FormData();</span><br><span class="line">        // <span class="number">1.</span>添加普通的键值对</span><br><span class="line">        &#123;<span class="comment">#console.log($('#myform').serializeArray())  // [&#123;&#125;,&#123;&#125;,&#123;&#125;,&#123;&#125;,&#123;&#125;]  只包含普通键值对#&#125;</span></span><br><span class="line">        $.each($(<span class="string">'#myform'</span>).serializeArray(),function (index,obj) &#123;</span><br><span class="line">            &#123;<span class="comment">#console.log(index,obj)#&#125;  // obj = &#123;&#125;</span></span><br><span class="line">            formDataObj.append(obj.name,obj.value)</span><br><span class="line">        &#125;);</span><br><span class="line">        // <span class="number">2.</span>添加文件数据</span><br><span class="line">        formDataObj.append(<span class="string">'avatar'</span>,$(<span class="string">'#myfile'</span>)[<span class="number">0</span>].files[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">        // <span class="number">3.</span>发送ajax请求</span><br><span class="line">        $.ajax(&#123;</span><br><span class="line">            url:<span class="string">""</span>,</span><br><span class="line">            type:<span class="string">'post'</span>,</span><br><span class="line">            data:formDataObj,</span><br><span class="line"></span><br><span class="line">            // 需要指定两个关键性的参数</span><br><span class="line">            contentType:false,</span><br><span class="line">            processData:false,</span><br><span class="line"></span><br><span class="line">            success:function (args) &#123;</span><br><span class="line">                <span class="keyword">if</span> (args.code==<span class="number">1000</span>)&#123;</span><br><span class="line">                    // 跳转到登陆页面</span><br><span class="line">                    window.location.href = args.url</span><br><span class="line">                &#125;els</span><br><span class="line">                    // 如何将对应的错误提示展示到对应的input框下面</span><br><span class="line">                    // forms组件渲染的标签的id值都是 id_字段名</span><br><span class="line">                    $.each(args.msg,function (index,obj) &#123;</span><br><span class="line">                        &#123;<span class="comment">#console.log(index,obj)  //  username        ["用户名不能为空"]#&#125;</span></span><br><span class="line">                        let targetId = <span class="string">'#id_'</span> + index;</span><br><span class="line">                        $(targetId).next().text(obj[<span class="number">0</span>]).parent().addClass(<span class="string">'has-error'</span>)</span><br><span class="line">                    &#125;)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="comment"># 产生一个空对象</span></span><br><span class="line">    register_form = myforms.MyRegForm()</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</span><br><span class="line">        back_dic = &#123;<span class="string">'code'</span>:<span class="string">''</span>, <span class="string">'msg'</span>: <span class="string">''</span>&#125;</span><br><span class="line">        <span class="comment"># 校验数据是否合法</span></span><br><span class="line">        register_form = myforms.MyRegForm(request.POST)</span><br><span class="line">        <span class="comment"># 判断数据是否合法</span></span><br><span class="line">        <span class="keyword">if</span> register_form.is_valid():</span><br><span class="line">            clean_data = register_form.cleaned_data <span class="comment"># 将校验通过的数据字典赋值给一个变量</span></span><br><span class="line">            <span class="comment"># 将字典里面吗的confirm_password键值对删除</span></span><br><span class="line">            clean_data.pop(<span class="string">'confirm_password'</span>)</span><br><span class="line">            <span class="comment"># 用户头像</span></span><br><span class="line">            file_obj = request.FILES.get(<span class="string">'avatar'</span>)</span><br><span class="line">            <span class="string">"""</span></span><br><span class="line"><span class="string">            针对用户头像一定要判断是否传之，不能直接添加到字典里面去</span></span><br><span class="line"><span class="string">            """</span></span><br><span class="line">            <span class="keyword">if</span> file_obj:</span><br><span class="line">                clean_data[<span class="string">'avatar'</span>] = file_obj</span><br><span class="line">            <span class="comment"># 直接操作数据库保存到字典里面</span></span><br><span class="line">            models.UserInfo.objects.create_user(**clean_data) <span class="comment"># 将键值对**打散传到数据库</span></span><br><span class="line">            <span class="comment"># 判断正确跳转到登录页面</span></span><br><span class="line">            back_dic[<span class="string">'url'</span>] = <span class="string">'/login/'</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            back_dic[<span class="string">'code'</span>] = <span class="number">2000</span></span><br><span class="line">            back_dic[<span class="string">'msg'</span>] = register_form.errors</span><br><span class="line">            <span class="keyword">return</span> JsonResponse(back_dic)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'register.html'</span>, locals())</span><br></pre></td></tr></table></figure>
<p><strong>前端：</strong></p>
<ul>
<li><p>头像的功能完成之后，剩下的就是将利用ajax将文件发送到后端，前端要先利用内置对象获取数据，添加不同键值对，我们可以利用<code>serializeArray()</code>拿到他所有的键值对，利用each循环拿到每一个对象的键值对</p>
</li>
<li><p>利用append添加文件数据，发送ajax请求，这里面我们要指定两个关键参数<code>contentType: false</code>,<code>processData: false</code>,</p>
</li>
<li><p>如果后端保存数据成功，就跳转到后端写好传过来的指定页面，如果校验数据失败就在input框下面展现出对应的错误</p>
</li>
<li><p>当我们看见错误的信息之后，如果把鼠标放上去，指定的错误就会消失，给所有的input框绑定获取焦点事件，将input下面的span标签和input外面的div标签修改内容和属性</p>
</li>
</ul>
<p><strong>后端</strong></p>
<ul>
<li>校验数据输入的是否合法，将合法的数据赋值给一个变量，赋值给一个变量方便我们删除确认密码的键值对，因为我们在写models的时候没有这个字段，针对用户头像一定要判断是否传之，不能直接添加到字典里面去，在models里面我们给他默认了一个头像</li>
<li>操作数据库保存数据，定义字典将信息返回给ajax，ajax都到在页面展示对应的页面信息</li>
</ul>
<p>存取问题：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RegisterForm</span><span class="params">(forms.Form)</span>:</span></span><br><span class="line"> data  = register_form.cleaned_data</span><br><span class="line"> models.UserInfo.objects.create_user(**data)</span><br><span class="line"> 这里我们在前端像后端存的时候出现了问题，原因是models里面的username和password必须和form表单里面的字段名一致，因为我们去表单里面验证的时候用的是form表单里面的字段名去数据库里面存，**data的时候字段名这个和数据库里面的字段名不一样</span><br></pre></td></tr></table></figure>



<h2 id="2-生成登录验证码"><a href="#2-生成登录验证码" class="headerlink" title="2. 生成登录验证码"></a>2. 生成登录验证码</h2><p>如何生成一个验证码，然后点击它就可以刷新呢。</p>
<p>利用pip3 install pillow ，这个是图片相关的模块。</p>
<p>导入模块：<code>from PIL import Image, ImageDraw, ImageFont</code></p>
<ul>
<li>Image 生成图片</li>
<li>ImageDraw 能够在图片上添加东西</li>
<li>ImageFont 控制字体的样式</li>
</ul>
<p><strong>推导1</strong>：</p>
<p>直接获取后端生成的图片二进制数据发送给前端</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> open(<span class="string">r'static/img/111.jpg'</span>,<span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">      data = f.read()</span><br><span class="line"><span class="keyword">return</span> HttpResponse(data)</span><br></pre></td></tr></table></figure>

<p><strong>推导2</strong></p>
<p>利用pillow模块动态产生图片</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">img_obj = Image.new(<span class="string">'RGB'</span>,(<span class="number">430</span>,<span class="number">35</span>),<span class="string">'green'</span>)</span><br><span class="line">img_obj = Image.new(<span class="string">'RGB'</span>,(<span class="number">430</span>,<span class="number">35</span>),get_random())</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将图片对象 保存起来</span></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'xxx.png'</span>,<span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    img_obj.save(f,<span class="string">'png'</span>)</span><br><span class="line"><span class="comment"># 再将文件对象读取出来</span></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'xxx.png'</span>,<span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    data = f.read()</span><br><span class="line"><span class="keyword">return</span> HttpResponse(data)</span><br></pre></td></tr></table></figure>

<p><strong>推导3</strong><br>我们可以看到利用文件存储繁琐而且IO操作效率低，我们可以借助内存管理模块</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO,StringIO</span><br><span class="line">img_obj = Image.new(<span class="string">'RGB'</span>, (<span class="number">430</span>, <span class="number">35</span>), get_random())</span><br><span class="line">io_obj = BytesIO()</span><br><span class="line">img_obj.save(io_obj,<span class="string">'png'</span>) <span class="comment"># 生成一个内存管理器对象</span></span><br><span class="line"><span class="keyword">return</span> HttpResponse(io_obj.getvalue()) <span class="comment"># 从内存管理器中读取二进制的图片数据返回给前端</span></span><br></pre></td></tr></table></figure>

<p><strong>推导4</strong></p>
<p>写成图片验证码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">img_obj = Image.new(<span class="string">'RGB'</span>, (<span class="number">430</span>, <span class="number">35</span>), get_random())</span><br><span class="line">img_draw = ImageDraw.Draw(img_obj)  <span class="comment"># 产生一个画笔对象</span></span><br><span class="line">img_font = ImageFont.truetype(<span class="string">'static/font/222.ttf'</span>,<span class="number">30</span>)  <span class="comment"># 字体样式 大小</span></span><br></pre></td></tr></table></figure>

<p><strong>最终成型</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_random</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> random.randint(<span class="number">0</span>,<span class="number">255</span>),random.randint(<span class="number">0</span>,<span class="number">255</span>),random.randint(<span class="number">0</span>,<span class="number">255</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_code</span><span class="params">(request)</span>:</span></span><br><span class="line">    img_obj = Image.new(<span class="string">'RGB'</span>, (<span class="number">430</span>, <span class="number">35</span>), get_random()) <span class="comment"># 注意：这里的430，35要和前端的一致</span></span><br><span class="line">    img_draw = ImageDraw.Draw(img_obj)</span><br><span class="line">    img_font = ImageFont.truetype(<span class="string">'static/font/222.ttf'</span>,<span class="number">30</span>)</span><br><span class="line">    code = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">        random_upper = chr(random.randint(<span class="number">65</span>,<span class="number">90</span>))</span><br><span class="line">        random_lower = chr(random.randint(<span class="number">97</span>,<span class="number">122</span>))</span><br><span class="line">        random_int = str(random.randint(<span class="number">0</span>,<span class="number">9</span>))</span><br><span class="line">        tmp = random.choice([random_lower,random_upper,random_int])</span><br><span class="line">        img_draw.text((i*<span class="number">60</span>+<span class="number">60</span>,<span class="number">-2</span>),tmp,get_random(),img_font)</span><br><span class="line">        code += tmp</span><br><span class="line">    print(code)</span><br><span class="line">    request.session[<span class="string">'code'</span>] = code</span><br><span class="line">    io_obj = BytesIO()</span><br><span class="line">    img_obj.save(io_obj,<span class="string">'png'</span>)</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(io_obj.getvalue())</span><br></pre></td></tr></table></figure>

<ul>
<li>实现低级验证码图片刷新验证码，这样设置后每次点击图片相当于超后端发送一次get请求获取一个新的验证码图片</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="comment"># 点击验证码图片刷新验证码   #&#125;</span></span><br><span class="line">$(<span class="string">'#code_img'</span>).click(function () &#123;</span><br><span class="line">    $(this).attr('src', '&#123;% url "get_code" %&#125;?')	// src='/get_code/?'url后面加?的操作</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="3-admin的使用"><a href="#3-admin的使用" class="headerlink" title="3. admin的使用"></a>3. admin的使用</h2><p>以前写图书的展示列表，我们给它添加增删改查的功能，特别的麻烦，现在有很多张表的展示，我们不可能慢慢的写这些功能，django给我们提供了admin后台管理，我们可以利用admin实现增删改查，添加数据。</p>
<p>首先要创建超级用户，只有超级用户才能够操作admin的这些功能。</p>
<p>刚开始登录进去的时候只用一张用户表，我们想要添加其他的表，必须添加注册</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> app01 <span class="keyword">import</span> models</span><br><span class="line"><span class="comment"># Register your models here.admin</span></span><br><span class="line">admin.site.register(models.UserInfo)</span><br><span class="line">admin.site.register(models.Blog)</span><br><span class="line">admin.site.register(models.Article)</span><br><span class="line">admin.site.register(models.Atricle2Tag)</span><br><span class="line">admin.site.register(models.UpAndDown)</span><br><span class="line">admin.site.register(models.Category)</span><br><span class="line">admin.site.register(models.Tag)</span><br><span class="line">admin.site.register(models.Comment)</span><br></pre></td></tr></table></figure>

<p>这样我们就可以使用这些表，但是他们是英文的，我们可以在model.py里面改变他们的名字</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">     verbose_name_plural=<span class="string">'用户表'</span></span><br></pre></td></tr></table></figure>

<p>我们进去操作添加添加一条数据显示的是对象，</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span><span class="params">(AbstractUser)</span>:</span></span><br><span class="line">    ...</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.username</span><br></pre></td></tr></table></figure>

<p>避免造成不便语义不明，打印出来</p>
<p>在model里面的字段添加<code>verbose_name=&#39;创建时间&#39;</code>会在admin后天帮助我们把字段的名称改成中文</p>
<h2 id="4-制作站点"><a href="#4-制作站点" class="headerlink" title="4. 制作站点"></a>4. 制作站点</h2><p>打开博客园，在博客园的url后面输入别人的站点名称就可以进到他们的站点，如<a href="https://home.cnblogs.com/the3times在后面输入`the3times`就会进到这个人的博客园的主页，这个是url来配置的，利用url`re`匹配规则就可以实现" target="_blank" rel="noopener">https://home.cnblogs.com/the3times在后面输入`the3times`就会进到这个人的博客园的主页，这个是url来配置的，利用url`re`匹配规则就可以实现</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url(<span class="string">r'^(?P&lt;username&gt;\w+)/$'</span>,views.site,name=<span class="string">'site'</span>),</span><br></pre></td></tr></table></figure>

<h2 id="5-media的配置"><a href="#5-media的配置" class="headerlink" title="5. media的配置"></a>5. media的配置</h2><p>网站用户使用的静态文件默认放在static里面，用户上传的静态文件应该单独放在一个文件夹下，可以使用media配置，该配置可以让用户上传的所有的文件 固定存放在指定的文件夹下</p>
<p>settings.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置用户上传的文件</span></span><br><span class="line">MEDIA_ROOT = os.path.jion(BASE_DIR,<span class="string">'media'</span>)</span><br></pre></td></tr></table></figure>

<p>我们配置后，我们上传文件会自动生成media文件，比如我们注册上传的头像会到这个地方，你存的路径在数据库中也不会改变，</p>
<p>假如你在model.py里面存的路径是<code>avatar/111.png</code>media里面就会多出一个存放头像的<code>avatar/111.png</code>这个就是你存放的头像路径。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span><span class="params">(AbstractUser)</span>:</span></span><br><span class="line">    avatar = models.FileField(upload_to=<span class="string">'avatar/'</span>, default=<span class="string">'avatar/default.png'</span>, verbose_name=<span class="string">'用户头像'</span>)</span><br></pre></td></tr></table></figure>



<p>在前端点击这个头像能够查看到这个头像，需要我们在后端开设一个指定的文件夹资源</p>
<p>在url.py配置参数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.views.static <span class="keyword">import</span> serve</span><br><span class="line"><span class="keyword">from</span> bbs <span class="keyword">import</span> settings</span><br><span class="line"></span><br><span class="line">url(<span class="string">r'^media/(?P&lt;path&gt;.*)'</span>,serve,&#123;<span class="string">'document_root'</span>:settings.MEDIA_ROOT&#125;),</span><br></pre></td></tr></table></figure>

<p>如果你还想暴漏更多资源，在settings修改文件夹名，想暴露源码也可以，问题就大了</p>
<p>最后在html配置,渲染后的路径<code>/media/avatar/default.png/</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;img class="media-object" src="/media/&#123;&#123; article_obj.blog.userinfo.avatar &#125;&#125;" alt="..." width="40"&gt;</span><br></pre></td></tr></table></figure>

<p>这样就可以看到别人的头像</p>
<h2 id="6-站点左边栏展示"><a href="#6-站点左边栏展示" class="headerlink" title="6. 站点左边栏展示"></a>6. 站点左边栏展示</h2><p>左侧边栏展示如何展示的，要清楚orm的查询</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment"># 1.查询当前用户所有分类及分类下的文章数</span></span><br><span class="line">category_list=models.Category.objects.filter(blog=blog).annotate(count_num=Count(<span class="string">'article__pk'</span>)).values_list(<span class="string">'name'</span>,<span class="string">'count_num'</span>,<span class="string">'pk'</span>)</span><br><span class="line">    <span class="comment"># 2.查询当前用户所有标签及标签的文章数</span></span><br><span class="line">tag_list=models.Tag.objects.filter(blog=blog).annotate(count_num=Count(<span class="string">'article__pk'</span>)).values_list(<span class="string">'name'</span>,<span class="string">'count_num'</span>,<span class="string">'pk'</span>) <span class="comment"># &lt;QuerySet [('tank的标签一', 1), ('tank的标签二', 1), ('tank的标签三', 2)]&gt;</span></span><br><span class="line"><span class="comment"># 3.按照日期归档</span></span><br><span class="line">date_list=models.Article.objects.filter(blog=blog).annotate(month=TruncMonth(<span class="string">'create_time'</span>)).values(<span class="string">'month'</span>).annotate(count_num=Count(<span class="string">'pk'</span>)).values_list(<span class="string">'month'</span>,<span class="string">'count_num'</span>)</span><br></pre></td></tr></table></figure>

<p>这里的日期归档我们按照年月归档，但是数据库里面有年月日，我们如何把日去掉官方提供了一个方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">from django.db.models.functions import TruncMonth</span><br><span class="line">			Sales.objects</span><br><span class="line">			.annotate(month&#x3D;TruncMonth(&#39;timestamp&#39;))  # Truncate to month and add to select list</span><br><span class="line">			.values(&#39;month&#39;)  # Group By month</span><br><span class="line">			.annotate(c&#x3D;Count(&#39;id&#39;))  # Select the count of the grouping</span><br><span class="line">			.values(&#39;month&#39;, &#39;c&#39;)  # (might be redundant, haven&#39;t tested) select month and count</span><br></pre></td></tr></table></figure>

<p>上面的日期归档就是按照这个模式搬出来的</p>
<h2 id="7-侧边栏筛选功能"><a href="#7-侧边栏筛选功能" class="headerlink" title="7. 侧边栏筛选功能"></a>7. 侧边栏筛选功能</h2><ul>
<li>显示分类做好之后，点击文章标签、分类、日期归档统计的链接后，显示该条件下的所有文章列表</li>
</ul>
<p>博客园url设计案例</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https://www.cnblogs.com/jason/tag/Python/  		  标签</span><br><span class="line">https://www.cnblogs.com/jason/category/<span class="number">850028.</span>html 分类</span><br><span class="line">https://www.cnblogs.com/jason/archive/<span class="number">2016</span>/<span class="number">10.</span>html 日期</span><br></pre></td></tr></table></figure>

<p><strong>规律：</strong>前面的还是站点名，后面是每个分类后的url</p>
<p><strong>按照这个模式设计我们的url</strong></p>
<ul>
<li>个人站点文章是我们筛选后该站点用户所有的文章，这些标签，分类都是在在上面筛选过后加条件在筛选一次</li>
<li>设计url，处理该url视图函数进一步过滤符合条件的文章</li>
<li>为了显示在一个页面，就在站点的视图里面进行筛选，这样就不要开辟页面</li>
<li>按照上面的url设计在每个分类的后面还有参数，点击不同的文章分类后面出现不同的url，利用每个文章分类的主键值为文章列表</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># url(r'^(?P&lt;username&gt;\w+)/category/(\d+)/',views.site),</span></span><br><span class="line"><span class="comment"># url(r'^(?P&lt;username&gt;\w+)/tag/(\d+)/',views.site),</span></span><br><span class="line"><span class="comment"># url(r'^(?P&lt;username&gt;\w+)/archive/(\w+)/',views.site),</span></span><br></pre></td></tr></table></figure>

<p>前面是匹配站点的名称，后面跟不同的分类，最后匹配主键值</p>
<p><strong>三句和成一句</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url(<span class="string">r'^(?P&lt;username&gt;\w+)/(?P&lt;condition&gt;category|tag|archive/)(?P&lt;param&gt;.*)/'</span>,views.site),</span><br></pre></td></tr></table></figure>

<p><strong>后端业务逻辑</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">site</span><span class="params">(request,username,**kwargs)</span>:</span></span><br><span class="line">    <span class="comment"># 先校验当前用户名的站点是否存在</span></span><br><span class="line">    user_obj = models.UserInfo.objects.filter(username=username).first()</span><br><span class="line">    <span class="comment"># 不存在404页面</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> user_obj:</span><br><span class="line">        <span class="keyword">return</span> render(request,<span class="string">'error.html'</span>)</span><br><span class="line">    <span class="comment"># 先到个人站点</span></span><br><span class="line">    blog = user_obj.blog</span><br><span class="line">    <span class="comment"># 查询当前个人站点下所有的文章</span></span><br><span class="line">    article_list = models.Article.objects.filter(blog=blog)</span><br><span class="line">    <span class="keyword">if</span> kwargs:</span><br><span class="line">        <span class="comment"># print(kwargs)  # &#123;'condition': 'tag', 'param': '1'&#125;</span></span><br><span class="line">        condition = kwargs.get(<span class="string">'condition'</span>)</span><br><span class="line">        param = kwargs.get(<span class="string">'param'</span>)</span><br><span class="line">        <span class="comment"># 判断用户到底想按照哪个条件筛选数据</span></span><br><span class="line">        <span class="keyword">if</span> condition == <span class="string">'category'</span>:</span><br><span class="line">            article_list = article_list.filter(category_id=param)</span><br><span class="line">        <span class="keyword">elif</span> condition == <span class="string">'tag'</span>:</span><br><span class="line">            article_list = article_list.filter(tags__id=param)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            year, month = param.split(<span class="string">'-'</span>)</span><br><span class="line">            article_list = article_list.filter(create_time__year=year, create_time__month=month)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1.查询当前用户所有分类及分类下的文章数</span></span><br><span class="line">    category_list = models.Category.objects.filter(blog=blog).annotate(count_num=Count(<span class="string">'article__pk'</span>)).values_list(<span class="string">'name'</span>,<span class="string">'count_num'</span>,<span class="string">'pk'</span>)</span><br><span class="line">    <span class="comment"># 2.查询当前用户所有标签及标签的文章数</span></span><br><span class="line">    tag_list = models.Tag.objects.filter(blog=blog).annotate(count_num=Count(<span class="string">'article__pk'</span>)).values_list(<span class="string">'name'</span>,<span class="string">'count_num'</span>,<span class="string">'pk'</span>)</span><br><span class="line">    <span class="comment"># 3.按照日期归档</span></span><br><span class="line">    date_list = models.Article.objects.filter(blog=blog).annotate(month=TruncMonth(<span class="string">'create_time'</span>)).values(<span class="string">'month'</span>).annotate(count_num=Count(<span class="string">'pk'</span>)).values_list(<span class="string">'month'</span>,<span class="string">'count_num'</span>)</span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">'site.html'</span>,locals())</span><br></pre></td></tr></table></figure>

<p>解析：<code>**kwargs</code>可能接收额外的参数，先写上去，判断kwargs是否有值，有值再进行操作，``` {‘condition’: ‘tag’, ‘param’: ‘1’}<code>我们点击标签，后面出现我们url设计好的tag，</code>1<code>是标签1的主键值，拿到之后，判断用户像按照哪个条件筛选的，</code>article_list = article_list.filter(tags__id=param)`这个在宅筛选当前站点用户所有的文章之后在进行一次条件筛选</p>
<p><strong>前端</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">	</span><br><span class="line">&lt;!-- 标签 --&gt;</span><br><span class="line">&#123;% <span class="keyword">for</span> tag <span class="keyword">in</span> tag_list %&#125;</span><br><span class="line">   &lt;p&gt;&lt;a href="/&#123;&#123; username &#125;&#125;/tag/&#123;&#123; tag.pk &#125;&#125;/"&gt;&#123;&#123; tag.name &#125;&#125;(&#123;&#123;tag.c&#125;&#125;)&lt;/a&gt;&lt;/p&gt;</span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line"> </span><br><span class="line">&lt;!-- 分类 --&gt;</span><br><span class="line">&#123;% <span class="keyword">for</span> category <span class="keyword">in</span> category_list %&#125;</span><br><span class="line">   &lt;p&gt;&lt;a href="/&#123;&#123;username&#125;&#125;/category/&#123;&#123; category.pk &#125;&#125;"&gt;&#123;&#123; category.name &#125;&#125;(&#123;&#123;category.c&#125;&#125;)&lt;/a&gt;&lt;/p&gt;</span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line"> </span><br><span class="line">&lt;!-- 归档 --&gt;</span><br><span class="line">&#123;% <span class="keyword">for</span> archive <span class="keyword">in</span> archive_list %&#125;</span><br><span class="line">   &lt;p&gt;&lt;a href="/&#123;&#123; username &#125;&#125;/archive/&#123;&#123; archive.month|date:'Y-m' &#125;&#125;/"&gt;&#123;&#123; archive.month|date:'Y年m月' &#125;&#125;(&#123;&#123; archive.c &#125;&#125;)&lt;/a&gt;&lt;/p&gt;</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>

<p><code>//category/</code>把这些url补全，这里的主键值，我们在获取文章查询当前用户所有分类及分类的时候写上去，这样我们就可以在前端拿到主键值<code>values_list(&#39;name&#39;,&#39;count_num&#39;,&#39;pk&#39;)</code></p>
<h2 id="8-inclusion-tag的制作"><a href="#8-inclusion-tag的制作" class="headerlink" title="8. inclusion_tag的制作"></a>8. inclusion_tag的制作</h2><p>我们制作完站点页面之后制作文章详情页，我们可以在站点详情页上面显示文章，但是在一个页面上显示，显示的代码在后端特别的冗余，我们从新开辟一个文章详情页</p>
<ul>
<li>我们建立文章详情页之后，左侧的侧边栏就不会显示，因为我们需要站点的一些数据</li>
<li>该侧边栏在许多页面显示。</li>
<li>直接拷贝代码冗余</li>
</ul>
<p><strong>将侧边栏制作成inclusion_tag</strong></p>
<ul>
<li><p>在应用下创建一个名字必须叫templatetags文件夹</p>
</li>
<li><p>在该文件夹内创建一个任意名字的py文件</p>
</li>
<li><p>在该py文件内固定先写两汉代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> template</span><br><span class="line">register = template.Library()</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p><strong>后端封装代码</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> template</span><br><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> Count</span><br><span class="line"><span class="keyword">from</span> django.db.models.functions <span class="keyword">import</span> TruncMonth</span><br><span class="line"><span class="keyword">from</span> app01 <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line">register = template.Library()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义inclusion_tag</span></span><br><span class="line"><span class="meta">@register.inclusion_tag('left_meun.html')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">left_meun</span><span class="params">(username)</span>:</span></span><br><span class="line">    user_obj = models.UserInfo.objects.filter(username=username).first()</span><br><span class="line">    <span class="comment"># 1.查询当前用户所有分类及分类下的文章数</span></span><br><span class="line">    blog = user_obj.blog</span><br><span class="line">    category_list = models.Category.objects.filter(blog=blog).annotate(count_num=Count(<span class="string">'article__pk'</span>)).values_list(</span><br><span class="line">        <span class="string">'name'</span>, <span class="string">'count_num'</span>, <span class="string">'pk'</span>)</span><br><span class="line">    <span class="comment"># 2.查询当前用户所有标签及标签的文章数</span></span><br><span class="line">    tag_list = models.Tag.objects.filter(blog=blog).annotate(count_num=Count(<span class="string">'article__pk'</span>)).values_list(<span class="string">'name'</span>,</span><br><span class="line">                                                                                                         <span class="string">'count_num'</span>,  </span><br><span class="line">    <span class="comment"># 3.按照日期归档</span></span><br><span class="line">    date_list = models.Article.objects.filter(blog=blog).annotate(month=TruncMonth(<span class="string">'create_time'</span>)).values(</span><br><span class="line">        <span class="string">'month'</span>).annotate(count_num=Count(<span class="string">'pk'</span>)).values_list(<span class="string">'month'</span>, <span class="string">'count_num'</span>)</span><br><span class="line">    <span class="keyword">return</span> locals()</span><br></pre></td></tr></table></figure>

<p><strong>前端建立一个letf_meun.html把左侧边栏的代码放在这里</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;div class="panel panel-success"&gt;...&lt;/div&gt;</span><br><span class="line">&lt;div class="panel panel-primary"&gt;...&lt;/div&gt;</span><br><span class="line">&lt;div class="panel panel-danger"&gt;... &lt;/div&gt;</span><br></pre></td></tr></table></figure>

<p>在需要侧边栏的地方写如在base.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% load mytag %&#125;</span><br><span class="line">&#123;% left_meun username %&#125;</span><br></pre></td></tr></table></figure>

<p>这样在每个页面需要左侧边栏的地方都可以显示了。这样就可以避免大量的冗余代码，也可以少些</p>
<h2 id="8-根评论子评论"><a href="#8-根评论子评论" class="headerlink" title="8 根评论子评论"></a>8 根评论子评论</h2><ul>
<li>允许根评论和子评论（评论评论的评论），可以评论自己的文章。</li>
<li>用户未登录不能评论且隐藏评论输入框(request.user.is_authenticated)。</li>
<li>评论内容有两种渲染方式：<ul>
<li>刷新页面时，从后端取出评论数据，前端循环展示</li>
<li>评论后DOM操作临时将评论内容渲染到评论列表，使用的是js的模版字符串语法。</li>
</ul>
</li>
<li>根评论朝后端提交的数据：文章主键、评论内容、</li>
<li>子评论朝后端提交的数据：文章主键、评论内容、父评论主键</li>
<li>获取父评论的方式：给回复按钮绑定一个自定义属性，属性值为父评论主键</li>
<li>区分子评论和根评论关键在于是否有父评论，这里面为了统一，提交根评论时也携带父评论（只不过值为null，因为数据库该字段支持为空）。</li>
</ul>
<p><strong>后端</strong></p>
<ul>
<li>需要登录后才能评论，所以使用一个登录校验装饰器</li>
<li>后端逻辑比较简单，接收评论内容、文章主键、父评论主键</li>
<li>评论内容为空值，响应提示信息</li>
<li>使用事物同时更新文章表和评论表。</li>
</ul>
<p>代码主要都在前端</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//设置一个全局的parentId字段</span><br><span class="line">let parentId =null</span><br><span class="line">// 用户发表评论按钮发送ajax请求</span><br><span class="line">$(<span class="string">'#id_submit'</span>).click(function () &#123;</span><br><span class="line">    //先拿到用户评论的内容</span><br><span class="line">    let conTent = $(<span class="string">'#id_comment'</span>).val();</span><br><span class="line">    //因为子评论存的时候不应该有@人名，所以我们要手动去除@username</span><br><span class="line">    <span class="keyword">if</span> (parentId)&#123;</span><br><span class="line">        let indexNum = conTent.indexOf(<span class="string">'\n'</span>) + <span class="number">1</span>;//找到\n对应的索引。然后切片，但是骨头不顾尾要+<span class="number">1</span></span><br><span class="line">        conTent = conTent.slice(indexNum)//将indexNum之前的所有数据清楚，只保留后面的部分</span><br><span class="line">    &#125;</span><br><span class="line">    $.ajax(&#123;</span><br><span class="line">        url:<span class="string">'/comment/'</span>,</span><br><span class="line">        type:<span class="string">'post'</span>,</span><br><span class="line">        data: &#123;</span><br><span class="line">            <span class="string">'article_id'</span>:<span class="string">'&#123;&#123; article_obj.pk &#125;&#125;'</span>,</span><br><span class="line">            <span class="string">'content'</span>:conTent,</span><br><span class="line">            // 如果parentId没有值，就是null，后面数据库可以为null没任何问题</span><br><span class="line">            <span class="string">'parent_id'</span>:parentId,</span><br><span class="line">            <span class="string">'csrfmiddlewaretoken'</span>:<span class="string">'&#123;&#123; csrf_token &#125;&#125;'</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        success:function (args) &#123;</span><br><span class="line">                <span class="keyword">if</span> (args.code==<span class="number">1000</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    $(<span class="string">'#error'</span>).text(args.msg)</span><br><span class="line">                    //评论框里面的内容清空</span><br><span class="line">                    $(<span class="string">'id_comment'</span>).val(<span class="string">''</span>);</span><br><span class="line">                    //临时渲染</span><br><span class="line">                    let userName=<span class="string">'&#123;&#123; request.user.username &#125;&#125;'</span>;</span><br><span class="line">                    let temp = `</span><br><span class="line">                    &lt;li class="list-group-item"&gt;</span><br><span class="line"></span><br><span class="line">                        &lt;span&gt;$&#123;userName&#125;&lt;/span&gt;</span><br><span class="line">                        &lt;span&gt;&lt;a href="#" class="pull-right"&gt;回复&lt;/a&gt;&lt;/span&gt;</span><br><span class="line">                        &lt;div&gt;</span><br><span class="line">                            $&#123;conTent&#125;</span><br><span class="line">                        &lt;/div&gt;</span><br><span class="line">                        &lt;/li&gt;</span><br><span class="line">                    `</span><br><span class="line">                    //添加到ul里面</span><br><span class="line">                    $(<span class="string">'.list-group'</span>).append(temp)</span><br><span class="line">                    //清空全局的parentId</span><br><span class="line">                    parentId = null;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">&#125;)</span><br><span class="line">//  给回复按钮绑定点击事件</span><br><span class="line">$(<span class="string">'.reply'</span>).click(function () &#123;</span><br><span class="line">    //需要评论对应的评论人姓名，还需要评论的主键值</span><br><span class="line">    //获取用户名和主键值，自定义属性</span><br><span class="line">    let commentUsername = $(this).attr(<span class="string">'username'</span>);</span><br><span class="line">    //直接修改全局</span><br><span class="line">    parentId =$(this).attr(<span class="string">'comment_id'</span>);</span><br><span class="line">    //拼接信息塞给评论框</span><br><span class="line">    $(<span class="string">'#id_comment'</span>).val(<span class="string">'@'</span>+ commentUsername + <span class="string">'\n'</span>).focus()</span><br><span class="line"></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><strong>解析步骤</strong>：</p>
<ul>
<li><p>用户放松ajax请求</p>
</li>
<li><p>拿到用户评论内容</p>
</li>
<li><p>临时渲染评论框，但是只显示一个人的名字</p>
</li>
<li><p>这个时候把临时渲染的评论框加到ul里面，根评论完成</p>
</li>
<li><p>子评论给回复按钮绑定点击事件</p>
</li>
<li><p>这个时候我们要拿到对应的评论人的用户名，还有评论的id主键值</p>
</li>
<li><p>如何获取用户名和主键值，给他们自定义属性</p>
<p><code>&lt;span&gt;&lt;a  class=&quot;pull-right reply&quot; username=&quot;&quot; comment_id=&quot;&quot;&gt;回复&lt;/a&gt;&lt;/span&gt;</code></p>
</li>
<li><p>拼接信息给评论框</p>
</li>
<li><p>发送信息如何发送呢，设置一个全局的子评论字段，子评论的内容直接修改全局</p>
</li>
<li><p>但是我们发送的时候parentId没有值，就是null，正好数据库的parent_id字段可以为null没有任何问题</p>
</li>
<li><p>评论时存储的有@用户名，所以我们要手动去除@username</p>
</li>
<li><p>找到\n，因为我们在拼接信息的时候\n前面就是@username用户名，我们截取到\n，切片固头不顾尾+1<code>let indexNum = conTent.indexOf(&#39;\n&#39;) + 1</code></p>
</li>
<li><p>将indexNum之前的所有数据清除，保留后面的部分</p>
</li>
<li><p>这个时候我们在写根评论的时候还有子评论的主键值，要清除全局的parentId</p>
</li>
</ul>
<p><strong>后端</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开启事务操作两种表</span></span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> transaction</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">comment</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="comment"># 自己也能评论</span></span><br><span class="line">    <span class="keyword">if</span> request.is_ajax():</span><br><span class="line">        <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</span><br><span class="line">            back_dic = &#123;<span class="string">'code'</span>: <span class="number">1000</span>, <span class="string">'msg'</span>: <span class="string">''</span>&#125;</span><br><span class="line">            <span class="keyword">if</span> request.user.is_authenticated:</span><br><span class="line">                article_id = request.POST.get(<span class="string">'article_id'</span>)</span><br><span class="line">                content = request.POST.get(<span class="string">'content'</span>)</span><br><span class="line">                parent_id = request.POST.get(<span class="string">'parent_id'</span>)</span><br><span class="line">                <span class="comment"># 直接操作评论表存数据，两张表</span></span><br><span class="line">                <span class="keyword">with</span> transaction.atomic():</span><br><span class="line">                    models.Article. objects.filter(pk=article_id).update(comment_num=F(<span class="string">'comment_num'</span>) + <span class="number">1</span>)</span><br><span class="line">                    models.Comment.objects.create(parent_id=parent_id,user=request.user, article_id=article_id, content=content)</span><br><span class="line"></span><br><span class="line">                back_dic[<span class="string">'msg'</span>] = <span class="string">'评论成功'</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                back_dic[<span class="string">'code'</span>] = <span class="number">10001</span></span><br><span class="line">                back_dic[<span class="string">'msg'</span>] = <span class="string">'用户未登录'</span></span><br><span class="line">            <span class="keyword">return</span> JsonResponse(back_dic)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>我们需要操作多张表的时候可以开启事务</p>
</li>
<li><p>因为子评论可以为空，直接接收，可以省很多事情</p>
</li>
</ul>
<h2 id="9-beautifulsuop4"><a href="#9-beautifulsuop4" class="headerlink" title="9 beautifulsuop4"></a>9 beautifulsuop4</h2><ul>
<li>编辑别的博客复制在富文本编辑器，会有html页面代码，截取文本内容代码一起截取</li>
<li>xss攻击，如在里面使用script代码写内容，保存不显示</li>
<li>筛选标签去除html代码</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">content = request.POST.get(<span class="string">'content'</span>)</span><br><span class="line"></span><br><span class="line">soup = BeautifulSoup(content, <span class="string">'html.parser'</span>) // 把要筛选的内容放进去</span><br><span class="line">tags = soup.find_all() // 找到所有标签</span><br><span class="line"><span class="keyword">for</span> tag <span class="keyword">in</span> tags:</span><br><span class="line">    <span class="keyword">if</span> tag.name == <span class="string">'script'</span>: //</span><br><span class="line">    找到script标签</span><br><span class="line">    tag.decompose() // 删除标签</span><br><span class="line">desc = soup.text[<span class="number">0</span>:<span class="number">150</span>] // 截取文章描述</span><br><span class="line">article_obj = models.Article.objects.create(</span><br><span class="line">    title=title,</span><br><span class="line">    content=str(soup),</span><br><span class="line">    desc=desc,</span><br><span class="line">    category_id=category_id,</span><br><span class="line">    blog=request.user.blog</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h2 id="10-富文本编辑器遗留问题"><a href="#10-富文本编辑器遗留问题" class="headerlink" title="10 富文本编辑器遗留问题"></a>10 富文本编辑器遗留问题</h2><ul>
<li>在上传图片会出现下载问题</li>
<li>403：forbidden</li>
<li>自定义富文本编辑器</li>
</ul>
<p><strong>前端</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">添加参数：uploadJson:<span class="string">'/路径/'</span></span><br><span class="line">自定义参数：extraFileUploadParams : &#123;&#125;</span><br><span class="line">添加：  csrfmiddlewaretoken:<span class="string">'&#123;&#123; csrf_token &#125;&#125;'</span></span><br></pre></td></tr></table></figure>

<p><strong>后端：</strong></p>
<ul>
<li>获取上传的图片文件的键</li>
<li>拼接上传路径</li>
<li>返回media开放的资源路径</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> bbs <span class="keyword">import</span> settings</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload_img</span><span class="params">(request)</span>:</span></span><br><span class="line">    back_dic = &#123;<span class="string">'error'</span>:<span class="number">0</span>,<span class="string">'url'</span>:<span class="string">''</span>&#125;</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</span><br><span class="line">        file_obj = request.FILES.get(<span class="string">'imgFile'</span>)//这里不知道键是多少，用request.FILES打印看一下</span><br><span class="line">        <span class="comment"># 手动拼接</span></span><br><span class="line">        file_path = os.path.join(settings.BASE_DIR,<span class="string">'media'</span>,<span class="string">'article_img'</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.isdir(file_path):</span><br><span class="line">            os.mkdir(file_path)</span><br><span class="line">        file_img = os.path.join(file_path,file_obj.name)</span><br><span class="line">        <span class="keyword">with</span> open(file_img,<span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> file_obj:</span><br><span class="line">                f.write(i)</span><br><span class="line">        back_dic[<span class="string">'url'</span>] = <span class="string">'/media/article_img/%s'</span>%file_obj.name</span><br><span class="line">    <span class="keyword">return</span> JsonResponse(back_dic)</span><br></pre></td></tr></table></figure>

<ul>
<li>获取键，手动拼接路径，判断是否存在文件夹，不存在创建</li>
<li>用<code>with open</code>保存文件</li>
<li>开放资源路径</li>
</ul>
<h2 id="11-修改头像问题"><a href="#11-修改头像问题" class="headerlink" title="11 修改头像问题"></a>11 修改头像问题</h2><p>修改头像出现了csrf-403-forbidden问题</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">'#id_set_avatar'</span>).click(function () &#123;</span><br><span class="line"></span><br><span class="line">   let formDataObj = new FormData();		// 将普通数据和文件添加到该对象中</span><br><span class="line">   formDataObj.append(<span class="string">'avatar'</span>, $(<span class="string">'#myfile'</span>)[<span class="number">0</span>].files[<span class="number">0</span>]);</span><br><span class="line">   formDataObJ.append(<span class="string">'csrfmiddelwaretoken'</span>:<span class="string">'&#123;&#123;csrf_token&#125;&#125;'</span>)</span><br><span class="line"></span><br><span class="line">    $.ajax(&#123;</span><br><span class="line">        url: <span class="string">'&#123;% url '</span>set_avata<span class="string">r' %&#125;'</span>,</span><br><span class="line"></span><br><span class="line">        type: <span class="string">'post'</span>,</span><br><span class="line">        data:formDataObj,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        contentType: false,  			// 必须的</span><br><span class="line">        processData: false,</span><br><span class="line">        // 必须的</span><br><span class="line">        success: function (args) &#123;</span><br><span class="line">            <span class="keyword">if</span> (args.code===<span class="number">1000</span>)&#123;</span><br><span class="line">                window.location.href = args.url</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>这个是正确的书写,我在加中间件的csrf的时候</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">'#id_set_avatar'</span>).click(function () &#123;</span><br><span class="line"></span><br><span class="line">   let formDataObj = new FormData();		// 将普通数据和文件添加到该对象中</span><br><span class="line">    $.ajax(&#123;</span><br><span class="line">        url: <span class="string">'&#123;% url '</span>set_avata<span class="string">r' %&#125;'</span>,</span><br><span class="line"></span><br><span class="line">        type: <span class="string">'post'</span>,</span><br><span class="line">        data:&#123;<span class="string">'avatar'</span>, $(<span class="string">'#myfile'</span>)[<span class="number">0</span>].files[<span class="number">0</span>],</span><br><span class="line">             	<span class="string">'csrfmiddelwaretoken'</span>:<span class="string">'&#123;&#123;csrf_token&#125;&#125;'</span>&#125;// 因为他的数据本身就是一个对象，这样写对象套对象访问不到这个数据</span><br><span class="line">        contentType: false,  			// 必须的</span><br><span class="line">        processData: false,</span><br><span class="line">        // 必须的</span><br><span class="line">        success: function (args) &#123;</span><br><span class="line">            <span class="keyword">if</span> (args.code===<span class="number">1000</span>)&#123;</span><br><span class="line">                window.location.href = args.url</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">


</div>



	<div class="article-share" id="share">
	
	  <div data-url="http://yoursite.com/2020/07/05/bbs/" data-title="bbs | Hexo" data-tsina="" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
	



</div>  
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">Contents</strong>
 
 <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#bbs技术点总结"><span class="toc-number">1.</span> <span class="toc-text">bbs技术点总结</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-用户注册上传头像"><span class="toc-number">1.1.</span> <span class="toc-text">1. 用户注册上传头像</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-生成登录验证码"><span class="toc-number">1.2.</span> <span class="toc-text">2. 生成登录验证码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-admin的使用"><span class="toc-number">1.3.</span> <span class="toc-text">3. admin的使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-制作站点"><span class="toc-number">1.4.</span> <span class="toc-text">4. 制作站点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-media的配置"><span class="toc-number">1.5.</span> <span class="toc-text">5. media的配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-站点左边栏展示"><span class="toc-number">1.6.</span> <span class="toc-text">6. 站点左边栏展示</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-侧边栏筛选功能"><span class="toc-number">1.7.</span> <span class="toc-text">7. 侧边栏筛选功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-inclusion-tag的制作"><span class="toc-number">1.8.</span> <span class="toc-text">8. inclusion_tag的制作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-根评论子评论"><span class="toc-number">1.9.</span> <span class="toc-text">8 根评论子评论</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-beautifulsuop4"><span class="toc-number">1.10.</span> <span class="toc-text">9 beautifulsuop4</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-富文本编辑器遗留问题"><span class="toc-number">1.11.</span> <span class="toc-text">10 富文本编辑器遗留问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-修改头像问题"><span class="toc-number">1.12.</span> <span class="toc-text">11 修改头像问题</span></a></li></ol></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">

  


  

  

  <div class="linkslist">
  <p class="asidetitle">Links</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">Weibo</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=&verifier=b3593ceb&dpc=1"></iframe>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m Larry Page in Google. <br/>
			This is my blog,believe it or not.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/2176287895" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2020 
		
		<a href="/about" target="_blank" title="John Doe">John Doe</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>











<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e6d1f421bbc9962127a50488f9ed37d1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="Back to Top"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
