<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><link rel="stylesheet" type="text/css" href="//fonts.loli.net/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.5"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.5"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><link rel="stylesheet" type="text/css" href="https://unpkg.com/gitalk/dist/gitalk.css?v=2.0.5"><title>drf路由的配置 | Simple</title><meta name="generator" content="Hexo 4.2.1"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">drf路由的配置</h1><a id="logo" href="/.">Simple</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="搜索"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">drf路由的配置</h1><div class="post-meta"><a href="/2019/10/11/drf-%E8%B7%AF%E7%94%B1%E5%92%8C%E8%AE%A4%E8%AF%81/#comments" class="comment-count"></a><p><span class="date">Oct 11, 2019</span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>点击</i></i></span></p></div><div class="post-content"><h2 id="1-三种路由的配置"><a href="#1-三种路由的配置" class="headerlink" title="1 三种路由的配置"></a>1 三种路由的配置</h2><p> <strong>在urls.py里面的配置的常规配置</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">path(<span class="string">'books4/'</span>, views.Book4View.as_view()),</span><br><span class="line">re_path(<span class="string">'books4/(?P&lt;pk&gt;\d+)'</span>, views.Book4DetailView.as_view())</span><br></pre></td></tr></table></figure>

<p><strong>视图类中继承了ViewSetMixin</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">path(<span class="string">'books5/'</span>, views.Book5View.as_view(actions=&#123;<span class="string">'get'</span>:<span class="string">'list'</span>,<span class="string">'post'</span>:<span class="string">'create'</span>&#125;)), <span class="comment">#当路径匹配，又是get请求，会执行Book5View的list方法</span></span><br><span class="line">re_path(<span class="string">'books5/(?P&lt;pk&gt;\d+)'</span>, views.Book5View.as_view(actions=&#123;<span class="string">'get'</span>:<span class="string">'retrieve'</span>,<span class="string">'put'</span>:<span class="string">'update'</span>,<span class="string">'delete'</span>:<span class="string">'destroy'</span>&#125;)),</span><br></pre></td></tr></table></figure>

<p><strong>继承视图类ModelViewSet路由的写法</strong></p>
<ul>
<li><p>配置路由导入模块</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span>  rest_framework <span class="keyword">import</span> routers</span><br></pre></td></tr></table></figure>
</li>
<li><p>两个类,实例化得到对象</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">routers.DefaultRouter</span><br><span class="line">····</span><br><span class="line">^books/$ [name=<span class="string">'book-list'</span>] <span class="comment"># 根</span></span><br><span class="line">^books\.(?P&lt;format&gt;[a-z0-9]+)/?$ [name='book-list']# simple的差不多</span><br><span class="line">^books/(?P&lt;pk&gt;[^/.]+)/$ [name='book-detail']</span><br><span class="line">^books/(?P&lt;pk&gt;[^/.]+)\.(?P&lt;format&gt;[a-z0-9]+)/?$ [name='book-detail']# 和simple的差不多</span><br><span class="line">^$ [name=<span class="string">'api-root'</span>]<span class="comment"># 根路径会显示出所有可以访问的地址</span></span><br><span class="line">^\.(?P&lt;format&gt;[a-z0-9]+)/?$ [name='api-root']</span><br><span class="line">····</span><br><span class="line">自动生成的<span class="number">6</span>个路由</span><br><span class="line">routers.SimpleRouter</span><br><span class="line"></span><br><span class="line"><span class="string">"""[&lt;RegexURLPattern book-list ^books/$&gt;,</span></span><br><span class="line"><span class="string">&lt;RegexURLPattern book-detail ^books/(?P&lt;pk&gt;[^/.]+)/$&gt;]"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line">自动生成的<span class="number">2</span>个路由</span><br></pre></td></tr></table></figure>
</li>
<li><p>注册</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">router.register(<span class="string">'books'</span>,views.BookViewSet)<span class="comment"># 后面可以加别名</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>自动生成路由，加入到原来的路由中去</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns+=router.urls</span><br></pre></td></tr></table></figure>

<h3 id="action的使用"><a href="#action的使用" class="headerlink" title="action的使用"></a>action的使用</h3><p>是为了给继承ModelViewSet视图类定义的函数也添加路由</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookViewSet</span><span class="params">(ModelViewSet)</span>:</span></span><br><span class="line">    queryset = models.Book.objects.all()</span><br><span class="line">    serializer_class = BookModelSerializer</span><br><span class="line"></span><br><span class="line"><span class="meta">    @action(methods=['GET','post'], detail=True)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_5</span><span class="params">(self, request,pk)</span>:</span></span><br><span class="line">        book = self.get_queryset()[:<span class="number">5</span>]  <span class="comment"># 从0开始截取</span></span><br><span class="line">        ser = self.get_serializer(book, many=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> Response(ser.data)</span><br></pre></td></tr></table></figure>
</li>
<li><p>methods:第一个参数，传一个列表，列表中放请求方式，如get，post等</p>
</li>
<li><p>detail: </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">^books/get_1/$ [name=<span class="string">'book-get-1'</span>] 当向这个地址发送get请求，会执行下面的函数</span><br><span class="line">detail：布尔类型 如果是<span class="literal">True</span></span><br><span class="line">^books/(?P&lt;pk&gt;[^/.]+)/get_1/$ [name='book-get-1']</span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8000</span>/books/<span class="number">1</span>/get_5/</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h1 id="认证"><a href="#认证" class="headerlink" title="认证"></a>认证</h1><h2 id="1-认证的实现"><a href="#1-认证的实现" class="headerlink" title="1 认证的实现"></a>1 认证的实现</h2><pre><code>1 写一个类，继承BaseAuthentication，重写authenticate，认证的逻辑写在里面，认证通过，返回两个值，一个值最终给了Requet对象的user，认证失败，抛异常：APIException或者AuthenticationFailed
2 全局使用，局部使用</code></pre><h2 id="2-drf认证的源码分析"><a href="#2-drf认证的源码分析" class="headerlink" title="2 drf认证的源码分析"></a>2 drf认证的源码分析</h2><p><strong>入口点</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">在APIView--&gt;  as_view--&gt; dispatch方法--&gt; self.initial(request, *args, **kwargs)</span><br><span class="line">这个方法中有认证，权限，频率</span><br></pre></td></tr></table></figure>

<p><strong>dispatch方法源码</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dispatch</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">   </span><br><span class="line">    self.args = args</span><br><span class="line">    self.kwargs = kwargs</span><br><span class="line">    request = self.initialize_request(request, *args, **kwargs)</span><br><span class="line">    self.request = request</span><br><span class="line">    self.headers = self.default_response_headers  <span class="comment"># deprecate?</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        self.initial(request, *args, **kwargs) </span><br><span class="line"></span><br><span class="line">        <span class="comment"># Get the appropriate handler method</span></span><br><span class="line">        <span class="keyword">if</span> request.method.lower() <span class="keyword">in</span> self.http_method_names:</span><br><span class="line">            handler = getattr(self, request.method.lower(),</span><br><span class="line">                              self.http_method_not_allowed)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            handler = self.http_method_not_allowed</span><br><span class="line"></span><br><span class="line">        response = handler(request, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> exc:</span><br><span class="line">        response = self.handle_exception(exc)</span><br><span class="line"></span><br><span class="line">    self.response = self.finalize_response(request, response, *args, **kwargs)</span><br><span class="line">    <span class="keyword">return</span> self.response</span><br></pre></td></tr></table></figure>

<p>在try里面 <code>self.initial</code>这个方法点进去，在APIView里面</p>
<p><strong>initital方法</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">initial</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">      <span class="string">"""</span></span><br><span class="line"><span class="string">      Runs anything that needs to occur prior to calling the method handler.</span></span><br><span class="line"><span class="string">      """</span></span><br><span class="line">      self.format_kwarg = self.get_format_suffix(**kwargs)</span><br><span class="line">      neg = self.perform_content_negotiation(request)</span><br><span class="line">      request.accepted_renderer, request.accepted_media_type = neg</span><br><span class="line"></span><br><span class="line">      version, scheme = self.determine_version(request, *args, **kwargs)</span><br><span class="line">      request.version, request.versioning_scheme = version, scheme</span><br><span class="line"></span><br><span class="line">      self.perform_authentication(request)</span><br><span class="line">      self.check_permissions(request)</span><br><span class="line">      self.check_throttles(request)</span><br></pre></td></tr></table></figure>

<p><code>self.perform_authentication(request)</code>只读这个认证的功能 ，传个request过来，这个request是包装后的，</p>
<p><strong>perform_authentication方法的源码</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">perform_authentication</span><span class="params">(self, request)</span>:</span></span><br><span class="line">    request.user</span><br></pre></td></tr></table></figure>

<p>因为这个是包装过后的Request，所以我们要到包装过后的request对象里面的user属性</p>
<p><strong>user属性源码</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@property</span></span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">user</span><span class="params">(self)</span>:</span></span><br><span class="line">       <span class="keyword">if</span> <span class="keyword">not</span> hasattr(self, <span class="string">'_user'</span>):</span><br><span class="line">           <span class="keyword">with</span> wrap_attributeerrors():</span><br><span class="line">               self._authenticate()</span><br><span class="line">       <span class="keyword">return</span> self._user</span><br></pre></td></tr></table></figure>

<p>判断self里面有没有_user这个属性，一开始是没有的，它就会走下面的上下文管理器， self._authenticate()</p>
<p>点_authenticate这个方法，这个方法还在Request对象里面，</p>
<p> <strong>_authenticate源码</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_authenticate</span><span class="params">(self)</span>:</span></span><br><span class="line">   <span class="keyword">for</span> authenticator <span class="keyword">in</span> self.authenticators:</span><br><span class="line">       <span class="keyword">try</span>:</span><br><span class="line">           user_auth_tuple = authenticator.authenticate(self)</span><br><span class="line">       <span class="keyword">except</span> exceptions.APIException:</span><br><span class="line">           self._not_authenticated()</span><br><span class="line">           <span class="keyword">raise</span></span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> user_auth_tuple <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">           self._authenticator = authenticator</span><br><span class="line">           self.user, self.auth = user_auth_tuple</span><br><span class="line">           <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">   self._not_authenticated()</span><br></pre></td></tr></table></figure>



<p>这里的for循环的authenticators一定是一个可迭代对象，我们要到Request对象里面去找，</p>
 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Request</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, request, parsers=None, authenticators=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                 negotiator=None, parser_context=None)</span>:</span></span><br><span class="line">        <span class="keyword">assert</span> isinstance(request, HttpRequest), (</span><br><span class="line">            <span class="string">'The `request` argument must be an instance of '</span></span><br><span class="line">            <span class="string">'`django.http.HttpRequest`, not `&#123;&#125;.&#123;&#125;`.'</span></span><br><span class="line">            .format(request.__class__.__module__, request.__class__.__name__)</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        self._request = request</span><br><span class="line"></span><br><span class="line">        self.authenticators = authenticators <span class="keyword">or</span> ()</span><br></pre></td></tr></table></figure>

<p>我们发现是在这个类里面初始化得到的，这个类是dispatch包装request得到的，<code>request = self.initialize_request(request, *args, **kwargs)</code>点击<code>initialize_request</code>这个方法</p>
<p>我们发现了<code>authenticators</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">return</span> Request(</span><br><span class="line">    request,</span><br><span class="line">    parsers=self.get_parsers(),</span><br><span class="line">    authenticators=self.get_authenticators(),</span><br><span class="line">    negotiator=self.get_content_negotiator(),</span><br><span class="line">    parser_context=parser_context</span><br><span class="line">)</span><br></pre></td></tr></table></figure>



<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_authenticators</span><span class="params">(self)</span>:</span></span><br><span class="line">     </span><br><span class="line">       <span class="keyword">return</span> [auth() <span class="keyword">for</span> auth <span class="keyword">in</span> self.authentication_classes]</span><br></pre></td></tr></table></figure>

<p>这个是列表生成式，从自己`authentication_classes去取，取出一个加括号执行，这个self是APIView里面的对象的属性，因为自己视图类里面没有</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">authentication_classes = api_settings.DEFAULT_AUTHENTICATION_CLASSES</span><br></pre></td></tr></table></figure>

<p>列表中是一对对象，是视图类中配置的<code>authentication_classes=[类名]对象</code>，</p>
<p>所以Request对象中的<code>authenticators=self.get_authenticators()</code>是列表[类的对象]，被传到了Request对象定义的这个 <code>self.authenticators = authenticators or ()</code>传给了<code>authenticators</code>里面，</p>
<p> <strong>_authenticate源码</strong>里面的for循环，就是self.authenticators 配置的一堆认证产生类对象组成的list，每次循环拿到一个对象</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_authenticate</span><span class="params">(self)</span>:</span></span><br><span class="line">     <span class="keyword">for</span> authenticator <span class="keyword">in</span> self.authenticators:</span><br><span class="line">         <span class="keyword">try</span>:</span><br><span class="line">             user_auth_tuple = authenticator.authenticate(self)</span><br><span class="line">         <span class="keyword">except</span> exceptions.APIException:</span><br><span class="line">             self._not_authenticated()</span><br><span class="line">             <span class="keyword">raise</span></span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> user_auth_tuple <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">             self._authenticator = authenticator</span><br><span class="line">             self.user, self.auth = user_auth_tuple</span><br><span class="line">             <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">     self._not_authenticated()</span><br></pre></td></tr></table></figure>

<p>authenticator.authenticate这个就是为什么要重写这个方法，执行这个方法，返回的时候是两个值，解压赋值，认证逻辑通过，返回两个值，一个值给了Request对象的user，认证失败，抛出异常APIException，也可以抛出<code>AuthenticationFailed</code>它里面也是继承了<code>APIException</code></p>
<h2 id="3-认证组件的使用"><a href="#3-认证组件的使用" class="headerlink" title="3 认证组件的使用"></a>3 认证组件的使用</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.authentication <span class="keyword">import</span> BaseAuthentication</span><br><span class="line"><span class="keyword">from</span> rest_framework.exceptions <span class="keyword">import</span> AuthenticationFailed</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyAuthentication</span><span class="params">(BaseAuthentication)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">authenticate</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        <span class="comment"># 认证逻辑，通过返回两个值</span></span><br><span class="line">        token = request.GET.get(<span class="string">'token'</span>) <span class="comment">#token = request.META.get('HTTP_TOKEN')这个是放在请求头里面</span></span><br><span class="line">        <span class="keyword">if</span> token:</span><br><span class="line">            <span class="keyword">from</span> app01 <span class="keyword">import</span> models</span><br><span class="line">            user_token = models.UserToken.objects.filter(token=token).first()</span><br><span class="line">            <span class="keyword">if</span> user_token:</span><br><span class="line">                <span class="keyword">return</span> user_token.user,token</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">raise</span> AuthenticationFailed(<span class="string">'认证失败'</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> AuthenticationFailed(<span class="string">'请求地址中需要携带token'</span>)</span><br></pre></td></tr></table></figure>

<h2 id="4-全局使用和局部禁用"><a href="#4-全局使用和局部禁用" class="headerlink" title="4 全局使用和局部禁用"></a>4 全局使用和局部禁用</h2><figure class="highlight python"><figcaption><span>'</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">全局使用在settings里面配置</span><br><span class="line">REST_FRAMEWORK=&#123;</span><br><span class="line">    <span class="string">"DEFAULT_AUTHENTICATION_CLASSES"</span>:[<span class="string">"app01.app_auth.MyAuthentication"</span>,]</span><br><span class="line">&#125;</span><br><span class="line">局部使用：</span><br><span class="line">authentication_classes=[MyAuthentication]</span><br><span class="line">局部禁用：在登陆的时候就不需要，因为你还没登录呢，如何做认证</span><br><span class="line">authentication_classes=[] 里面什么都不加就可以了</span><br></pre></td></tr></table></figure>

</div><div class="post-copyright"><blockquote><p>原文作者: Simple</p><p>原文链接: <a href="http://yoursite.com/2019/10/11/drf-路由和认证/">http://yoursite.com/2019/10/11/drf-路由和认证/</a></p><p>版权声明: 转载请注明出处(必须保留作者署名及链接)</p></blockquote></div><div class="tags"><a href="/tags/python/">python</a></div><div class="post-share"><div class="social-share"><span>分享到:</span></div></div><div class="post-nav"><a href="/2020/07/05/django-%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%AC%94%E8%AE%B0/" class="pre">django-中间件笔记</a><a href="/2019/10/09/drf-%E8%AF%B7%E6%B1%82%E5%92%8C%E5%93%8D%E5%BA%94/" class="next">请求和响应</a></div><div id="comments"><div id="container"><script type="text/javascript" src="https://unpkg.com/gitalk/dist/gitalk.min.js?v=2.0.5"></script><script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js?v=2.0.5"></script><script>var gitalk = new Gitalk({
  clientID: '0166bf5540dd89613207',
  clientSecret: '3c34e343b2e8c0f24c9e069e9874e2a661bdd7a3',
  repo: 'git@github.com:zc117809/comment.git',
  owner: 'zc117809',
  admin: ['zc117809'],
  id: md5(window.location.pathname),
  distractionFreeMode: false,
  language: 'zh-CN',
  pagerDirection: 'last'
})
gitalk.render('container')</script></div></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-三种路由的配置"><span class="toc-text">1 三种路由的配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#action的使用"><span class="toc-text">action的使用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#认证"><span class="toc-text">认证</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-认证的实现"><span class="toc-text">1 认证的实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-drf认证的源码分析"><span class="toc-text">2 drf认证的源码分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-认证组件的使用"><span class="toc-text">3 认证组件的使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-全局使用和局部禁用"><span class="toc-text">4 全局使用和局部禁用</span></a></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/07/09/django-csrf%20%E8%B7%A8%E7%AB%99%E8%AF%B7%E6%B1%82%E4%BC%AA%E9%80%A0/">django-csrf 跨站请求伪造</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/09/%E5%89%8D%E7%AB%AF%E4%B9%8BCSS/">前端之CSS</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/09/drf-%20CBV%E5%92%8CAPIView%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/">drf- CBV和APIView源码解读</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/09/django-cookie%20%E5%92%8Csession/">django-cookie 和session</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/09/mysql-%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/">mysql-存储引擎</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/09/django-%E6%89%B9%E9%87%8F%E6%8F%92%E5%85%A5/">django-批量插入</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/09/%E7%94%B1django%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%BC%95%E5%8F%91%E7%9A%84%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/">由django中间件引发的编程思想</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/05/bbs/">bbs</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/05/django-%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%AC%94%E8%AE%B0/">django-中间件笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/10/11/drf-%E8%B7%AF%E7%94%B1%E5%92%8C%E8%AE%A4%E8%AF%81/">drf路由的配置</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/rest-framework/" style="font-size: 15px;">rest_framework</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/">2020</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/">2019</a><span class="archive-list-count">6</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">网站地图</a> |  <a href="/atom.xml">订阅本站</a> |  <a href="/about/">联系博主</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次，本站总访客数:<i id="busuanzi_container_site_uv"><i id="busuanzi_value_site_uv"></i></i>人</p><p><span> Copyright &copy;<a href="/." rel="nofollow">Simple.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/" target="_blank" rel="noopener"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?c5fd96eee1193585be191f318c3fa725";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/js/search.json.js?v=2.0.5"></script><div id="fullscreen-img" class="hide"><span class="close"></span></div><script type="text/javascript" src="/js/imgview.js?v=2.0.5" async></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.5" async></script><link rel="stylesheet" type="text/css" href="/share/css/share.css"><script type="text/javascript" src="/share/js/social-share.js" charset="utf-8"></script><script type="text/javascript" src="/share/js/qrcode.js" charset="utf-8"></script></body></html>